[{"id":"1aa2f56a.dd644b","type":"tab","label":"Settings","disabled":false,"info":""},{"id":"a71e4e87.fb79f","type":"tab","label":"Authentication","disabled":false,"info":""},{"id":"b3ee9873.1f40b8","type":"tab","label":"Op Dashboards","disabled":false,"info":""},{"id":"545098a4.d6b9c8","type":"tab","label":"Tools","disabled":false,"info":""},{"id":"f5d31599.48fec8","type":"tab","label":"Work Orders","disabled":false,"info":""},{"id":"cdfadb10.9fa798","type":"tab","label":"Assets","disabled":false,"info":""},{"id":"c3bf0800.98e738","type":"tab","label":"Labour","disabled":false,"info":""},{"id":"5a0ae199.3bfe8","type":"tab","label":"Condition Monitoring","disabled":false,"info":""},{"id":"2f0041b8.31d9de","type":"tab","label":"Requests","disabled":false,"info":""},{"id":"7a10f34e.9ce88c","type":"tab","label":"Standing Data","disabled":false,"info":""},{"id":"37b50526.597f5a","type":"tab","label":"Inventory","disabled":false,"info":""},{"id":"d3f8f6e3.ac71b8","type":"tab","label":"Outbound","disabled":false,"info":""},{"id":"dd0cd6bf.e5fa08","type":"tab","label":"heartbeat","disabled":false,"info":""},{"id":"dbcb7aec.9529e8","type":"subflow","name":"Agility Request","info":"","category":"dashboards","in":[{"x":100,"y":80,"wires":[{"id":"d8db835b.84815"}]}],"out":[{"x":740,"y":80,"wires":[{"id":"4edf3bdd.2eb374","port":0}]}],"env":[],"color":"#009E74","icon":"font-awesome/fa-globe"},{"id":"cdb43684.b6bff8","type":"subflow","name":"Logger","info":"","category":"dashboards","in":[{"x":80,"y":200,"wires":[{"id":"a5b39667.c91848"}]}],"out":[],"env":[],"color":"#009E74","icon":"font-awesome/fa-upload"},{"id":"204cbc0b.a20a94","type":"subflow","name":"Agility Authentication","info":"","category":"dashboards","in":[{"x":60,"y":120,"wires":[{"id":"f7a9ab5c.86bbd8"}]}],"out":[{"x":960,"y":80,"wires":[{"id":"c7c4466d.82f2e8","port":0}]}],"env":[],"color":"#009E74","icon":"font-awesome/fa-unlock"},{"id":"4dc61eb5.a2d85","type":"subflow","name":"Response Processor","info":"","category":"dashboards","in":[{"x":60,"y":80,"wires":[{"id":"8f4bfafb.2b3998"}]}],"out":[{"x":1080,"y":80,"wires":[{"id":"4c02c3e9.062d3c","port":0},{"id":"fa12e2b3.ad37d","port":0}]}],"env":[],"color":"#009E74","icon":"node-red/link-out.svg"},{"id":"37e54e08.c90b62","type":"subflow","name":"GET Request Builder","info":"","category":"dashboards","in":[{"x":60,"y":80,"wires":[{"id":"7f8f4d40.ddfd14"}]}],"out":[{"x":600,"y":60,"wires":[]},{"x":600,"y":200,"wires":[{"id":"e45d1c10.fda34","port":0},{"id":"ce6592f.5ba4f7","port":0}]}],"env":[],"color":"#009E74","icon":"font-awesome/fa-plug"},{"id":"b5d3d683.745ae8","type":"subflow","name":"BO Primary Table Lookup","info":"","category":"dashboards","in":[{"x":80,"y":140,"wires":[{"id":"c9a5f46f.c57478"}]}],"out":[{"x":920,"y":160,"wires":[{"id":"c7826f91.2caab","port":0},{"id":"c9a5f46f.c57478","port":1}]}],"env":[],"color":"#009E74","icon":"font-awesome/fa-database"},{"id":"70065ec2.b9cf4","type":"subflow","name":"URL Decoder","info":"","category":"dashboards","in":[{"x":80,"y":120,"wires":[{"id":"b5f5748b.ab2c98"}]}],"out":[{"x":1200,"y":40,"wires":[{"id":"1f8adf47.59b521","port":0}]},{"x":1200,"y":200,"wires":[{"id":"d4417057.e3598","port":0}]}],"env":[],"color":"#009E74","icon":"font-awesome/fa-code"},{"id":"4bf41850.311378","type":"subflow","name":"Token Decoder","info":"","category":"dashboards","in":[{"x":60,"y":80,"wires":[{"id":"ff695bbb.5072b8"}]}],"out":[{"x":720,"y":60,"wires":[{"id":"484b43b6.83fe7c","port":0},{"id":"c669cebb.f658a","port":0}]},{"x":840,"y":180,"wires":[{"id":"c669cebb.f658a","port":1}]}],"env":[],"color":"#009E74","icon":"font-awesome/fa-user"},{"id":"711475f.e3e218c","type":"subflow","name":"Dataset BO Lookup","info":"","category":"dashboards","in":[{"x":80,"y":120,"wires":[{"id":"9494fcb7.bcf7b"}]}],"out":[{"x":1280,"y":40,"wires":[{"id":"60e79c7c.d888b4","port":0}]},{"x":1280,"y":120,"wires":[{"id":"50b494fa.364a8c","port":0},{"id":"c7b5dad4.6bb0d8","port":0}]}],"env":[],"color":"#009E74","icon":"font-awesome/fa-database"},{"id":"861618b8.e72488","type":"subflow","name":"Request Processor","info":"","category":"dashboards","in":[{"x":60,"y":80,"wires":[{"id":"264239e9.5ddca6"}]}],"out":[{"x":640,"y":60,"wires":[{"id":"f45731fa.af18d","port":0}]},{"x":580,"y":120,"wires":[{"id":"2f44b49f.f4f79c","port":1}]}],"env":[],"color":"#009E74","icon":"node-red/arrow-in.svg"},{"id":"9a3b7aa1.ce7868","type":"subflow","name":"Get Datasets","info":"","category":"dashboards","in":[{"x":120,"y":100,"wires":[{"id":"417349a8.1b7bc8"}]}],"out":[{"x":520,"y":160,"wires":[{"id":"cc106998.851b38","port":1}]},{"x":1280,"y":140,"wires":[{"id":"c54a1556.1eb258","port":0}]}],"env":[],"color":"#009E74","icon":"node-red/file-out.svg"},{"id":"8d62f5ef.75e948","type":"subflow","name":"Get settings","info":"","category":"connect","in":[{"x":80,"y":80,"wires":[{"id":"bf2d95a6.af5228"}]}],"out":[{"x":1060,"y":80,"wires":[{"id":"6a9033c2.9e4e2c","port":0}]}],"env":[],"color":"#9370DB","icon":"font-awesome/fa-cogs"},{"id":"c0f13f8b.9a1e1","type":"subflow","name":"Error Response","info":"Returns JSON object containing error message back to client with correct response code. Pass the error code in msg.payload. This subflow contains an HTTP Response node which must be used in conjunction with an HTTP in node.","category":"connect","in":[{"x":100,"y":60,"wires":[{"id":"965d2c97.7228c"}]}],"out":[],"env":[],"color":"#9370DB","icon":"node-red/alert.svg"},{"id":"ab15ef43.c5a4c","type":"subflow","name":"Request Handler","info":"Accepts the input from the HTTP in node, performs validation and authoirsation checks and outputs the request properties in msg.request.","category":"connect","in":[{"x":120,"y":80,"wires":[{"id":"9ee9eaa6.208128"}]}],"out":[{"x":1380,"y":360,"wires":[{"id":"f8c97cae.85901","port":0}]},{"x":1140,"y":80,"wires":[{"id":"b36a258a.3f8858","port":0}]}],"env":[],"color":"#9370DB","icon":"node-red/arrow-in.svg"},{"id":"37184d93.e34d32","type":"subflow","name":"BOG Get Request","info":"","category":"connect","in":[{"x":40,"y":80,"wires":[{"id":"81c2595.9e51ca8"}]}],"out":[{"x":780,"y":80,"wires":[{"id":"6f3e9ca2.ddf314","port":0}]}],"env":[],"color":"#9370DB","icon":"font-awesome/fa-question"},{"id":"1bef542e.d2fb4c","type":"subflow","name":"BOG Query String Builder","info":"","category":"connect","in":[{"x":100,"y":100,"wires":[{"id":"33e95d67.36c712"}]}],"out":[{"x":660,"y":80,"wires":[{"id":"ad71eef7.39dd2","port":0}]}],"env":[],"color":"#9370DB","icon":"font-awesome/fa-file-text"},{"id":"cbd3c5cd.d78358","type":"subflow","name":"Schema Request","info":"","category":"connect","in":[{"x":60,"y":120,"wires":[{"id":"456bd7f4.afc8d8"}]}],"out":[{"x":1680,"y":100,"wires":[{"id":"5dbc0d66.c53b04","port":0},{"id":"e7e08dee.0c04b","port":0}]}],"env":[],"color":"#9370DB","icon":"font-awesome/fa-database"},{"id":"57d6e8f2.02b798","type":"subflow","name":"Auth Handler","info":"","category":"connect","in":[{"x":80,"y":160,"wires":[{"id":"2d0a62a5.256efe"}]}],"out":[{"x":1500,"y":80,"wires":[{"id":"17a938b5.1ee7e7","port":0}]},{"x":260,"y":200,"wires":[{"id":"2d0a62a5.256efe","port":1}]}],"env":[],"color":"#9370DB","icon":"font-awesome/fa-unlock-alt"},{"id":"695c8489.c3dbec","type":"subflow","name":"Agility WS Request","info":"","category":"connect","in":[{"x":40,"y":140,"wires":[{"id":"fe2e67c.bee0598"}]}],"out":[{"x":920,"y":120,"wires":[{"id":"df8fb3d0.a7ff","port":0}]}],"env":[],"color":"#9370DB","icon":"node-red/white-globe.svg"},{"id":"9da11551.0b2828","type":"subflow","name":"Response Processor","info":"","category":"connect","in":[{"x":60,"y":180,"wires":[{"id":"ea136e70.567b9"}]}],"out":[],"env":[],"color":"#9370DB","icon":"node-red/arrow-in.svg"},{"id":"9a3099b0.93e2f8","type":"mongodb","hostname":"ssgmongo.uksouth.cloudapp.azure.com","topology":"direct","connectOptions":"","port":"27020","db":"connect","name":"SSG Mongo Connect"},{"id":"c937f6f8.0319f8","type":"mongodb","hostname":"ssgmongo.uksouth.cloudapp.azure.com","topology":"direct","connectOptions":"","port":"27020","db":"tenantmgmt","name":"SSGMongo Tenant Mgmt"},{"id":"4d3a2855.e2b0e8","type":"http in","z":"a71e4e87.fb79f","name":"","url":"/token/:method","method":"post","upload":false,"swaggerDoc":"","x":140,"y":140,"wires":[["f3d2ed32.b444b"]]},{"id":"97f76559.d19ef8","type":"function","z":"a71e4e87.fb79f","name":"","func":"var auth = \"Basic \" + msg.payload.auth\nvar username = msg.payload.user_name\nvar password = msg.payload.password\n\nmsg.url = \"https://ssgidentity.azurewebsites.net/connect/token\"\nmsg.method = \"POST\"\nmsg.headers = {\"content-type\":\"application/x-www-form-urlencoded\",\"authorization\":auth}\nmsg.payload = {}\nmsg.payload = {\n        \"grant_type\":\"password\",\n        \"username\": username,\n        \"password\": password,\n        \"scope\":\"offline_access ssg-agility-api\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":120,"wires":[["acf48ec3.f5bcb","b872d7b1.9e43c8"]]},{"id":"12732192.69908e","type":"http response","z":"a71e4e87.fb79f","name":"","statusCode":"","headers":{},"x":1350,"y":140,"wires":[]},{"id":"f1315bbe.bbdb68","type":"function","z":"a71e4e87.fb79f","name":"","func":"var auth = \"Basic \" + msg.payload.auth\nvar refreshtoken = msg.payload.refresh_token\n\nmsg.url = \"https://ssgidentity.azurewebsites.net/connect/token\"\nmsg.method = \"POST\"\nmsg.headers = {\"content-type\":\"application/x-www-form-urlencoded\",\"authorization\":auth}\nmsg.payload = {}\nmsg.payload = {\n        \"grant_type\":\"refresh_token\",\n        \"refresh_token\": refreshtoken,\n        \"scope\":\"offline_access ssg-agility-api\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":80,"wires":[["acf48ec3.f5bcb"]]},{"id":"acf48ec3.f5bcb","type":"http request","z":"a71e4e87.fb79f","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1190,"y":100,"wires":[["12732192.69908e"]]},{"id":"23c40e3a.eec832","type":"switch","z":"a71e4e87.fb79f","name":"","property":"payload","propertyType":"msg","rules":[{"t":"jsonata_exp","v":"$exists(msg.payload.refresh_token)\t","vt":"jsonata"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":875,"y":100,"wires":[["f1315bbe.bbdb68"],["97f76559.d19ef8"]],"l":false},{"id":"63e1c7c5.7b0688","type":"function","z":"a71e4e87.fb79f","name":"","func":"var token = msg.payload.access_token\nvar strlen = token.length\nvar pos1 = token.indexOf(\".\")\nvar pos2 = token.lastIndexOf(\".\")\nbase64 = token.substring(pos1 + 1,pos2)\nbase64 = base64.replace(/-/g, '+').replace(/_/g, '/');\nvar pad = base64.length % 4;\nif(pad) {\n  if(pad === 1) {\n    throw new Error('InvalidLengthError: Input base64url string is the wrong length to determine padding');\n  }\n  base64 += new Array(5 - pad).join('=');\n}\nmsg.payload.token = base64\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":180,"wires":[["a56dd8f1.d09198"]]},{"id":"123c42f0.7c38cd","type":"function","z":"a71e4e87.fb79f","name":"","func":"var base64 = msg.payload.token\nvar decoded = JSON.parse(base64)\nmsg.payload = {}\nmsg.payload = decoded\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":180,"wires":[["12732192.69908e"]]},{"id":"cfeb0b7c.9d8268","type":"function","z":"a71e4e87.fb79f","name":"","func":"var access_token = msg.payload.token\naccess_token = access_token.substring(access_token.indexOf(\" \"))\nmsg.payload.access_token = access_token\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":180,"wires":[["63e1c7c5.7b0688"]]},{"id":"f3d2ed32.b444b","type":"switch","z":"a71e4e87.fb79f","name":"","property":"req.params.method","propertyType":"msg","rules":[{"t":"eq","v":"request","vt":"str"},{"t":"eq","v":"decode","vt":"str"},{"t":"eq","v":"silent","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":275,"y":140,"wires":[["28014e69.eb5fc2"],["cfeb0b7c.9d8268"],["324988.08793678"]],"l":false},{"id":"d9d5c7f8.32a8e8","type":"comment","z":"1aa2f56a.dd644b","name":"Set client secret for ID Server ","info":"","x":180,"y":40,"wires":[]},{"id":"3ad83c1c.c4e434","type":"inject","z":"1aa2f56a.dd644b","name":"ID server Client ID","repeat":"","crontab":"","once":false,"onceDelay":"0.2","topic":"","payload":"{\"client_id\":\"ssg-agility-connect\",\"client_secret\":\"d7ed4856-c4b4-497b-92c4-3e1d0df94112\"}","payloadType":"json","x":170,"y":80,"wires":[["b6054b41.b58e98"]]},{"id":"87947e6d.4c4df","type":"base64","z":"a71e4e87.fb79f","name":"","action":"str","property":"payload.auth","x":760,"y":100,"wires":[["23c40e3a.eec832"]]},{"id":"a56dd8f1.d09198","type":"base64","z":"a71e4e87.fb79f","name":"","action":"b64","property":"payload.token","x":760,"y":180,"wires":[["123c42f0.7c38cd"]]},{"id":"b2d8d50f.38cc08","type":"comment","z":"1aa2f56a.dd644b","name":"Environment (used by logging)","info":"","x":180,"y":120,"wires":[]},{"id":"ea64d997.831558","type":"inject","z":"1aa2f56a.dd644b","name":"Set Environment (Prod or Dev)","repeat":"","crontab":"","once":true,"onceDelay":"0.75","topic":"","payload":"{\"Env\":\"Dev\"}","payloadType":"json","x":210,"y":160,"wires":[["ab68ebe7.fe2d48"]]},{"id":"ab68ebe7.fe2d48","type":"function","z":"1aa2f56a.dd644b","name":"Set value","func":"global.set(\"env\",msg.payload.Env)\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":160,"wires":[[]]},{"id":"d4f3610.89d20a","type":"http request","z":"dbcb7aec.9529e8","name":"","method":"use","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":470,"y":80,"wires":[["4edf3bdd.2eb374"]]},{"id":"783a2198.c6b24","type":"function","z":"dbcb7aec.9529e8","name":"","func":"var url = \"\"\nvar header = {}\nvar method = \"\"\nvar body = \"\"\n\nmsg.agilityrequest = {}\nif(msg.url !== undefined){\n    url = msg.url\n}\nif(msg.headers !== undefined){\n    header = msg.headers\n}\nif(msg.method !== undefined){\n    method = msg.method\n}\nbody = msg.payload\n\nmsg.agilityrequest = {\n    \"url\":url,\n    \"header\":header,\n    \"method\":method,\n    \"body\":body\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":80,"wires":[["d4f3610.89d20a"]]},{"id":"d8db835b.84815","type":"function","z":"dbcb7aec.9529e8","name":"","func":"msg.events.agilityrequest = new Date()\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":80,"wires":[["783a2198.c6b24"]]},{"id":"4edf3bdd.2eb374","type":"function","z":"dbcb7aec.9529e8","name":"","func":"msg.events.agilityresponse = new Date()\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":80,"wires":[[]]},{"id":"a5b39667.c91848","type":"function","z":"cdb43684.b6bff8","name":"","func":"//variables\nvar now = new Date()\nvar tenant = \"\"\nvar version = \"\"\nvar tenantID = \"\"\nvar method = \"\"\nvar tokenexpiry = 0\nvar auth = \"\"\nvar sub = \"\"\nvar endpoint = \"\"\nvar apimethod = \"\"\nvar urls = \"\"\nvar query_type = \"\"\nvar exportdef = \"\"\nvar responseurl = \"\"\nvar origreq = JSON.parse(msg.origreq)\nvar body = \"\"\nvar querystring = \"\"\n\nif(msg.header_data.orig_method !== undefined){\n    if(msg.header_data.orig_method == \"GET\"){\n        querystring = origreq\n    }\n    else if (msg.header_data.orig_method == \"POST\"){\n        body = origreq\n    }\n}\n\nif(msg.request.tenant !== undefined){\n    tenant = msg.request.tenant\n}\nif(msg.header_data.version !== undefined){\n    version = msg.header_data.version\n}\nif(msg.header_data.tenant_id !== undefined){\n    tenantID = msg.header_data.tenant_id\n}\nif(msg.header_data.orig_method !== undefined){\n    method = msg.header_data.orig_method\n}\nif(msg.header_data.tokenexpiry !== undefined){\n    tokenexpiry = msg.header_data.tokenexpiry\n    tokenexpiry = new Date(tokenexpiry * 1000)\n}\nif(msg.header_data.sub !== undefined){\n    sub = msg.header_data.sub\n}\nif(msg.header_data.auth !== undefined){\n    auth = msg.header_data.auth\n    if(auth.substr(0,6) != \"Bearer\"){\n        auth = \"Incorrect auth method\"\n    }\n    else {\n        auth = auth.substr(0,6) + \" [token removed]\"\n    }\n    \n}\nif(msg.request.req_method !== undefined){\n    apimethod = msg.request.req_method\n}\nif(msg.request.endpoint !== undefined){\n    endpoint = msg.request.endpoint\n}\nif(msg.request.urls !== undefined){\n    urls = msg.request.urls\n}\nif(msg.request.query_type !== undefined){\n    query_type = msg.request.query_type\n}\nif(msg.request.req_body.exportdef !== undefined){\n    exportdef = msg.request.req_body.exportdef\n}\nif(msg.responseUrl !== undefined){\n    responseurl = msg.responseUrl\n}\n\n\n// log msg\nmsg.log = {}\nmsg.log.timestamp = now\nmsg.log.env = global.get(\"env\")\nmsg.log.tenant = tenant\nmsg.log.clientrequest = {\n    \"method\":method,\n    \"endpoint\":endpoint,\n    \"apimethod\":apimethod,\n    \"header\":{\n        \"version\":version,\n        \"tenantID\":tenantID,\n        \"auth\":auth\n    },\n    \"body\":body,\n    \"querystring\":querystring\n}\nmsg.log.connectdata= {\n    \"tokenexpiry\":tokenexpiry,\n    \"sub\":sub,\n    \"urls\":urls,\n    \"querytype\":query_type,\n    \"exportdef\":exportdef\n}\n\nif(msg.agilityrequest !== undefined){\n    if(msg.agilityrequest.header.hasOwnProperty(\"authorization\")){\n        if(msg.agilityrequest.header.authorization.substr(0,5) == \"Basic\"){\n            msg.agilityrequest.header.authorization = \"Basic [token removed]\"\n        }\n        else if(msg.agilityrequest.header.authorization.substr(0,6) == \"Bearer\"){\n            msg.agilityrequest.header.authorization = \"Bearer [token removed]\"\n        }\n    }\n}\nif(msg.agilityrequest === undefined){\n        msg.log.agilityrequest = {\n        \"url\":\"\",\n        \"header\":\"\",\n        \"method\":\"\",\n        \"body\":\"\"\n    }\n}\nelse {msg.log.agilityrequest = msg.agilityrequest}\nmsg.log.response = {\n    \"statuscode\":msg.statusCode,\n    \"responseurl\":responseurl\n}\nmsg.log.events = msg.events\nmsg.log.errors = msg.errors\n\n\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":200,"wires":[["494ecf44.fadff"]]},{"id":"494ecf44.fadff","type":"switch","z":"cdb43684.b6bff8","name":"","property":"log.errors.error.code","propertyType":"msg","rules":[{"t":"eq","v":"processingFault","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":330,"y":200,"wires":[["a7bd7ce.037528"],["9913261d.6eaf58"]]},{"id":"a7bd7ce.037528","type":"function","z":"cdb43684.b6bff8","name":"Get Config ID","func":"msg.url = msg.log.connectdata.urls.BOurl + \"\\\\api\\\\Control_ImportExportControlerBO?select=syImpExpConfig.ImpExpConfigID,syImpExpConfig.LogEnabled&filter=syimpexpconfig.code='\" + msg.log.connectdata.exportdef + \"'\"\nmsg.method = \"GET\"\nmsg.headers = {}\nmsg.headers = {\"authorization\":global.get(\"auth\")}\nmsg.payload = { }\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":120,"wires":[["6f6e2859.46b468"]]},{"id":"6f6e2859.46b468","type":"http request","z":"cdb43684.b6bff8","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":635,"y":120,"wires":[["c1e0ffc8.34b07"]],"l":false},{"id":"1789e0e6.20d1df","type":"function","z":"cdb43684.b6bff8","name":"Get Error","func":"msg.url = msg.log.connectdata.urls.BOurl + \"\\\\api\\\\Control_ImportExportLoggerBO?select=syImpExpLog.ImpExpLogID,syImpExpLog.ErrorDesc&filter=syImpExpLog.ImpExpConfigID=\" + msg.payload[0].ImpExpConfigID + \" and syImpExpLog.completed=false order by syImpExpLog.createdate desc maxresults 1\"\nmsg.method = \"GET\"\nmsg.headers = {}\nmsg.headers = {\"authorization\":global.get(\"auth\")}\nmsg.payload = { }\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":80,"wires":[["3592469b.b5d25a"]]},{"id":"3592469b.b5d25a","type":"http request","z":"cdb43684.b6bff8","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":975,"y":80,"wires":[["56707344.aeefac"]],"l":false},{"id":"c1e0ffc8.34b07","type":"switch","z":"cdb43684.b6bff8","name":"","property":"payload[0].LogEnabled","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":120,"wires":[["1789e0e6.20d1df"],["56707344.aeefac"]]},{"id":"56707344.aeefac","type":"function","z":"cdb43684.b6bff8","name":"Add to log","func":"if(msg.payload.length > 0){\n    msg.log.errors.agilitylog = msg.payload\n}\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":240,"wires":[["e22e8181.28d59"]]},{"id":"9913261d.6eaf58","type":"function","z":"cdb43684.b6bff8","name":"","func":"msg.payload = {}\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":240,"wires":[["56707344.aeefac"]]},{"id":"bbb834e9.fa5408","type":"mongodb out","z":"cdb43684.b6bff8","mongodb":"9a3099b0.93e2f8","name":"Write Log","collection":"logs","payonly":true,"upsert":false,"multi":false,"operation":"store","x":1320,"y":240,"wires":[]},{"id":"e22e8181.28d59","type":"change","z":"cdb43684.b6bff8","name":"","rules":[{"t":"move","p":"log","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1215,"y":240,"wires":[["bbb834e9.fa5408"]],"l":false},{"id":"f7a9ab5c.86bbd8","type":"switch","z":"204cbc0b.a20a94","name":"","property":"auth","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":190,"y":120,"wires":[["ad942dde.34808"],["b4ccad42.e24e1"]]},{"id":"b4ccad42.e24e1","type":"change","z":"204cbc0b.a20a94","name":"","rules":[{"t":"set","p":"auth","pt":"msg","to":":","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":160,"wires":[["5cf5488b.fe93d8"]]},{"id":"ad942dde.34808","type":"function","z":"204cbc0b.a20a94","name":"","func":"var creds = msg.auth\nvar dcreds\n\ndcreds = creds.substring(creds.indexOf(\" \"))\nmsg.auth = dcreds\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":80,"wires":[["35d2875e.91b598"]]},{"id":"5cf5488b.fe93d8","type":"function","z":"204cbc0b.a20a94","name":"","func":"var auth = msg.auth\nvar user\nvar pass\n\nuser = auth.substring(0,auth.indexOf(\":\"))\npass = auth.substring(auth.indexOf(\":\") + 1,auth.length)\n//msg.payload.login = {\"LoginService\":{\"$\":{\"xmlns\":\"http://www.fastnetasp.com/GeneralImport\"},\"login\":user,\"password\":pass}}\nmsg.payload.LoginService = {\"$\":{\"xmlns\":\"http://www.fastnetasp.com/GeneralImport\"},\"login\":user,\"password\":pass}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":630,"y":80,"wires":[["c7c4466d.82f2e8"]]},{"id":"c7c4466d.82f2e8","type":"change","z":"204cbc0b.a20a94","name":"Add content-Type","rules":[{"t":"set","p":"headers.Content-Type","pt":"msg","to":"application/soap+xml","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":790,"y":80,"wires":[[]]},{"id":"35d2875e.91b598","type":"base64","z":"204cbc0b.a20a94","name":"","action":"b64","property":"auth","x":500,"y":80,"wires":[["5cf5488b.fe93d8"]]},{"id":"8f4bfafb.2b3998","type":"function","z":"4dc61eb5.a2d85","name":"","func":"var endpoint = msg.request.endpoint\n\nif(msg.errors.hasOwnProperty(\"error\")){\n    msg.payload = { }\n    msg.payload = msg.errors.error\n    //msg.statusCode = 200\n}\nelse \nif(msg.hasOwnProperty(\"statusCode\")){\n    if (msg.statusCode != 200){\n        msg.errors.error = { }\n        msg.errors.error.code = msg.statusCode\n        switch(msg.statusCode) {\n            case 401:\n                msg.errors.error.message = \"Not Authorised\"\n            break;\n        }\n    }\n}\n\n//if(msg.request.endpoint != \"/tenants\" && msg.request.endpoint != \"/businessobjects\" && msg.request.endpoint != \"/schema\" && msg.request.req_method != \"list\" && msg.request.endpoint != \"/readingpoints/assets\")\nif(typeof msg.payload == \"string\")\n    {\n    if(msg.payload.substring(0,2) == \"<?\"){\n        msg.type = \"xml\"\n    }\n    else {msg.type = \"json\"}\n}\nelse if(msg.payload == []){\n    msg.type = \"json\"\n}\nelse {msg.type = \"json\"}\n\n\n\nreturn msg;\n","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["d0679763.93b948"]]},{"id":"19932b46.fa83e5","type":"switch","z":"4dc61eb5.a2d85","name":"","property":"type","propertyType":"msg","rules":[{"t":"eq","v":"json","vt":"str"},{"t":"eq","v":"xml","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":355,"y":120,"wires":[["fa12e2b3.ad37d"],["684c1085.0a94a"]],"l":false},{"id":"3806435e.85accc","type":"xml","z":"4dc61eb5.a2d85","name":"","property":"payload","attr":"","chr":"","x":495,"y":140,"wires":[["9bc75575.0893f8"]],"l":false},{"id":"9bc75575.0893f8","type":"function","z":"4dc61eb5.a2d85","name":"","func":"\nif(msg.type == \"xml\"){\n   //msg.errors = { }\n   msg.errors.error = { }\n   var fault = msg.payload.Envelope.Body[0].Fault[0].Code[0].Value[0]\n   msg.fault = fault\n   switch(fault){\n        case \"ProcessingFault\":\n            msg.errors.error.code = \"processingFault\"\n            msg.errors.error.message = \"An internal error has occured\"\n            msg.statusCode = 500\n        break;\n        case \"LoginFault\":\n            msg.errors.error.code = \"loginFault\"\n            msg.errors.error.message = \"Connect user not authorised\"\n            msg.statusCode = 403\n        break;\n    }\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":555,"y":140,"wires":[["93a32770.482938"]],"l":false},{"id":"fa12e2b3.ad37d","type":"function","z":"4dc61eb5.a2d85","name":"Ok","func":"var results\nvar items\nvar endpoint = msg.request.endpoint\nvar i\n\nif(endpoint.indexOf(\"datasets\") != -1){\n    if(msg.request.query_type == \"query\" ){\n        results = { }\n        results = JSON.parse(msg.payload)\n        msg.payload = {}\n        if(msg.payload.results === null) {\n            msg.payload.totalitems = 0\n        }\n        else {msg.payload.totalitems = results.length}\n        msg.payload.results = results\n    }\n    if (msg.request.query_type == \"paged_dataset\" || msg.request.query_type == \"dataset\"){\n        results = { }\n        results = JSON.parse(msg.payload)\n        msg.payload = {}\n        data = JSON.parse(results.results)\n        delete results.results\n        msg.payload.totalitems = results.totalitems\n        if(msg.request.query_type == \"paged_dataset\"){\n            if (data !== null){\n                items = data.length\n            }\n            else {\n                items = 0\n            }\n            msg.payload.itemcount = items\n            msg.payload.page = results.page    \n        }\n        if(msg.request.req_body.hasOwnProperty(\"isPreview\")){\n            if(msg.request.req_body.isPreview === true){\n                msg.payload.totalqueryitems = results.totalqueryitems\n            }\n        }\n        msg.payload.results = data\n    }\n}\nelse if(endpoint == \"search\"){\n    results = JSON.parse(msg.payload)\n    msg.payload = {}\n    msg.payload.totalitems = results.totalitems\n    msg.payload.results = JSON.parse(results.results)\n}\nelse {\n    if(endpoint == \"summaries\" || endpoint == \"compare\"){\n        msg.payload = JSON.parse(msg.payload)\n        msg.payload.results = JSON.parse(msg.payload.results)\n    }\n    else if(endpoint == \"readingpoints\"){\n        msg.payload = JSON.parse(msg.payload)\n    }\n    else {msg.payload = msg.payload}\n}\n\n\nmsg.statusCode = 200\nmsg.events.responded = new Date()\n\n\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":100,"wires":[[]]},{"id":"d0679763.93b948","type":"switch","z":"4dc61eb5.a2d85","name":"","property":"errors","propertyType":"msg","rules":[{"t":"hask","v":"error","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":295,"y":80,"wires":[["4c02c3e9.062d3c"],["19932b46.fa83e5"]],"l":false},{"id":"684c1085.0a94a","type":"function","z":"4dc61eb5.a2d85","name":"","func":"var response = msg.payload\nresponse = response.replace(/s:/g, \"\").replace(/xml:lang=\"en-US\"/g,\"\").replace(/xmlna=\"http:\\/\\/www.fastnetasp.com\\/GeneralImport\"/g,\"\")\nresponse = response.replace(/a:/g, \"\")\nmsg.payload = response\nreturn msg;\n\n","outputs":1,"noerr":0,"x":435,"y":140,"wires":[["3806435e.85accc"]],"l":false},{"id":"4c02c3e9.062d3c","type":"function","z":"4dc61eb5.a2d85","name":"Error ","func":"msg.payload = {}\nmsg.payload = msg.errors\nmsg.events.responded = new Date()\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":60,"wires":[[]]},{"id":"93a32770.482938","type":"switch","z":"4dc61eb5.a2d85","name":"","property":"errors","propertyType":"msg","rules":[{"t":"hask","v":"error","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":655,"y":140,"wires":[["4c02c3e9.062d3c"],["fa12e2b3.ad37d"]],"l":false},{"id":"7f8f4d40.ddfd14","type":"function","z":"37e54e08.c90b62","name":"","func":"// input\n\nvar query_type\nvar dataset\nvar businessobject \nvar filterlines = []\nvar orderby\nvar maxrows = \"\"\nvar page\nvar itemcount\nvar urls\nvar auth\nvar maintable\nvar sub\nvar exportdef\nvar distinct\n\n\nif (msg.payload.hasOwnProperty(\"query_type\")){\n    query_type = msg.payload.query_type\n}\n\nif (msg.payload.hasOwnProperty(\"dataset\")) {\n    dataset = msg.payload.dataset\n}\n\nif(msg.payload.hasOwnProperty(\"businessobject\")){\n   businessobject = msg.payload.businessobject.replace(/[.]/g,\"_\")\n}\n\nif (msg.payload.hasOwnProperty(\"select\")){\n    columns = msg.payload.select\n}\n\nif (msg.payload.hasOwnProperty(\"filter\")){\n    filterlines = msg.payload.filter\n}\n\nif (msg.payload.hasOwnProperty(\"orderby\")){\n    orderby = msg.payload.orderby\n}\nelse {orderby = []}\n\nif(msg.payload.hasOwnProperty(\"isPreview\")){\n    if(msg.payload.isPreview === true){\n        maxrows = 2000\n    }\n}\nif (msg.payload.hasOwnProperty(\"maxrows\")){\n    maxrows = msg.payload.maxrows\n} \nelse {\n    if(!(msg.payload.hasOwnProperty(\"isPreview\"))){\n        maxrows = -1\n    }\n}\n\nif (msg.payload.hasOwnProperty(\"page\")){\n    page = msg.payload.page\n}\n\nif (msg.payload.hasOwnProperty(\"itemcount\")){\n    itemcount = msg.payload.itemcount\n}\n\nif (msg.payload.hasOwnProperty(\"urls\")){\n    baseurls = msg.payload.urls\n}\n\nif (msg.payload.hasOwnProperty(\"maintable\")){\n    maintable = msg.payload.maintable\n}\n\nif (msg.payload.hasOwnProperty(\"sub\")){\n    sub = msg.payload.sub\n}\n\nif (msg.payload.hasOwnProperty(\"exportdef\")){\n    exportdef = msg.payload.exportdef\n}\n\nif (msg.request.hasOwnProperty(\"authmethod\")){\n    if(msg.request.authmethod.toLowerCase() == \"basic\"){\n        auth = msg.request.basicauth\n    }\n    else {\n        auth = msg.header_data.auth\n    }\n}\n\nif (msg.payload.hasOwnProperty(\"distinct\")){\n    distinct = msg.payload.distinct\n}\n\n// This section included until BO Gateway Supports bearer token\n\n//if(auth.substring(0,6) == \"Bearer\"){\n//    auth = msg.request.basicauth\n//}\n\n// end of section\n\nvar select = \"\"\nvar filter = \"\"\nvar filterelement\nvar operator\nvar columnname\nvar r \nvar i \nvar in_array = [ ]\nvar order = \"\"\nvar offset\nvar columns\nvar url = \"\"\nvar headers\nvar user\nvar pass\n\nvar eventstartcolumn = \"\"\nvar eventstartoperator = \"\"\nvar eventstartvalue = \"\"\nvar eventendcolumn = \"\"\nvar eventendoperator = \"\"\nvar eventendvalue = \"\"\nvar startdate\nvar enddate\n\n\n// set tablenames for column names (dataset only)\nif (query_type == \"dataset\" || query_type == \"paged_dataset\") {\n        for(i = 0; i < columns.length; i++){\n            columns[i] = dataset + \".\" + columns[i]\n        }\n    }\n\n\n// build select object\n\nfor(i = 0; i < columns.length; i++){\n    select = select + \",\" + columns[i] \n}\nselect = select.substring(1)\n\n\n// build filter\nif(filterlines.length > 0){\n    for(i = 0; i < filterlines.length; i++){\n        filterelement = \"\"\n        // set operator\n        switch (filterlines[i].condition) {\n            case \"eq\":\n                operator = \"=\"\n                break;\n            case \"neq\":\n                operator = \"!=\"\n                break;\n            case \"gt\":\n                operator = \">\"\n                break;\n            case \"lt\":\n                operator = \"<\"\n                break;\n            case \"gte\":\n                operator = \">=\"\n                break;\n            case \"lte\":\n                operator = \"<=\"\n                break;\n            case \"like\":\n                operator = \"like\"\n                break;\n            case \"nlike\":\n                operator = \"not like\"\n                break;\n            case \"in\":\n                operator = \"in\"\n                break;\n            case \"nin\":\n                operator = \"not in\"\n            break;\n            case \"begins\":\n                operator = \"begins\"\n            break;\n            case \"ends\":\n                operator = \"ends\"\n            break;\n        }\n\n        // set tablename.columnname\n        if (query_type == \"dataset\" || query_type == \"paged_dataset\"){\n            columnname = dataset + \".\" + filterlines[i].column\n        }\n        else {columnname = filterlines[i].column}\n        \n        // set value datatype\n\n        datatype = typeof filterlines[i].value \n\n        // set value format\n        if (operator == \"like\" || operator == \"not like\"){\n            value = \"'%\" + filterlines[i].value + \"%'\"\n        }\n        else if (operator == \"begins\") {\n            value = \"'\" + filterlines[i].value + \"%'\"\n            operator = \"like\"\n        }\n        else if (operator == \"ends\") {\n            value = \"'%\" + filterlines[i].value + \"'\"\n            operator = \"like\"\n        }\n        else if (datatype == \"string\"){\n            value = \"'\" + filterlines[i].value + \"'\"\n        }\n        else {value = filterlines[i].value}\n\n\n        // Check if this is the event filter start\n        if(filterlines[i].hasOwnProperty(\"eventFilterStart\")){\n            if(filterlines[i].eventFilterStart === true){\n                eventstartcolumn = filterlines[i].column\n                eventstartoperator = operator\n                eventstartvalue = filterlines[i].value\n                \n            }\n        }\n        // Check if this is the event filer end\n        else if(filterlines[i].hasOwnProperty(\"eventFilterEnd\")){\n                if(filterlines[i].eventFilterEnd === true){\n                    eventendcolumn = filterlines[i].column\n                    eventendoperator = operator\n                    eventendvalue = filterlines[i].value\n                }\n        }\n        else {\n            // build filter element\n            if (operator == \"in\" || operator == \"not in\")\n                {\n                    in_array = filterlines[i].value\n                    for(r = 0; r < in_array.length; r++){\n                        if (operator == \"in\"){\n                        filterelement = filterelement + columnname + \" = \"  + \"'\" + in_array[r] + \"'\" + \" or \"\n                        }\n                        else {filterelement = filterelement + columnname + \" != \"  + \"'\" + in_array[r] + \"'\" + \" and \"}\n                    }\n                    if (filterelement.substring(filterelement.length - 5,filterelement.length) == \" and \"){\n                        filterelement = filterelement.substring(0,filterelement.length - 5)\n                    }\n                    else if (filterelement.substring(filterelement.length - 4,filterelement.length) == \" or \"){\n                        filterelement = filterelement.substring(0,filterelement.length - 4)\n                    }\n                    filterelement = \"(\" + filterelement + \") and \"\n                }\n            else {filterelement = filterelement + columnname + \" \" + operator + \" \" + value + \" and \"}\n\n            filter = filter + filterelement\n        }\n    }\n}\n\n// Add event date range to filter\nif(eventstartvalue !== \"\"){\n    if(eventendvalue === \"\"){\n        if(eventstartoperator == \"<=\"){\n            startdate = new Date(Date.now())\n            enddate = new Date(Date.now())\n            startdate.setHours(0,0,0,0)\n            startdate.setMonth(startdate.getMonth() - 6)\n            enddate.setHours(23,59,59,0)\n            eventstartoperator = \">=\"\n            eventstartvalue = JSON.parse(JSON.stringify(startdate))\n            eventendcolumn = eventstartcolumn\n            eventendoperator = \"<=\"\n            eventendvalue = JSON.parse(JSON.stringify(enddate))\n        }\n        else if(eventstartoperator == \"=\"){\n            startdate = new Date(eventstartvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n            startdate.setHours(0,0,0,0)\n            enddate = new Date(eventstartvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n            enddate.setHours(23,59,59,0)\n            eventstartoperator = \">=\"\n            eventstartvalue = JSON.parse(JSON.stringify(startdate))\n            eventendcolumn = eventstartcolumn\n            eventendoperator = \"<=\"\n            eventendvalue = JSON.parse(JSON.stringify(enddate))\n        }\n    }\n    else{\n        startdate = new Date(eventstartvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n        startdate.setHours(0,0,0,0)\n        enddate = new Date(eventendvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n        enddate.setHours(23,59,59,0)\n        eventstartvalue = JSON.parse(JSON.stringify(startdate))\n        eventendvalue = JSON.parse(JSON.stringify(enddate))\n    }\n    filter = filter + \"(\" + eventstartcolumn + \" \" + eventstartoperator + \" '\" + eventstartvalue + \"' and \" + eventendcolumn + \" \" + eventendoperator + \" '\" + eventendvalue + \"')\" + \" and \"\n}\n\n// trim last 'and' from filter\nif(filter.length > 0){\n    if (filter.substring(filter.length - 5,filter.length) == \" and \"){\n        filter = filter.substring(0,filter.length - 5)\n    }\n}\n\n// build order by string\nif (orderby.length > 0){\n    for(i = 0; i < orderby.length; i++){\n        if (query_type == \"dataset\" || query_type == \"paged_dataset\"){\n            order = order + \",\" + dataset + \".\" + orderby[i]\n        }\n        else {order = order + \",\" + orderby[i]} \n    }   \n    if (order.substring(0,1) == \",\"){\n        order = order.substring(1)\n    }\n    \n\n}\n\n// paging values string \nif (query_type == \"paged_dataset\"){\n    if (page > 0){\n        if (itemcount.length === 0){\n            itemcount = 50\n        }\n        if (page == 1){\n            offset = 0\n        }\n        else {\n            offset = (page - 1) * itemcount\n        }\n    }\n}\n\n// BO gateway\nif(query_type == \"query\" || query_type == \"search\"){\n    url = url + baseurls.BOurl + \"/api/\" + businessobject + \"?\" + \"select=\" + select + \"&filter=\"\n    if(filter.length > 0){\n        url = url + filter\n    }\n    if(order.length > 0){\n        url = url + \" order by \" + order\n    }\n    url = url + \" maxresults \" + maxrows\n    msg.url = url\n    msg.headers = {}\n    msg.headers = {\"authorization\":auth,\"Content-Type\":\"application/json\"}\n    msg.method = \"GET\"\n    msg.payload = { }\n}\n\n// Agility WS URL\n\nif (query_type == \"dataset\" || query_type == \"paged_dataset\"){\n    url = url + baseurls.Agilityurl + \"/services/generalimport.ashx/\" + exportdef\n    msg.url = url\n    user = msg.request.agilityuser\n    pass = msg.request.agilitypass\n    msg.method = \"POST\"\n    msg.headers = {}\n    msg.headers = {\"Content-Type\":\"application/soap+xml\"}\n    msg.payload = { }\n    msg.payload.Data = { }\n    msg.payload.Data.LoginService = {\"$\":{\"xmlns\":\"http://www.fastnetasp.com/GeneralImport\"},\"login\":user,\"password\":pass}\n    msg.payload.Data.select = select\n    msg.payload.Data.topN = maxrows\n    msg.payload.Data.tablename = dataset\n    msg.payload.Data.filter = filter\n    msg.payload.Data.orderby = order\n    msg.payload.Data.page = page\n    msg.payload.Data.offset = offset\n    msg.payload.Data.itemcount = itemcount\n    msg.payload.Data.maintable = maintable\n    msg.payload.Data.sub = sub\n    msg.payload.Data.distinct = distinct\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["e45d1c10.fda34"]]},{"id":"e45d1c10.fda34","type":"switch","z":"37e54e08.c90b62","name":"","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":330,"y":80,"wires":[[],["ce6592f.5ba4f7"]]},{"id":"ce6592f.5ba4f7","type":"xml","z":"37e54e08.c90b62","name":"","property":"payload","attr":"","chr":"","x":430,"y":180,"wires":[[]]},{"id":"31e27d8.470f382","type":"function","z":"b5d3d683.745ae8","name":"","func":"msg.payload = {\"DataClass\":msg.request.req_body.businessobject}\nmsg.projection = {\n            \"_id\":0,\n            \"MainTable\":1,\n            \"PrimaryKey\":1\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":370,"y":100,"wires":[["39e069fb.bea716"]]},{"id":"c7826f91.2caab","type":"function","z":"b5d3d683.745ae8","name":"","func":"msg.request.req_body.maintable = msg.payload[0].MainTable\nmsg.request.req_body.primarykey = msg.payload[0].PrimaryKey\nmsg.payload = { }\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":100,"wires":[[]]},{"id":"39e069fb.bea716","type":"mongodb in","z":"b5d3d683.745ae8","mongodb":"9a3099b0.93e2f8","name":"Get Business Objects","collection":"businessobjects","operation":"find","x":560,"y":100,"wires":[["c7826f91.2caab"]]},{"id":"c9a5f46f.c57478","type":"switch","z":"b5d3d683.745ae8","name":"","property":"request.req_method","propertyType":"msg","rules":[{"t":"neq","v":"list","vt":"str"},{"t":"eq","v":"list","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":190,"y":140,"wires":[["31e27d8.470f382"],[]]},{"id":"b5f5748b.ab2c98","type":"function","z":"70065ec2.b9cf4","name":"","func":"msg.payload = { }\nif(msg.header_data.hasOwnProperty(\"tenant_id\")){\n    msg.payload = {\"tenantID\":msg.header_data.tenant_id}\n}\nelse {\n    msg.errors.error = {}\n    msg.errors.error.code = \"Request error\"\n    msg.errors.error.message = \"No tenant ID in request header\"\n    msg.statusCode = 404\n}\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":120,"wires":[["3b91686d.7e5468"]]},{"id":"8727497d.0a35e8","type":"function","z":"70065ec2.b9cf4","name":"","func":"var urls = {}\nvar authstring\n\nurls.Agilityurl = msg.payload[0].agilityURL\nurls.BOurl = msg.payload[0].bogatewayURL\n\nmsg.request.urls = urls\nmsg.request.tenant = msg.payload[0].label\nmsg.request.authmethod = msg.payload[0].authMethod\nauthstring = msg.payload[0].basicauth\nmsg.payload = {}\nmsg.payload = authstring\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":200,"wires":[["a76598bd.90c718"]]},{"id":"3b91686d.7e5468","type":"switch","z":"70065ec2.b9cf4","name":"","property":"errors","propertyType":"msg","rules":[{"t":"hask","v":"error","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":350,"y":120,"wires":[["1f8adf47.59b521"],["28bda41a.2344cc"]]},{"id":"1f8adf47.59b521","type":"change","z":"70065ec2.b9cf4","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"errors.error","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":715,"y":40,"wires":[[]],"l":false},{"id":"28bda41a.2344cc","type":"mongodb in","z":"70065ec2.b9cf4","mongodb":"c937f6f8.0319f8","name":"Get Tenants","collection":"tenants","operation":"find","x":510,"y":180,"wires":[["59a446dd.cca7d8"]]},{"id":"59a446dd.cca7d8","type":"switch","z":"70065ec2.b9cf4","name":"","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":635,"y":180,"wires":[["7b6ae215.6b05ac"],["8727497d.0a35e8"]],"l":false},{"id":"7b6ae215.6b05ac","type":"function","z":"70065ec2.b9cf4","name":"","func":"msg.errors = {}\nmsg.errors.error = {}\nmsg.errors.error.code = \"403\"\nmsg.errors.error.message = \"TenantID not found\"\nreturn msg;","outputs":1,"noerr":0,"x":715,"y":160,"wires":[["1f8adf47.59b521"]],"icon":"node-red/alert.svg","l":false},{"id":"ff695bbb.5072b8","type":"function","z":"4bf41850.311378","name":"","func":"var base64\n\n\n\nif(msg.header_data.auth.length > 6 && msg.header_data.auth.substring(0,6) == \"Bearer\"){\n    var token = msg.header_data.auth.substring(msg.header_data.auth.indexOf(\" \"))\n    var strlen = token.length\n    var pos1 = token.indexOf(\".\")\n    var pos2 = token.lastIndexOf(\".\")\n    base64 = token.substring(pos1 + 1,pos2)\n    base64 = base64.replace(/-/g, '+').replace(/_/g, '/');\n    var pad = base64.length % 4;\n    if(pad) {\n      if(pad === 1) {\n        msg.errors.error = {}\n        msg.errors.error.code = \"Authentication Error\"\n        msg.errors.error.message = \"Input token string is the wrong length to determine padding\"\n        msg.statusCode = 400\n      }\n      base64 += new Array(5 - pad).join('=')\n    }\n}\nelse {\n    msg.errors.error = {}\n    msg.errors.error.code = \"Authentication Error\"\n    msg.errors.error.message = \"Authorisation method not supported or token not present\"\n    msg.statusCode = 400\n}\n\nmsg.header_data.base64 = base64\n\nreturn msg;","outputs":1,"noerr":0,"x":170,"y":80,"wires":[["74988cdc.1459d4"]]},{"id":"e635a2c4.867d","type":"function","z":"4bf41850.311378","name":"","func":"var base64 = msg.header_data.base64\nvar decoded = JSON.parse(base64)\nvar token_expiry = decoded.exp\n\nif(token_expiry < Math.round((new Date()).getTime() / 1000)){\n    msg.errors.error = {}\n    msg.errors.error.code = \"Authentication Error\"\n    msg.errors.error.message = \"Token has expired\"\n    msg.statusCode = 403\n}\n\nmsg.header_data.tokenexpiry = decoded.exp\nif(decoded.sub !== undefined){\n    msg.header_data.sub = decoded.sub\n}\n\ndelete msg.header_data.base64\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":160,"wires":[["c669cebb.f658a"]]},{"id":"74988cdc.1459d4","type":"switch","z":"4bf41850.311378","name":"","property":"errors","propertyType":"msg","rules":[{"t":"hask","v":"error","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":310,"y":80,"wires":[["484b43b6.83fe7c"],["d3fca1de.8ae4f"]]},{"id":"484b43b6.83fe7c","type":"change","z":"4bf41850.311378","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"errors.error","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":635,"y":60,"wires":[[]],"l":false},{"id":"d3fca1de.8ae4f","type":"base64","z":"4bf41850.311378","name":"","action":"b64","property":"header_data.base64","x":420,"y":160,"wires":[["e635a2c4.867d"]]},{"id":"c669cebb.f658a","type":"switch","z":"4bf41850.311378","name":"","property":"errors","propertyType":"msg","rules":[{"t":"hask","v":"error","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":160,"wires":[[],[]]},{"id":"126b6a10.e9b3b6","type":"function","z":"711475f.e3e218c","name":"","func":"msg.payload = null\nif(msg.request.req_body.hasOwnProperty(\"businessobject\")){\n    if(msg.request.req_body.businessobject == \"dataset\"){\n        msg.payload = {\"datasetName\":msg.request.req_method}\n    }\n}\nelse {\n    msg.errors.error = {}\n    msg.errors.error.code = \"Request error\"\n    msg.errors.error.message = \"No valid business object in request\"\n    msg.statusCode = 404\n}\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":100,"wires":[["4c906131.d8cea"]]},{"id":"4c906131.d8cea","type":"switch","z":"711475f.e3e218c","name":"","property":"errors","propertyType":"msg","rules":[{"t":"hask","v":"error","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":450,"y":100,"wires":[["60e79c7c.d888b4"],["50b494fa.364a8c"]]},{"id":"60e79c7c.d888b4","type":"change","z":"711475f.e3e218c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"errors.error","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1195,"y":40,"wires":[[]],"l":false},{"id":"50b494fa.364a8c","type":"switch","z":"711475f.e3e218c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":610,"y":120,"wires":[[],["67e5468.a095db8"]]},{"id":"fd18ab9a.9a5d98","type":"switch","z":"711475f.e3e218c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":2,"x":890,"y":200,"wires":[["c7b5dad4.6bb0d8"],["82915570.f5e158"]]},{"id":"c7b5dad4.6bb0d8","type":"function","z":"711475f.e3e218c","name":"","func":"\nmsg.request.req_body.businessobject = msg.payload[0].businessobject\nmsg.payload = {}\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":160,"wires":[[]]},{"id":"82915570.f5e158","type":"function","z":"711475f.e3e218c","name":"","func":"msg.errors.error = {}\nmsg.errors.error.code = \"Request error\"\nmsg.errors.error.message = \"Business object not found or TenantID invalid\"\nmsg.statusCode = 404\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":240,"wires":[["60e79c7c.d888b4"]]},{"id":"9494fcb7.bcf7b","type":"switch","z":"711475f.e3e218c","name":"","property":"request.req_body","propertyType":"msg","rules":[{"t":"hask","v":"businessobject","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":180,"y":120,"wires":[["126b6a10.e9b3b6"],["4694a340.13e19c"]]},{"id":"4694a340.13e19c","type":"function","z":"711475f.e3e218c","name":"","func":"if(msg.request.req_method != \"list\"){\n    msg.errors.error = {}\n    msg.errors.error.code = \"Request error\"\n    msg.errors.error.message = \"No valid business object in request\"\n    msg.statusCode = 404\n}\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":160,"wires":[["4c906131.d8cea"]]},{"id":"264239e9.5ddca6","type":"function","z":"861618b8.e72488","name":"","func":"var headers = msg.req.headers\nvar accept\nvar version\nvar endpoint = msg.req.url\n\nmsg.events = {}\nmsg.errors = {}\nmsg.request = {}\nmsg.request.req_body = {}\nmsg.header_data = {}\n\nmsg.events.received = new Date()\n\naccept = headers.accept.substring(headers.accept.indexOf(\"/\") + 1)\n\nif(accept.indexOf(\"vnd.ssginsight.com.v\") != -1) {\n    msg.header_data.version = accept.substring(accept.indexOf(\"vnd.ssginsight.com.v\") + 20,accept.indexOf(\"+\"))\n}\nelse {\n    msg.errors.error = {}\n    msg.errors.error.code = \"Version error\"\n    msg.errors.error.message = \"Requested version not supported\"\n    msg.statusCode = 406\n}\n\nif(Object.keys(msg.payload).length > 0){\n    msg.request.req_body = msg.payload\n}\nif(endpoint != \"/tenants\"){\n    if(msg.req.headers.hasOwnProperty(\"tenantid\")){\n        msg.header_data.tenant_id = msg.req.headers.tenantid\n    }\n    else {\n        msg.errors.error = {}\n        msg.errors.error.code = \"Authentication Error\"\n        msg.errors.error.message = \"No tenant ID present in request\"\n        msg.statusCode = 403\n    }\n}\n\nif(msg.req.params.hasOwnProperty(\"method\")){\n    msg.request.req_method = msg.req.params.method\n}\n\nif(msg.req.method == \"GET\"){\n    if(endpoint.indexOf(\"?\") != -1){\n       endpoint = endpoint.substring(0,endpoint.indexOf(\"?\"))  \n    }\n}\n\n\nmsg.request.endpoint = endpoint.substring(1).split(\"/\")[0]\n\nif(msg.req.headers.hasOwnProperty(\"authorization\")){\n       msg.header_data.auth = msg.req.headers.authorization \n    }\n    \nelse {\n        msg.errors.error = {}\n        msg.errors.error.code = \"Authentication Error\"\n        msg.errors.error.message = \"No authentication present in request\"\n        msg.statusCode = 403\n}\n\nmsg.header_data.orig_method = msg.req.method\nmsg.origreq = JSON.stringify(msg.request.req_body)\n\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["2f44b49f.f4f79c"]]},{"id":"2f44b49f.f4f79c","type":"switch","z":"861618b8.e72488","name":"","property":"errors","propertyType":"msg","rules":[{"t":"hask","v":"error","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":80,"wires":[["f45731fa.af18d"],[]]},{"id":"f45731fa.af18d","type":"change","z":"861618b8.e72488","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"errors.error","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":575,"y":60,"wires":[[]],"l":false},{"id":"97031c98.8ae57","type":"function","z":"b3ee9873.1f40b8","name":"","func":"var i\nvar dataclass\nvar businessobjects = [{}]\nvar tablelist\nvar tables = [ ]\nvar colunlist\nvar columns = [ ]\nvar response = { }\n\nif (msg.request.req_method == \"tables\")\n    {\n        tablelist = JSON.parse(msg.payload)\n        for(i = 0; i < tablelist.length; i++){\n           if(tables.indexOf(tablelist[i].uiFormElement_TableName) == -1)    \n            {tables.push(tablelist[i].uiFormElement_TableName)}\n        }\n        response = tables\n    }\n\nif (msg.request.req_method == \"columns\")\n    {\n        columnlist = JSON.parse(msg.payload)\n        for(i = 0; i < columnlist.length; i++){\n           if(columns.indexOf(columnlist[i].uiFormElement_FieldName) == -1)    \n            {columns.push(columnlist[i].uiFormElement_FieldName)}\n        }\n        response = columns\n    }\n\nmsg.payload = response\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":200,"wires":[["9aa0413c.0859"]]},{"id":"539dc862.400b48","type":"http in","z":"b3ee9873.1f40b8","name":"","url":"/businessobjects/:method","method":"get","upload":false,"swaggerDoc":"","x":190,"y":60,"wires":[["3fe54b3c.e71444"]]},{"id":"308087e9.0be208","type":"http response","z":"b3ee9873.1f40b8","name":"","statusCode":"","headers":{},"x":1270,"y":200,"wires":[]},{"id":"9d6dc9fd.440218","type":"http in","z":"b3ee9873.1f40b8","name":"","url":"/schema","method":"get","upload":false,"swaggerDoc":"","x":130,"y":220,"wires":[["997c1052.62a8d"]]},{"id":"af145606.438928","type":"join","z":"b3ee9873.1f40b8","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1135,"y":280,"wires":[["5d19fb3b.701cd4"]],"l":false},{"id":"7c0ace9d.6a861","type":"function","z":"b3ee9873.1f40b8","name":"","func":"var columns = msg.payload\nvar tablename = msg.tablename\nmsg.payload = {}\nmsg.payload.tablename = tablename\nmsg.payload.columns = JSON.parse(columns)\ndelete msg.auth\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":280,"wires":[["af145606.438928"]]},{"id":"caa52c33.ad154","type":"http response","z":"b3ee9873.1f40b8","name":"","statusCode":"","headers":{},"x":1310,"y":280,"wires":[]},{"id":"680f7bbd.d97564","type":"split","z":"b3ee9873.1f40b8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":515,"y":280,"wires":[["f9eb06b6.8815d8"]],"l":false},{"id":"f9eb06b6.8815d8","type":"change","z":"b3ee9873.1f40b8","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.tablename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":575,"y":280,"wires":[["a7b09133.4c10c"]],"l":false},{"id":"ed21e6f9.9e8488","type":"xml","z":"b3ee9873.1f40b8","name":"","property":"payload","attr":"","chr":"","x":755,"y":280,"wires":[["9f3e15ec.aeb0a8"]],"l":false},{"id":"f19c81ca.bb3b3","type":"function","z":"b3ee9873.1f40b8","name":"","func":"var method = msg.req.params.method\nvar url\nvar baseurl = msg.request.urls.BOurl\n\nif (method == \"tables\")\n    {url = baseurl + \"/api/FormDefBO?select=uiFormElement.TableName&filter=uiFormDef.DataClass = '\" + msg.request.req_body.businessobject + \"' and (uiFormDef.FormClass = 'ScanForm.aspx' or uiFormDef.FormClass = 'DetailForm.aspx') and uiFormElement.TableName is not null and uiFormelement.TableName != '' and uiFormElement.TableName != 'formparameter' order by uiFormElement.TableName maxresults -1\"}\nelse if (method == \"columns\")\n    {url = baseurl + \"/api/FormDefBO?select=uiFormElement.FieldName&filter=uiFormElement.TableName = '\" + msg.request.req_body.tablename + \"' and (uiFormDef.FormClass = 'ScanForm.aspx' or uiFormDef.FormClass = 'DetailForm.aspx') and (uiFormelement.TableName is not null and uiFormelement.TableName != '') and (uiFormelement.FieldName is not null and uiFormelement.FieldName != '') and uiFormelement.TableName != 'formparameter' and uiFormElement.Fieldname not like '%constrains%' order by uiFormElement.TableName,uiFormElement.FieldName maxresults -1\"}\n\nmsg.url = url\nmsg.method = \"GET\"\nif(msg.request.authmethod.toLowerCase() == \"basic\"){\n    msg.headers = {\"authorization\":msg.request.basicauth}\n}\nelse msg.headers = {\"authorization\":msg.header_data.auth}\n\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":200,"wires":[["4d6290de.06011"]]},{"id":"e4aad5f0.4ace68","type":"change","z":"b3ee9873.1f40b8","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.Tables","tot":"msg"},{"t":"set","p":"tablename","pt":"msg","to":"payload.Tables.tablename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":695,"y":280,"wires":[["ed21e6f9.9e8488"]],"l":false},{"id":"ab9cb57d.aa3b08","type":"function","z":"b3ee9873.1f40b8","name":"","func":"var auth = msg.request.basicauth\nvar tables\nif (msg.request.req_body.hasOwnProperty(\"dataset\")){\n    tables = msg.request.req_body.dataset\n}\nelse {tables = msg.request.req_body.tables}\n\ntables = tables.split(\",\")\nmsg.payload = tables\nmsg.auth = auth\nmsg.request.exportdef = \"Connect_ColumnLookup\"\nmsg.url = msg.request.urls.Agilityurl + \"/services/generalimport.ashx/\" + msg.request.exportdef\nmsg.method = \"POST\"\nreturn msg;","outputs":1,"noerr":0,"x":435,"y":280,"wires":[["680f7bbd.d97564"]],"l":false},{"id":"b37b89f8.e821f8","type":"http in","z":"b3ee9873.1f40b8","name":"","url":"/tenants","method":"get","upload":false,"swaggerDoc":"","x":130,"y":680,"wires":[["663a8457.ed4c1c"]]},{"id":"2bc95267.30fc1e","type":"function","z":"b3ee9873.1f40b8","name":"","func":"msg.payload = {\"$and\":[{\"sub\":msg.header_data.sub},{\"isDeleted\":false}]}\n\nmsg.projection = {\n            \"_id\":0,\n            \"tenantID\":1,\n            \"isDefault\":1,\n            \"isDeafult\":1\n}\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":720,"wires":[["44aa7d18.61da84"]]},{"id":"cbcda2a7.329d3","type":"switch","z":"b3ee9873.1f40b8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":770,"y":720,"wires":[["3fbe2b5f.dbfed4"],["1d24f7b6.fe3118"]]},{"id":"5bfe1f78.9940e","type":"http response","z":"b3ee9873.1f40b8","name":"","statusCode":"","headers":{},"x":1430,"y":700,"wires":[]},{"id":"3fbe2b5f.dbfed4","type":"function","z":"b3ee9873.1f40b8","name":"","func":"msg.errors = {}\nmsg.errors.error = {}\nmsg.errors.error.code = \"403\"\nmsg.errors.error.message = \"No Tenant ID found for user\"\nreturn msg;","outputs":1,"noerr":0,"x":875,"y":700,"wires":[["6199aeb2.86527"]],"icon":"node-red/alert.svg","l":false},{"id":"b10943aa.e1821","type":"http in","z":"b3ee9873.1f40b8","name":"","url":"/datasets/:method","method":"post","upload":false,"swaggerDoc":"","x":170,"y":360,"wires":[["a8e63c4c.f9415"]]},{"id":"a8e63c4c.f9415","type":"subflow:861618b8.e72488","z":"b3ee9873.1f40b8","name":"","env":[],"x":315,"y":360,"wires":[["f884d99e.389928"],["64e71d97.544d54"]],"l":false},{"id":"75dec3e.5de013c","type":"http response","z":"b3ee9873.1f40b8","name":"","statusCode":"","headers":{},"x":1210,"y":480,"wires":[]},{"id":"64e71d97.544d54","type":"subflow:711475f.e3e218c","z":"b3ee9873.1f40b8","name":"","env":[],"x":375,"y":380,"wires":[["454369ba.883b98"],["e3737d01.b0075"]],"l":false},{"id":"e3737d01.b0075","type":"subflow:4bf41850.311378","z":"b3ee9873.1f40b8","name":"","env":[],"x":435,"y":400,"wires":[["c52c8a4a.34fd78"],["f324f2e9.6e7e2"]],"l":false},{"id":"f324f2e9.6e7e2","type":"subflow:70065ec2.b9cf4","z":"b3ee9873.1f40b8","name":"","env":[],"x":495,"y":420,"wires":[["a4928633.063f38"],["4f76cabe.f323b4"]],"l":false},{"id":"4f76cabe.f323b4","type":"subflow:b5d3d683.745ae8","z":"b3ee9873.1f40b8","name":"","env":[],"x":555,"y":440,"wires":[["cf408688.28d458"]],"l":false},{"id":"fe793884.584498","type":"function","z":"b3ee9873.1f40b8","name":"","func":"\nmsg.payload = {}\n\n// Msg.payload.businessobject\n// Msg.payload.select\n// Msg.payload.filter\n// Msg.payload.orderby\n// Msg.payload.maxrows\n// Msg.payload.page\n// Msg.payload.itemcount\n// Msg.payload.maintable\n\nmsg.payload = msg.request.req_body\n\n//msg.payload.query_type\nif(msg.request.req_method != \"query\"){\n                \n    if(msg.request.req_body.hasOwnProperty(\"page\")){\n        msg.request.query_type = \"paged_dataset\"\n    }\n    else {\n        msg.request.query_type = \"dataset\"\n    }\n}\nelse {\n    msg.request.query_type = \"query\"\n}\n\nmsg.payload.query_type = msg.request.query_type\n\n// msg.payload.dataset\n\nif(msg.payload.query_type == \"dataset\" || msg.payload.query_type == \"paged_dataset\"){\n    msg.payload.dataset = msg.request.req_method\n}\n\n// Msg.payload.urls\n\nmsg.payload.urls = msg.request.urls\n\n// msg.payload.sub\n\nmsg.payload.sub = msg.header_data.sub\n\n// Msg.payload.exportdef\n\nmsg.payload.exportdef = \"Connect_DatasetData\"\n\n// Msg.payload.auth\n\nmsg.payload.auth = msg.header_data.auth\n\n// Msg.payload.distinct\n\nif(msg.request.endpoint == \"search\"){\n    msg.payload.distinct = \"true\"\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":480,"wires":[["e790bead.56979"]]},{"id":"e790bead.56979","type":"subflow:37e54e08.c90b62","z":"b3ee9873.1f40b8","name":"","env":[],"x":795,"y":480,"wires":[[],["d9d084cf.c6cce8"]],"l":false},{"id":"6b5aaee5.faed5","type":"subflow:4dc61eb5.a2d85","z":"b3ee9873.1f40b8","name":"","env":[],"x":1115,"y":480,"wires":[["75dec3e.5de013c","5c8d86bb.714d48"]],"l":false},{"id":"9ad3be2c.98fc7","type":"http in","z":"b3ee9873.1f40b8","name":"","url":"/search/:method","method":"get","upload":false,"swaggerDoc":"","x":160,"y":520,"wires":[["61105921.d151b8"]]},{"id":"61105921.d151b8","type":"subflow:861618b8.e72488","z":"b3ee9873.1f40b8","name":"","env":[],"x":315,"y":520,"wires":[["c6ea4a43.dc7a28"],["fae70103.76f4"]],"l":false},{"id":"a77b5e4.5de66a","type":"http response","z":"b3ee9873.1f40b8","name":"","statusCode":"","headers":{},"x":1110,"y":600,"wires":[]},{"id":"e76a2d18.347ea","type":"subflow:711475f.e3e218c","z":"b3ee9873.1f40b8","name":"","env":[],"x":435,"y":540,"wires":[["92fb0ac2.1cbd88"],["2f182384.dc836c"]],"l":false},{"id":"2f182384.dc836c","type":"subflow:4bf41850.311378","z":"b3ee9873.1f40b8","name":"","env":[],"x":495,"y":560,"wires":[["56bd0e06.020c4"],["aa947cc6.21985"]],"l":false},{"id":"aa947cc6.21985","type":"subflow:70065ec2.b9cf4","z":"b3ee9873.1f40b8","name":"","env":[],"x":555,"y":580,"wires":[["6121434b.6d2a2c"],["e35462cd.cdaa6"]],"l":false},{"id":"e35462cd.cdaa6","type":"subflow:b5d3d683.745ae8","z":"b3ee9873.1f40b8","name":"","env":[],"x":615,"y":600,"wires":[["10e7fb97.3d8d64"]],"l":false},{"id":"9e2cebb0.3b7608","type":"subflow:37e54e08.c90b62","z":"b3ee9873.1f40b8","name":"","env":[],"x":795,"y":600,"wires":[[],["3b27afe.91e785"]],"l":false},{"id":"3b27afe.91e785","type":"http request","z":"b3ee9873.1f40b8","name":"","method":"use","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":910,"y":620,"wires":[["78edabcb.6dfaf4"]]},{"id":"78edabcb.6dfaf4","type":"subflow:4dc61eb5.a2d85","z":"b3ee9873.1f40b8","name":"","env":[],"x":1015,"y":600,"wires":[["a77b5e4.5de66a"]],"l":false},{"id":"fae70103.76f4","type":"change","z":"b3ee9873.1f40b8","name":"","rules":[{"t":"set","p":"request.req_body.businessobject","pt":"msg","to":"dataset","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":375,"y":540,"wires":[["e76a2d18.347ea"]],"l":false},{"id":"10e7fb97.3d8d64","type":"function","z":"b3ee9873.1f40b8","name":"","func":"var operator\nvar phrase\nmsg.payload = {}\n\nif(msg.request.req_body.hasOwnProperty(\"operator\")){\n    operator = msg.request.req_body.operator\n}\nelse {\n    operator = \"like\"\n}\n\nmsg.payload.select = [msg.request.req_body.return]\nif(msg.request.req_body.hasOwnProperty(\"phrase\")){\nmsg.payload.filter = [{        \n          \"column\": msg.request.req_body.search,\n          \"value\": msg.request.req_body.phrase,\n          \"condition\": operator\n        }]\n}\n\nmsg.payload.businessobject = msg.request.req_body.businessobject\nmsg.payload.maintable = msg.request.req_body.maintable\n\nmsg.payload.query_type = \"dataset\"\nmsg.request.query_type = \"dataset\"\n\n// msg.payload.dataset\n\nif(msg.payload.query_type == \"dataset\" || msg.payload.query_type == \"paged_dataset\"){\n    msg.payload.dataset = msg.request.req_method\n}\n\n// Msg.payload.urls\n\nmsg.payload.urls = msg.request.urls\n\n// msg.payload.sub\n\nmsg.payload.sub = msg.header_data.sub\n\n// Msg.payload.exportdef\n\nmsg.payload.exportdef = \"Connect_Search\"\n\n// Msg.payload.auth\n\nmsg.payload.auth = msg.header_data.auth\n\n// Msg.payload.distinct\n\nif(msg.request.endpoint == \"search\"){\n    msg.payload.distinct = \"true\"\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":600,"wires":[["9e2cebb0.3b7608"]]},{"id":"663a8457.ed4c1c","type":"subflow:861618b8.e72488","z":"b3ee9873.1f40b8","name":"","env":[],"x":255,"y":680,"wires":[["1114ef9a.a7bf2"],["5f50c053.bbb9"]],"l":false},{"id":"5f50c053.bbb9","type":"subflow:4bf41850.311378","z":"b3ee9873.1f40b8","name":"","env":[],"x":315,"y":700,"wires":[["d3fd6e04.37edb"],["2bc95267.30fc1e"]],"l":false},{"id":"6199aeb2.86527","type":"subflow:4dc61eb5.a2d85","z":"b3ee9873.1f40b8","name":"","env":[],"x":1315,"y":700,"wires":[["5bfe1f78.9940e","f86c87e8.7b28b8"]],"l":false},{"id":"a7b09133.4c10c","type":"subflow:204cbc0b.a20a94","z":"b3ee9873.1f40b8","name":"","env":[],"x":635,"y":280,"wires":[["e4aad5f0.4ace68"]],"l":false},{"id":"1d24f7b6.fe3118","type":"function","z":"b3ee9873.1f40b8","name":"Set default","func":"msg.payload[0].isDefault = true\n\nvar tenantdata = []\nvar tenantlist = []\nvar i\n\n\ntenantdata = msg.payload\nmsg.payload = {}\nvar tenant = {}\n\n\nfor(i = 0; i < tenantdata.length; i++){\n    tenant = {\"tenantID\":tenantdata[i].tenantID}\n    tenantlist.push(tenant)\n}\n\n\nmsg.tenant_data = tenantdata\n\nmsg.payload = {\"$or\":tenantlist}\n\nmsg.projection = {  \n                \"_id\":0,\n                \"tenantID\":1,\n                \"tenant\":1,\n                \"agilityURL\":1,\n                \"bogatewayURL\":1,\n                \"label\":1\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":875,"y":740,"wires":[["8aead53a.6a40a8"]],"l":false},{"id":"c0ec1cf5.2f625","type":"link in","z":"b3ee9873.1f40b8","name":"Tenants - Response Processor","links":["d3fd6e04.37edb","1114ef9a.a7bf2","3b47b205.e8b65e","7ad5d393.a531cc"],"x":1245,"y":671,"wires":[["6199aeb2.86527"]]},{"id":"1114ef9a.a7bf2","type":"link out","z":"b3ee9873.1f40b8","name":"Tenants - Request Processor Error","links":["c0ec1cf5.2f625"],"x":315,"y":660,"wires":[]},{"id":"d3fd6e04.37edb","type":"link out","z":"b3ee9873.1f40b8","name":"Tenants - Token Decoder Error","links":["c0ec1cf5.2f625"],"x":375,"y":680,"wires":[]},{"id":"34c6e5ed.29437a","type":"link in","z":"b3ee9873.1f40b8","name":"Search Response Processor","links":["6121434b.6d2a2c","56bd0e06.020c4","c6ea4a43.dc7a28","92fb0ac2.1cbd88"],"x":955,"y":580,"wires":[["78edabcb.6dfaf4"]]},{"id":"c6ea4a43.dc7a28","type":"link out","z":"b3ee9873.1f40b8","name":"Search - Request Error","links":["34c6e5ed.29437a"],"x":375,"y":500,"wires":[]},{"id":"92fb0ac2.1cbd88","type":"link out","z":"b3ee9873.1f40b8","name":"Search - Dataset Lookup Error","links":["34c6e5ed.29437a"],"x":495,"y":520,"wires":[]},{"id":"56bd0e06.020c4","type":"link out","z":"b3ee9873.1f40b8","name":"Search - Token Decoder Error","links":["34c6e5ed.29437a"],"x":555,"y":540,"wires":[]},{"id":"6121434b.6d2a2c","type":"link out","z":"b3ee9873.1f40b8","name":"Search - URL decoder Error","links":["34c6e5ed.29437a"],"x":615,"y":560,"wires":[]},{"id":"f884d99e.389928","type":"link out","z":"b3ee9873.1f40b8","name":"Datasets - Request Error","links":["dd52f579.fc40d8"],"x":375,"y":340,"wires":[]},{"id":"454369ba.883b98","type":"link out","z":"b3ee9873.1f40b8","name":"Datasets - BO Lookup Error","links":["dd52f579.fc40d8"],"x":435,"y":360,"wires":[]},{"id":"a4928633.063f38","type":"link out","z":"b3ee9873.1f40b8","name":"Datasets - URL Decoder Error","links":["dd52f579.fc40d8"],"x":555,"y":400,"wires":[]},{"id":"c52c8a4a.34fd78","type":"link out","z":"b3ee9873.1f40b8","name":"Datasets - Token Decoder Error","links":["dd52f579.fc40d8"],"x":495,"y":380,"wires":[]},{"id":"dd52f579.fc40d8","type":"link in","z":"b3ee9873.1f40b8","name":"Datasets Response Processor","links":["a4928633.063f38","f884d99e.389928","c52c8a4a.34fd78","454369ba.883b98","7ca1fa2a.fb32f4"],"x":1055,"y":440,"wires":[["6b5aaee5.faed5"]]},{"id":"adc2ff6b.cb55a","type":"http in","z":"b3ee9873.1f40b8","name":"","url":"/summaries/:method","method":"post","upload":false,"swaggerDoc":"","x":170,"y":800,"wires":[["58177451.b674cc"]]},{"id":"58177451.b674cc","type":"subflow:861618b8.e72488","z":"b3ee9873.1f40b8","name":"","env":[],"x":315,"y":800,"wires":[["b14cb758.147788"],["bb2d249e.367d88"]],"l":false},{"id":"bb2d249e.367d88","type":"subflow:711475f.e3e218c","z":"b3ee9873.1f40b8","name":"","env":[],"x":375,"y":820,"wires":[["7e8a05f9.189fec"],["4c33095e.c61d38"]],"l":false},{"id":"4c33095e.c61d38","type":"subflow:4bf41850.311378","z":"b3ee9873.1f40b8","name":"","env":[],"x":435,"y":840,"wires":[["338d6738.fea828"],["8b95e00.455de2"]],"l":false},{"id":"8b95e00.455de2","type":"subflow:70065ec2.b9cf4","z":"b3ee9873.1f40b8","name":"","env":[],"x":495,"y":860,"wires":[["b1f35dfa.363fe"],["e1a8074a.633b48"]],"l":false},{"id":"e1a8074a.633b48","type":"subflow:b5d3d683.745ae8","z":"b3ee9873.1f40b8","name":"","env":[],"x":555,"y":880,"wires":[["e55c1a20.2524c8"]],"l":false},{"id":"27f3959e.9d839a","type":"http response","z":"b3ee9873.1f40b8","name":"","statusCode":"","headers":{},"x":1170,"y":880,"wires":[]},{"id":"cebf596.531cca8","type":"function","z":"b3ee9873.1f40b8","name":"","func":"// input\n\nvar query_type\nvar dataset\nvar businessobject \nvar filterlines = []\nvar orderby\nvar maxrows = \"\"\nvar page\nvar itemcount\nvar urls\nvar auth\nvar maintable\nvar primarykey\nvar sub\nvar exportdef\nvar distinct\nvar group = \"\"\nvar series = []\nvar granularity\nvar aggregation\nvar metric\nvar metriclabel\nvar columns = []\nvar displayitems = \"\"\nvar sort = \"\"\nvar startdate\nvar enddate\n\n\nif (msg.payload.hasOwnProperty(\"query_type\")){\n    query_type = msg.payload.query_type\n}\n\nif (msg.payload.hasOwnProperty(\"dataset\")) {\n    dataset = msg.payload.dataset\n}\n\nif(msg.payload.hasOwnProperty(\"businessobject\")){\n   businessobject = msg.payload.businessobject.replace(/[.]/g,\"_\")\n}\n\n\nif (msg.payload.hasOwnProperty(\"filter\")){\n    filterlines = msg.payload.filter\n}\n\nif (msg.payload.hasOwnProperty(\"group\")){\n    columns = msg.payload.group\n}\n\nif (msg.payload.hasOwnProperty(\"series\")){\n    series = msg.payload.series\n}\n\nif (msg.payload.hasOwnProperty(\"granularity\")){\n    granularity = msg.payload.granularity\n}\n\nif (msg.payload.hasOwnProperty(\"metric\")){\n    aggregation = msg.payload.metric[0].aggregation\n    metric = msg.payload.metric[0].column\n}\n\nmaxrows = -1\n\nif (msg.payload.hasOwnProperty(\"urls\")){\n    baseurls = msg.payload.urls\n}\n\nif (msg.payload.hasOwnProperty(\"maintable\")){\n    maintable = msg.payload.maintable\n}\n\nif (msg.payload.hasOwnProperty(\"primarykey\")){\n    primarykey = msg.payload.primarykey\n}\n\nif (msg.payload.hasOwnProperty(\"sub\")){\n    sub = msg.payload.sub\n}\n\nif (msg.payload.hasOwnProperty(\"exportdef\")){\n    exportdef = msg.payload.exportdef\n}\n\nif (msg.payload.hasOwnProperty(\"auth\")){\n    auth = msg.payload.auth\n}\n\n// Display items and display sort\n\nif (msg.payload.hasOwnProperty(\"options\")) {\n    if (msg.payload.options.hasOwnProperty(\"displayitems\") && msg.payload.options.hasOwnProperty(\"sort\")){\n        displayitems = msg.payload.options.displayitems\n        sort = msg.payload.options.sort\n    }\n    else if (!(msg.payload.options.hasOwnProperty(\"displayitems\")) && msg.payload.options.hasOwnProperty(\"sort\")) {\n        displayitems = \"10\"\n        sort = msg.payload.options.sort\n    }\n    else if (msg.payload.options.hasOwnProperty(\"displayitems\") && !(msg.payload.options.hasOwnProperty(\"sort\"))) {\n        displayitems = msg.payload.options.displayitems\n        sort = \"desc\"\n    }\n}\n\n\n// This section included until BO Gateway Supports bearer token\n\n//if(auth.substring(0,6) == \"Bearer\"){\n//    auth = msg.request.basicauth\n//}\n\n// end of section\n\n\nvar filter = \"\"\nvar filterelement\nvar operator\nvar columnname\nvar r \nvar i \nvar in_array = []\nvar order = \"\"\nvar offset\n//var columns = []\nvar url = \"\"\nvar headers\nvar user\nvar pass\n\nvar eventstartcolumn\nvar eventstartoperator\nvar eventstartvalue\nvar eventendcolumn = \"\"\nvar eventendoperator = \"\"\nvar eventendvalue = \"\"\n\n\n// set tablenames for column names (dataset only)\nif (query_type == \"dataset\" || query_type == \"paged_dataset\") {\n        for(i = 0; i < columns.length; i++){\n            columns[i] = dataset + \".\" + columns[i]\n        }\n    }\n\n\n// build select object\n\nfor(i = 0; i < columns.length; i++){\n    group = group + \",\" + columns[i] \n}\ngroup = group.substring(1)\n\n\n// build filter\nif(filterlines.length > 0){\n    for(i = 0; i < filterlines.length; i++){\n        filterelement = \"\"\n\n        // set operator\n        switch (filterlines[i].condition) {\n            case \"eq\":\n                operator = \"=\"\n                break;\n            case \"neq\":\n                operator = \"!=\"\n                break;\n            case \"gt\":\n                operator = \">\"\n                break;\n            case \"lt\":\n                operator = \"<\"\n                break;\n            case \"gte\":\n                operator = \">=\"\n                break;\n            case \"lte\":\n                operator = \"<=\"\n                break;\n            case \"like\":\n                operator = \"like\"\n                break;\n            case \"nlike\":\n                operator = \"not like\"\n                break;\n            case \"in\":\n                operator = \"in\"\n                break;\n            case \"nin\":\n                operator = \"not in\"\n            break;\n            case \"begins\":\n                operator = \"begins\"\n            break;\n            case \"ends\":\n                operator = \"ends\"\n            break;\n        }\n\n        // set tablename.columnname\n        if (query_type == \"dataset\" || query_type == \"paged_dataset\"){\n            columnname = dataset + \".\" + filterlines[i].column\n        }\n        else {columnname = filterlines[i].column}\n        \n        // set value datatype\n\n        datatype = typeof filterlines[i].value \n\n        // set value format\n        if (operator == \"like\" || operator == \"not like\"){\n            value = \"'%\" + filterlines[i].value + \"%'\"\n        }\n        else if (operator == \"begins\") {\n            value = \"'\" + filterlines[i].value + \"%'\"\n            operator = \"like\"\n        }\n        else if (operator == \"ends\") {\n            value = \"'%\" + filterlines[i].value + \"'\"\n            operator = \"like\"\n        }\n        else if (datatype == \"string\"){\n            value = \"'\" + filterlines[i].value + \"'\"\n        }\n        else {value = filterlines[i].value}\n        \n    // Check if this is the event filter start\n        if(filterlines[i].hasOwnProperty(\"eventFilterStart\")){\n            if(filterlines[i].eventFilterStart === true){\n                eventstartcolumn = filterlines[i].column\n                eventstartoperator = operator\n                eventstartvalue = filterlines[i].value\n                \n            }\n        }\n    // Check if this is the event filer end\n        else if(filterlines[i].hasOwnProperty(\"eventFilterEnd\")){\n            if(filterlines[i].eventFilterEnd === true){\n                eventendcolumn = filterlines[i].column\n                eventendoperator = operator\n                eventendvalue = filterlines[i].value\n            }\n        }\n        else {\n            // build filter element\n            if (operator == \"in\" || operator == \"not in\")\n                {\n                    in_array = filterlines[i].value\n                    for(r = 0; r < in_array.length; r++){\n                        if (operator == \"in\"){\n                        filterelement = filterelement + columnname + \" = \"  + \"'\" + in_array[r] + \"'\" + \" or \"\n                        }\n                        else {filterelement = filterelement + columnname + \" != \"  + \"'\" + in_array[r] + \"'\" + \" and \"}\n                    }\n                    if (filterelement.substring(filterelement.length - 5,filterelement.length) == \" and \"){\n                        filterelement = filterelement.substring(0,filterelement.length - 5)\n                    }\n                    else if (filterelement.substring(filterelement.length - 4,filterelement.length) == \" or \"){\n                        filterelement = filterelement.substring(0,filterelement.length - 4)\n                    }\n                    filterelement = \"(\" + filterelement + \") and \"\n                }\n            else {filterelement = filterelement + columnname + \" \" + operator + \" \" + value + \" and \"}\n    \n            filter = filter + filterelement\n        }\n    }\n}\n\n// trim last 'and' from filter\nif(filter.length > 0){\n    if (filter.substring(filter.length - 5,filter.length) == \" and \"){\n        filter = filter.substring(0,filter.length - 5)\n    }\n}\n\n// Set time part of event start and end dates\nif(eventendvalue === \"\"){\n    if(eventstartoperator == \"<=\"){\n        startdate = new Date(Date.now())\n        enddate = new Date(Date.now())\n        startdate.setHours(0,0,0,0)\n        startdate.setMonth(startdate.getMonth() - 6)\n        enddate.setHours(23,59,59,0)\n        eventstartoperator = \">=\"\n        eventstartvalue = JSON.parse(JSON.stringify(startdate))\n        eventendcolumn = eventstartcolumn\n        eventendoperator = \"<=\"\n        eventendvalue = JSON.parse(JSON.stringify(enddate))\n    }\n    else if(eventstartoperator == \"=\"){\n        startdate = new Date(eventstartvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n        startdate.setHours(0,0,0,0)\n        enddate = new Date(eventstartvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n        enddate.setHours(23,59,59,0)\n        eventstartoperator = \">=\"\n        eventstartvalue = JSON.parse(JSON.stringify(startdate))\n        eventendcolumn = eventstartcolumn\n        eventendoperator = \"<=\"\n        eventendvalue = JSON.parse(JSON.stringify(enddate))\n    }\n\n}\nelse {\n    startdate = new Date(eventstartvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n    startdate.setHours(0,0,0,0)\n    enddate = new Date(eventendvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n    enddate.setHours(23,59,59,0)\n    eventstartvalue = JSON.parse(JSON.stringify(startdate))\n    eventendvalue = JSON.parse(JSON.stringify(enddate))\n}\n\n\n// Metric Label\n\nif(metric == \"1\"){\n    metriclabel = \"Count \" \n}\nelse {\n    switch(aggregation.toLowerCase()){\n        case \"distinctcount\":\n            metriclabel = \"Distinct Count of \" + metric.replace(/[_]/g,\" \")\n            break;\n        case \"count\":\n            metriclabel = \"Count of \" + metric.replace(/[_]/g,\" \")\n            break;\n        case \"avg\":\n            metriclabel = \"Average of \" + metric.replace(/[_]/g,\" \")\n            break;\n        case \"sum\":\n            metriclabel = \"Sum of \" + metric.replace(/[_]/g,\" \")\n            break;\n        case \"min\":\n            metriclabel = \"Lowest value of \" + metric.replace(/[_]/g,\" \")\n            break;\n        case \"max\":\n            metriclabel = \"Highest value of \" + metric.replace(/[_]/g,\" \")\n    }\n}\n\n// Agility WS URL\n\nif (query_type == \"dataset\" || query_type == \"paged_dataset\"){\n    url = url + baseurls.Agilityurl + \"/services/generalimport.ashx/\" + exportdef\n    msg.url = url\n    user = msg.request.agilityuser\n    pass = msg.request.agilitypass\n    msg.method = \"POST\"\n    msg.headers = {}\n    msg.headers = {\"Content-Type\":\"application/soap+xml\"}\n    msg.payload = { }\n    msg.payload.Data = { }\n    msg.payload.Data.LoginService = {\"$\":{\"xmlns\":\"http://www.fastnetasp.com/GeneralImport\"},\"login\":user,\"password\":pass}\n    msg.payload.Data.tablename = dataset\n    msg.payload.Data.filter = filter\n    msg.payload.Data.maintable = maintable\n    msg.payload.Data.primarykey = primarykey\n    msg.payload.Data.sub = sub\n    msg.payload.Data.aggregation = aggregation\n    msg.payload.Data.group = group\n    msg.payload.Data.series = series\n    msg.payload.Data.metric = metric\n    msg.payload.Data.metriclabel = metriclabel\n    msg.payload.Data.granularity = granularity\n    msg.payload.Data.eventstartcolumn = eventstartcolumn\n    msg.payload.Data.eventstartoperator = eventstartoperator\n    msg.payload.Data.eventstartvalue = eventstartvalue\n    msg.payload.Data.eventendcolumn = eventendcolumn\n    msg.payload.Data.eventendoperator = eventendoperator\n    msg.payload.Data.eventendvalue = eventendvalue\n    msg.payload.Data.displayitems = displayitems\n    msg.payload.Data.sort = sort\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":880,"wires":[["ba5f5522.d3e1e8"]]},{"id":"ba5f5522.d3e1e8","type":"xml","z":"b3ee9873.1f40b8","name":"","property":"payload","attr":"","chr":"","x":890,"y":880,"wires":[["a64461f8.66c95"]]},{"id":"476c566.80067a8","type":"subflow:4dc61eb5.a2d85","z":"b3ee9873.1f40b8","name":"","env":[],"x":1075,"y":880,"wires":[["27f3959e.9d839a","aa112ab0.cae548"]],"l":false},{"id":"1ed89d42.c3cb83","type":"link in","z":"b3ee9873.1f40b8","name":"Summaries - Response Processor","links":["b14cb758.147788","7e8a05f9.189fec","338d6738.fea828","b1f35dfa.363fe"],"x":975,"y":840,"wires":[["476c566.80067a8"]]},{"id":"b14cb758.147788","type":"link out","z":"b3ee9873.1f40b8","name":"Summaries - Request Processor Error","links":["1ed89d42.c3cb83"],"x":375,"y":780,"wires":[]},{"id":"338d6738.fea828","type":"link out","z":"b3ee9873.1f40b8","name":"Summaries - Token Decoder Error","links":["1ed89d42.c3cb83"],"x":495,"y":820,"wires":[]},{"id":"7e8a05f9.189fec","type":"link out","z":"b3ee9873.1f40b8","name":"Summaries - BO Lookup Error","links":["1ed89d42.c3cb83"],"x":435,"y":800,"wires":[]},{"id":"b1f35dfa.363fe","type":"link out","z":"b3ee9873.1f40b8","name":"Summaries - URL Decoder Error","links":["1ed89d42.c3cb83"],"x":555,"y":840,"wires":[]},{"id":"44aa7d18.61da84","type":"mongodb in","z":"b3ee9873.1f40b8","mongodb":"c937f6f8.0319f8","name":"Get Instances","collection":"instances","operation":"find","x":580,"y":720,"wires":[["cbcda2a7.329d3"]]},{"id":"e55c1a20.2524c8","type":"function","z":"b3ee9873.1f40b8","name":"","func":"\n\n\nmsg.payload = {}\n\n// Msg.payload.businessobject\n// Msg.payload.select\n// Msg.payload.filter\n// Msg.payload.orderby\n// Msg.payload.maxrows\n// Msg.payload.page\n// Msg.payload.itemcount\n// Msg.payload.maintable\n\nif(!(msg.request.req_body.hasOwnProperty(\"metric\"))) {\n    msg.request.req_body.metric = []\n    msg.request.req_body.metric[0] = {}\n    msg.request.req_body.metric[0].column = \"1\"\n    msg.request.req_body.metric[0].aggregation = \"count\"\n}\n\nmsg.payload = msg.request.req_body\n\n//msg.payload.query_type\nif(msg.request.req_method != \"query\"){\n                \n    if(msg.request.req_body.hasOwnProperty(\"page\")){\n        msg.request.query_type = \"paged_dataset\"\n    }\n    else {\n        msg.request.query_type = \"dataset\"\n    }\n}\nelse {\n    msg.request.query_type = \"query\"\n}\n\nmsg.payload.query_type = msg.request.query_type\n\n// msg.payload.dataset\n\nif(msg.payload.query_type == \"dataset\" || msg.payload.query_type == \"paged_dataset\"){\n    msg.payload.dataset = msg.request.req_method\n}\n\n// Msg.payload.urls\n\nmsg.payload.urls = msg.request.urls\n\n// msg.payload.sub\n\nmsg.payload.sub = msg.header_data.sub\n\n// Msg.payload.exportdef\n\nif(msg.request.req_body.hasOwnProperty(\"series\")){\n    msg.payload.exportdef = \"Connect_PivotSummaries\"\n}\nelse {msg.payload.exportdef = \"Connect_GroupSummaries\"}\n\n\n// Msg.payload.auth\n\nmsg.payload.auth = msg.request.basicauth\n\n// Msg.payload.distinct\n\nif(msg.request.endpoint == \"search\"){\n    msg.payload.distinct = \"true\"\n}\n\n// Granularity format\n// Need to pass format of granularity \nif(msg.request.req_body.hasOwnProperty(\"granularity\")){\n    switch(msg.request.req_body.granularity) {\n        case \"days\":\n            msg.request.req_body.granularity = \"dateformatted\"\n            break;\n        case \"weeks\":\n            msg.request.req_body.granularity = \"weekformatted\"\n            break;\n        case \"months\":\n            msg.request.req_body.granularity = \"monthyear\"\n            break;\n    }\n}\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":880,"wires":[["cebf596.531cca8"]]},{"id":"3fe54b3c.e71444","type":"subflow:861618b8.e72488","z":"b3ee9873.1f40b8","name":"","env":[],"x":375,"y":100,"wires":[[],["2c5325d2.eb194a"]],"l":false},{"id":"fabdba40.0e4e58","type":"switch","z":"b3ee9873.1f40b8","name":"","property":"request.req_method","propertyType":"msg","rules":[{"t":"eq","v":"list","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":555,"y":160,"wires":[["70796f2a.76ec7"],["f19c81ca.bb3b3"]],"l":false},{"id":"2c5325d2.eb194a","type":"subflow:4bf41850.311378","z":"b3ee9873.1f40b8","name":"","env":[],"x":435,"y":120,"wires":[[],["2b221bfc.6ebc04"]],"l":false},{"id":"2b221bfc.6ebc04","type":"subflow:70065ec2.b9cf4","z":"b3ee9873.1f40b8","name":"","env":[],"x":495,"y":140,"wires":[[],["fabdba40.0e4e58"]],"l":false},{"id":"9aa0413c.0859","type":"subflow:4dc61eb5.a2d85","z":"b3ee9873.1f40b8","name":"","env":[],"x":1175,"y":200,"wires":[["308087e9.0be208","d5edf30f.4b00b"]],"l":false},{"id":"997c1052.62a8d","type":"subflow:861618b8.e72488","z":"b3ee9873.1f40b8","name":"","env":[],"x":245,"y":220,"wires":[["787a0e0d.8ae24"],["79ec54f4.e61c4c"]],"l":false},{"id":"79ec54f4.e61c4c","type":"subflow:4bf41850.311378","z":"b3ee9873.1f40b8","name":"","env":[],"x":315,"y":240,"wires":[["527f4912.ee5c38"],["b99354b2.4d2d28"]],"l":false},{"id":"b99354b2.4d2d28","type":"subflow:70065ec2.b9cf4","z":"b3ee9873.1f40b8","name":"","env":[],"x":375,"y":260,"wires":[["663b7a99.1615a4"],["ab9cb57d.aa3b08"]],"l":false},{"id":"5d19fb3b.701cd4","type":"subflow:4dc61eb5.a2d85","z":"b3ee9873.1f40b8","name":"","env":[],"x":1215,"y":280,"wires":[["caa52c33.ad154","bcf52523.2b9938"]],"l":false},{"id":"70796f2a.76ec7","type":"function","z":"b3ee9873.1f40b8","name":"","func":"var businessobject = msg.payload\nif(Object.keys(businessobject) > 0){\n    msg.payload = {\"DataClass\":businessobject}\n}\nelse {\n    msg.payload = {}\n}\nmsg.projection = {\n            \"_id\":0,\n            \"DataClass\":1,\n            \"MainTable\":1,\n            \"Entity\":1\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"x":670,"y":120,"wires":[["a1d32919.c58418"]]},{"id":"a1d32919.c58418","type":"mongodb in","z":"b3ee9873.1f40b8","mongodb":"9a3099b0.93e2f8","name":"","collection":"businessobjects","operation":"find","x":910,"y":120,"wires":[["9aa0413c.0859"]]},{"id":"303561c4.0e68ae","type":"http in","z":"b3ee9873.1f40b8","name":"","url":"/compare/:method","method":"post","upload":false,"swaggerDoc":"","x":170,"y":920,"wires":[["618841e1.7afb4"]]},{"id":"618841e1.7afb4","type":"subflow:861618b8.e72488","z":"b3ee9873.1f40b8","name":"","env":[],"x":315,"y":920,"wires":[["1edb6342.3099ad"],["f817b753.5d67a8"]],"l":false},{"id":"f817b753.5d67a8","type":"subflow:711475f.e3e218c","z":"b3ee9873.1f40b8","name":"","env":[],"x":375,"y":940,"wires":[["300c98e3.c70208"],["be48e24f.f0673"]],"l":false},{"id":"be48e24f.f0673","type":"subflow:4bf41850.311378","z":"b3ee9873.1f40b8","name":"","env":[],"x":435,"y":960,"wires":[["5fac5c5e.770874"],["2b448adb.0cb4f6"]],"l":false},{"id":"2b448adb.0cb4f6","type":"subflow:70065ec2.b9cf4","z":"b3ee9873.1f40b8","name":"","env":[],"x":495,"y":980,"wires":[["a5956594.c59878"],["7aa251df.e2453"]],"l":false},{"id":"7aa251df.e2453","type":"subflow:b5d3d683.745ae8","z":"b3ee9873.1f40b8","name":"","env":[],"x":555,"y":1000,"wires":[["b3852e4c.85ae8"]],"l":false},{"id":"2f718cfd.ff8c94","type":"http response","z":"b3ee9873.1f40b8","name":"","statusCode":"","headers":{},"x":1250,"y":1000,"wires":[]},{"id":"19503a99.ee4a75","type":"function","z":"b3ee9873.1f40b8","name":"","func":"// input\n\nvar query_type\nvar dataset\nvar businessobject \nvar filterlines = []\nvar orderby\nvar maxrows = \"\"\nvar page\nvar itemcount\nvar urls\nvar auth\nvar maintable\nvar primarykey\nvar sub\nvar exportdef\nvar distinct\nvar group = \"\"\nvar series = []\nvar granularity\nvar aggregation\nvar metric\nvar metriclabel = \"\"\nvar columns = []\n\n\nif (msg.payload.hasOwnProperty(\"query_type\")){\n    query_type = msg.payload.query_type\n}\n\nif (msg.payload.hasOwnProperty(\"dataset\")) {\n    dataset = msg.payload.dataset\n}\n\nif(msg.payload.hasOwnProperty(\"businessobject\")){\n   businessobject = msg.payload.businessobject.replace(/[.]/g,\"_\")\n}\n\n\nif (msg.payload.hasOwnProperty(\"filter\")){\n    filterlines = msg.payload.filter\n}\n\n//if (msg.payload.hasOwnProperty(\"group\")){\n//    columns = msg.payload.group\n//}\n\n//if (msg.payload.hasOwnProperty(\"series\")){\n//    series = msg.payload.series\n//}\n\n//if (msg.payload.hasOwnProperty(\"granularity\")){\n//    granularity = msg.payload.granularity\n//}\n\nif (msg.payload.hasOwnProperty(\"metric\")){\n    aggregation = msg.payload.metric[0].aggregation\n    metric = msg.payload.metric[0].column\n}\n\nmaxrows = -1\n\nif (msg.payload.hasOwnProperty(\"urls\")){\n    baseurls = msg.payload.urls\n}\n\nif (msg.payload.hasOwnProperty(\"maintable\")){\n    maintable = msg.payload.maintable\n}\n\nif (msg.payload.hasOwnProperty(\"primarykey\")){\n    primarykey = msg.payload.primarykey\n}\n\nif (msg.payload.hasOwnProperty(\"sub\")){\n    sub = msg.payload.sub\n}\n\nif (msg.payload.hasOwnProperty(\"exportdef\")){\n    exportdef = msg.payload.exportdef\n}\n\nif (msg.payload.hasOwnProperty(\"auth\")){\n    auth = msg.payload.auth\n}\n\n\n// This section included until BO Gateway Supports bearer token\n\n// if(auth.substring(0,6) == \"Bearer\"){\n//    auth = msg.request.basicauth\n// }\n\n// end of section\n\n\nvar filter = \"\"\nvar filterelement\nvar operator\nvar columnname\nvar r \nvar i \nvar in_array = [ ]\nvar order = \"\"\nvar offset\n//var columns = []\nvar url = \"\"\nvar headers\nvar user\nvar pass\n\nvar eventfiltercolumn\nvar eventfilteroperator\nvar eventfiltervalue\nvar eventendcolumn = \"\"\nvar eventendoperator = \"\"\nvar eventendvalue = \"\"\n\n// set tablenames for column names (dataset only)\nif (query_type == \"dataset\" || query_type == \"paged_dataset\") {\n        for(i = 0; i < columns.length; i++){\n            columns[i] = dataset + \".\" + columns[i]\n        }\n    }\n\n\n// build select object\n\nfor(i = 0; i < columns.length; i++){\n    group = group + \",\" + columns[i] \n}\ngroup = group.substring(1)\n\n\n// build filter\nif(filterlines.length > 0){\n    for(i = 0; i < filterlines.length; i++){\n        filterelement = \"\"\n\n        // set operator\n        switch (filterlines[i].condition) {\n            case \"eq\":\n                operator = \"=\"\n                break;\n            case \"neq\":\n                operator = \"!=\"\n                break;\n            case \"gt\":\n                operator = \">\"\n                break;\n            case \"lt\":\n                operator = \"<\"\n                break;\n            case \"gte\":\n                operator = \">=\"\n                break;\n            case \"lte\":\n                operator = \"<=\"\n                break;\n            case \"like\":\n                operator = \"like\"\n                break;\n            case \"nlike\":\n                operator = \"nlike\"\n                break;\n            case \"in\":\n                operator = \"in\"\n                break;\n            case \"nin\":\n                operator = \"not in\"\n            break;\n            case \"begins\":\n                operator = \"begins\"\n            break;\n            case \"ends\":\n                operator = \"ends\"\n            break;\n        }\n\n        // set tablename.columnname\n        if (query_type == \"dataset\" || query_type == \"paged_dataset\"){\n            columnname = dataset + \".\" + filterlines[i].column\n        }\n        else {columnname = filterlines[i].column}\n        \n        // set value datatype\n\n        datatype = typeof filterlines[i].value \n\n        // set value format\n        if (operator == \"like\" || operator == \"not like\"){\n            value = \"'%\" + filterlines[i].value + \"%'\"\n        }\n        else if (operator == \"begins\") {\n            value = \"'\" + filterlines[i].value + \"%'\"\n            operator = \"like\"\n        }\n        else if (operator == \"ends\") {\n            value = \"'%\" + filterlines[i].value + \"'\"\n            operator = \"like\"\n        }\n        else if (datatype == \"string\"){\n            value = \"'\" + filterlines[i].value + \"'\"\n        }\n        else {value = filterlines[i].value}\n        \n    // Check if this is the event filter start\n        if(filterlines[i].hasOwnProperty(\"eventFilterStart\")){\n            if(filterlines[i].eventFilterStart === true){\n                eventstartcolumn = filterlines[i].column\n                eventstartoperator = operator\n                eventstartvalue = filterlines[i].value\n                \n            }\n        }\n    // Check if this is the event filer end\n        else if(filterlines[i].hasOwnProperty(\"eventFilterEnd\")){\n            if(filterlines[i].eventFilterEnd === true){\n                eventendcolumn = filterlines[i].column\n                eventendoperator = operator\n                eventendvalue = filterlines[i].value\n            }\n        }\n        else {\n\n            // build filter element\n            if (operator == \"in\" || operator == \"not in\")\n                {\n                    in_array = filterlines[i].value\n                    for(r = 0; r < in_array.length; r++){\n                        if (operator == \"in\"){\n                        filterelement = filterelement + columnname + \" = \"  + \"'\" + in_array[r] + \"'\" + \" or \"\n                        }\n                        else {filterelement = filterelement + columnname + \" != \"  + \"'\" + in_array[r] + \"'\" + \" and \"}\n                    }\n                    if (filterelement.substring(filterelement.length - 5,filterelement.length) == \" and \"){\n                        filterelement = filterelement.substring(0,filterelement.length - 5)\n                    }\n                    else if (filterelement.substring(filterelement.length - 4,filterelement.length) == \" or \"){\n                        filterelement = filterelement.substring(0,filterelement.length - 4)\n                    }\n                    filterelement = \"(\" + filterelement + \") and \"\n                }\n            else {filterelement = filterelement + columnname + \" \" + operator + \" \" + value + \" and \"}\n    \n            filter = filter + filterelement\n        }\n    }\n}\n\n// trim last 'and' from filter\nif(filter.length > 0){\n    if (filter.substring(filter.length - 5,filter.length) == \" and \"){\n        filter = filter.substring(0,filter.length - 5)\n    }\n}\n\n// Set time part of event start and end dates\nif(eventendvalue === \"\"){\n    if(eventstartoperator == \"<=\"){\n        startdate = new Date(Date.now())\n        enddate = new Date(Date.now())\n        startdate.setHours(0,0,0,0)\n        startdate.setMonth(startdate.getMonth() - 6)\n        enddate.setHours(23,59,59,0)\n        eventstartoperator = \">=\"\n        eventstartvalue = JSON.parse(JSON.stringify(startdate))\n        eventendcolumn = eventstartcolumn\n        eventendoperator = \"<=\"\n        eventendvalue = JSON.parse(JSON.stringify(enddate))\n    }\n    else if(eventstartoperator == \"=\"){\n        startdate = new Date(eventstartvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n        startdate.setHours(0,0,0,0)\n        enddate = new Date(eventstartvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n        enddate.setHours(23,59,59,0)\n        eventstartoperator = \">=\"\n        eventstartvalue = JSON.parse(JSON.stringify(startdate))\n        eventendcolumn = eventstartcolumn\n        eventendoperator = \"<=\"\n        eventendvalue = JSON.parse(JSON.stringify(enddate))\n    }\n\n}\nelse {\n    startdate = new Date(eventstartvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n    startdate.setHours(0,0,0,0)\n    enddate = new Date(eventendvalue.replace(/-/g,\"/\").replace(\"T\",\" \").replace(\"Z\",\"\"))\n    enddate.setHours(23,59,59,0)\n    eventstartvalue = JSON.parse(JSON.stringify(startdate))\n    eventendvalue = JSON.parse(JSON.stringify(enddate))\n}\n\n\n// Metric Label\nif(msg.request.req_body.hasOwnProperty(\"metric\")){\n    if(metric == \"1\"){\n    metriclabel = \"Count \" \n    }\n    else {\n        switch(aggregation.toLowerCase()){\n            case \"distinctcount\":\n                metriclabel = \"Distinct Count of \" + metric.replace(/[_]/g,\" \")\n                break;\n            case \"count\":\n                metriclabel = \"Count of \" + metric.replace(/[_]/g,\" \")\n                break;\n            case \"avg\":\n                metriclabel = \"Average of \" + metric.replace(/[_]/g,\" \")\n                break;\n            case \"sum\":\n                metriclabel = \"Sum of \" + metric.replace(/[_]/g,\" \")\n                break;\n            case \"min\":\n                metriclabel = \"Lowest value of \" + metric.replace(/[_]/g,\" \")\n                break;\n            case \"max\":\n                metriclabel = \"Highest value of \" + metric.replace(/[_]/g,\" \")\n        }\n    }\n}\n\n// Agility WS URL\n\nif (query_type == \"dataset\" || query_type == \"paged_dataset\"){\n    url = url + baseurls.Agilityurl + \"/services/generalimport.ashx/\" + exportdef\n    msg.url = url\n    user = msg.request.agilityuser\n    pass = msg.request.agilitypass\n    msg.method = \"POST\"\n    msg.headers = {}\n    msg.headers = {\"Content-Type\":\"application/soap+xml\"}\n    msg.payload = { }\n    msg.payload.Data = { }\n    msg.payload.Data.LoginService = {\"$\":{\"xmlns\":\"http://www.fastnetasp.com/GeneralImport\"},\"login\":user,\"password\":pass}\n    msg.payload.Data.tablename = dataset\n    msg.payload.Data.filter = filter\n    msg.payload.Data.maintable = maintable\n    msg.payload.Data.primarykey = primarykey\n    msg.payload.Data.sub = sub\n    msg.payload.Data.aggregation = aggregation\n//    msg.payload.Data.group = group\n//    msg.payload.Data.series = series\n    msg.payload.Data.metric = metric\n    msg.payload.Data.metriclabel = metriclabel\n//    msg.payload.Data.granularity = granularity\n    msg.payload.Data.eventstartcolumn = eventstartcolumn\n    msg.payload.Data.eventstartoperator = eventstartoperator\n    msg.payload.Data.eventstartvalue = eventstartvalue\n    msg.payload.Data.eventendcolumn = eventendcolumn\n    msg.payload.Data.eventendoperator = eventendoperator\n    msg.payload.Data.eventendvalue = eventendvalue\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":1000,"wires":[["55fd04c8.63565c"]]},{"id":"55fd04c8.63565c","type":"xml","z":"b3ee9873.1f40b8","name":"","property":"payload","attr":"","chr":"","x":890,"y":1000,"wires":[["495cd204.eadccc"]]},{"id":"d1e0db3a.c9a568","type":"subflow:4dc61eb5.a2d85","z":"b3ee9873.1f40b8","name":"","env":[],"x":1155,"y":1000,"wires":[["2f718cfd.ff8c94","6247ba9.eb0ac44"]],"l":false},{"id":"6f9c5dd7.93e3c4","type":"link in","z":"b3ee9873.1f40b8","name":"Compare - Response Processor","links":["1edb6342.3099ad","300c98e3.c70208","5fac5c5e.770874","a5956594.c59878"],"x":1075,"y":960,"wires":[["d1e0db3a.c9a568"]]},{"id":"1edb6342.3099ad","type":"link out","z":"b3ee9873.1f40b8","name":"Compare - Request Processor Error","links":["6f9c5dd7.93e3c4"],"x":375,"y":900,"wires":[]},{"id":"5fac5c5e.770874","type":"link out","z":"b3ee9873.1f40b8","name":"Compare - Token Decoder Error","links":["6f9c5dd7.93e3c4"],"x":495,"y":940,"wires":[]},{"id":"300c98e3.c70208","type":"link out","z":"b3ee9873.1f40b8","name":"Compare - BO Lookup Error","links":["6f9c5dd7.93e3c4"],"x":435,"y":920,"wires":[]},{"id":"a5956594.c59878","type":"link out","z":"b3ee9873.1f40b8","name":"Compare - URL Decoder Error","links":["6f9c5dd7.93e3c4"],"x":555,"y":960,"wires":[]},{"id":"b3852e4c.85ae8","type":"function","z":"b3ee9873.1f40b8","name":"","func":"\nmsg.payload = {}\n\n// Msg.payload.businessobject\n// Msg.payload.select\n// Msg.payload.filter\n// Msg.payload.orderby\n// Msg.payload.maxrows\n// Msg.payload.page\n// Msg.payload.itemcount\n// Msg.payload.maintable\n\nif(!(msg.request.req_body.hasOwnProperty(\"metric\")) && msg.request.req_body.businessobject != \"DataBO.ProcessMngt.ReadingPointBO\") {\n    msg.request.req_body.metric = []\n    msg.request.req_body.metric[0] = {}\n    msg.request.req_body.metric[0].column = \"1\"\n    msg.request.req_body.metric[0].aggregation = \"count\"\n}\n\nmsg.payload = msg.request.req_body\n\n//msg.payload.query_type\nif(msg.request.req_method != \"query\"){\n                \n    if(msg.request.req_body.hasOwnProperty(\"page\")){\n        msg.request.query_type = \"paged_dataset\"\n    }\n    else {\n        msg.request.query_type = \"dataset\"\n    }\n}\nelse {\n    msg.request.query_type = \"query\"\n}\n\nmsg.payload.query_type = msg.request.query_type\n\n// msg.payload.dataset\n\nif(msg.payload.query_type == \"dataset\" || msg.payload.query_type == \"paged_dataset\"){\n    msg.payload.dataset = msg.request.req_method\n}\n\n// Msg.payload.urls\n\nmsg.payload.urls = msg.request.urls\n\n// msg.payload.sub\n\nmsg.payload.sub = msg.header_data.sub\n\n// Msg.payload.exportdef\n\nif(msg.request.req_body.businessobject == \"DataBO.ProcessMngt.ReadingPointBO\"){\n    if(!(msg.request.req_body.hasOwnProperty(\"metric\"))){\n        msg.payload.exportdef = \"Connect_RPComparison\"\n    }\n    else {\n    msg.payload.exportdef = \"Connect_Comparison\"\n    }\n}\nelse {\n    msg.payload.exportdef = \"Connect_Comparison\"\n}\n\n// Msg.payload.auth\n\nmsg.payload.auth = msg.request.basicauth\n\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":1000,"wires":[["19503a99.ee4a75"]]},{"id":"8aead53a.6a40a8","type":"mongodb in","z":"b3ee9873.1f40b8","mongodb":"c937f6f8.0319f8","name":"Get tenants","collection":"tenants","operation":"find","x":990,"y":740,"wires":[["7bbda5ec.75f66c"]]},{"id":"7bbda5ec.75f66c","type":"function","z":"b3ee9873.1f40b8","name":"","func":"var instancedata = msg.payload\nvar tenantdata = msg.tenant_data\nvar res = []\nvar i\n\nfor(i = 0; i < tenantdata.length; i++){\n    res[i] = instancedata[i]\n    res[i].isDefault = tenantdata[i].isDefault\n}\n\nmsg.payload = {}\n\nmsg.payload = res\n\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":740,"wires":[["6199aeb2.86527"]]},{"id":"cf408688.28d458","type":"switch","z":"b3ee9873.1f40b8","name":"","property":"request.req_method","propertyType":"msg","rules":[{"t":"eq","v":"list","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":615,"y":440,"wires":[["5d9df1d3.6373f"],["fe793884.584498"]],"l":false},{"id":"5d9df1d3.6373f","type":"function","z":"b3ee9873.1f40b8","name":"","func":"msg.collection = \"datasets\"\nmsg.payload = {\n    \"tenantID\":msg.header_data.tenant_id,\n    \"isDeleted\":false\n}\nmsg.projection = {\n        \"_id\":0,\n        \"datasetID\":1\n}\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":420,"wires":[["d0fa6268.494e7"]]},{"id":"417349a8.1b7bc8","type":"mongodb in","z":"9a3b7aa1.ce7868","mongodb":"9a3099b0.93e2f8","name":"SSGMongo Dev Connect","collection":"datasets","operation":"find","x":310,"y":100,"wires":[["cc106998.851b38"]]},{"id":"608e24f9.6097ac","type":"http in","z":"b3ee9873.1f40b8","name":"","url":"/readingpoints/:method","method":"get","upload":false,"swaggerDoc":"","x":180,"y":1060,"wires":[["2201b208.d79dbe"]]},{"id":"2201b208.d79dbe","type":"subflow:861618b8.e72488","z":"b3ee9873.1f40b8","name":"","env":[],"x":335,"y":1060,"wires":[["3f0115fb.4aa14a"],["1cf170bd.e09c9f"]],"l":false},{"id":"1cf170bd.e09c9f","type":"subflow:4bf41850.311378","z":"b3ee9873.1f40b8","name":"","env":[],"x":395,"y":1080,"wires":[["195ceb94.734874"],["4f24a75.003d158"]],"l":false},{"id":"4f24a75.003d158","type":"subflow:70065ec2.b9cf4","z":"b3ee9873.1f40b8","name":"","env":[],"x":455,"y":1100,"wires":[["c8e263dd.b63ad"],["2dde6150.6c080e"]],"l":false},{"id":"8ee09d2e.38772","type":"http response","z":"b3ee9873.1f40b8","name":"","statusCode":"","headers":{},"x":990,"y":1120,"wires":[]},{"id":"2dde6150.6c080e","type":"function","z":"b3ee9873.1f40b8","name":"Build Request","func":"var url = \"\"\nvar filter\nif(msg.request.req_method == \"assets\"){\n    msg.url = url + msg.request.urls.BOurl + \"\\\\api\\\\DataBO_ProcessMngt_AssetBO?select=AssetID,Code,Description,pmSite.SiteCode,pmLocation.LocationCode,pmSubLocation.SublocationCode&filter=pmReadingPoint.AssetID is not null distinct\"\n}\nelse if (msg.request.req_method == \"list\"){\n    if(msg.request.req_body.hasOwnProperty(\"AssetID\")){\n        \n        filter = \"pmReadingPoint.AssetID = \" + msg.request.req_body.AssetID\n    }\n    else {filter = \"\"}\n    msg.url = url + msg.request.urls.BOurl + \"\\\\api\\\\DataBO_ProcessMngt_ReadingPointBO?select=pmReadingPoint.ReadingPointID,pmReadingPoint.Description&Filter=\" + filter + \" order by pmReadingPoint.Description\"\n}\nmsg.method = \"GET\"\nmsg.headers = {}\nif(msg.request.authmethod.toLowerCase() == \"basic\"){\n    msg.headers = {\"authorization\":msg.request.basicauth,\"Content-Type\":\"application/json\"}\n}\nelse msg.headers = {\"authorization\":msg.header_data.auth,\"Content-Type\":\"application/json\"}\n\nmsg.payload = { }\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":580,"y":1120,"wires":[["546f4949.af35d8"]]},{"id":"ef9bc499.5b3708","type":"subflow:4dc61eb5.a2d85","z":"b3ee9873.1f40b8","name":"","env":[],"x":895,"y":1120,"wires":[["8ee09d2e.38772","fec360f7.3d7d1"]],"l":false},{"id":"3f0115fb.4aa14a","type":"link out","z":"b3ee9873.1f40b8","name":"Reading Points - Request Processor Error","links":["ddded818.e29298"],"x":395,"y":1040,"wires":[]},{"id":"195ceb94.734874","type":"link out","z":"b3ee9873.1f40b8","name":"Reading Points - Token Decoder Error","links":["ddded818.e29298"],"x":455,"y":1060,"wires":[]},{"id":"c8e263dd.b63ad","type":"link out","z":"b3ee9873.1f40b8","name":"Reading Points - URL Decoder Error","links":["ddded818.e29298"],"x":515,"y":1080,"wires":[]},{"id":"ddded818.e29298","type":"link in","z":"b3ee9873.1f40b8","name":"ReadingPoints - Response Processor","links":["3f0115fb.4aa14a","195ceb94.734874","c8e263dd.b63ad"],"x":815,"y":1080,"wires":[["ef9bc499.5b3708"]]},{"id":"a325476c.90c6b8","type":"link in","z":"b3ee9873.1f40b8","name":"Schema - Response Processor","links":["787a0e0d.8ae24","527f4912.ee5c38","663b7a99.1615a4"],"x":1175,"y":280,"wires":[["5d19fb3b.701cd4"]]},{"id":"787a0e0d.8ae24","type":"link out","z":"b3ee9873.1f40b8","name":"Schema - Request Processor","links":["a325476c.90c6b8"],"x":315,"y":200,"wires":[]},{"id":"527f4912.ee5c38","type":"link out","z":"b3ee9873.1f40b8","name":"Schema - Token Decoder","links":["a325476c.90c6b8"],"x":375,"y":220,"wires":[]},{"id":"663b7a99.1615a4","type":"link out","z":"b3ee9873.1f40b8","name":"Schema - URL decoder","links":["a325476c.90c6b8"],"x":435,"y":240,"wires":[]},{"id":"d83befd9.2750e","type":"link in","z":"b3ee9873.1f40b8","name":"","links":[],"x":1135,"y":140,"wires":[["9aa0413c.0859"]]},{"id":"d9d084cf.c6cce8","type":"change","z":"b3ee9873.1f40b8","name":"","rules":[{"t":"set","p":"agility","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"agility.body","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":855,"y":500,"wires":[["e2d8359.b83a8c8"]],"l":false},{"id":"5c8d86bb.714d48","type":"subflow:cdb43684.b6bff8","z":"b3ee9873.1f40b8","name":"","env":[],"x":1175,"y":440,"wires":[],"l":false},{"id":"fec360f7.3d7d1","type":"subflow:cdb43684.b6bff8","z":"b3ee9873.1f40b8","name":"","env":[],"x":955,"y":1080,"wires":[],"l":false},{"id":"e2d8359.b83a8c8","type":"subflow:dbcb7aec.9529e8","z":"b3ee9873.1f40b8","name":"","env":[],"x":915,"y":500,"wires":[["6b5aaee5.faed5"]],"l":false},{"id":"546f4949.af35d8","type":"subflow:dbcb7aec.9529e8","z":"b3ee9873.1f40b8","name":"","env":[],"x":695,"y":1120,"wires":[["ef9bc499.5b3708"]],"l":false},{"id":"a64461f8.66c95","type":"subflow:dbcb7aec.9529e8","z":"b3ee9873.1f40b8","name":"","env":[],"x":975,"y":880,"wires":[["476c566.80067a8"]],"l":false},{"id":"aa112ab0.cae548","type":"subflow:cdb43684.b6bff8","z":"b3ee9873.1f40b8","name":"","env":[],"x":1180,"y":840,"wires":[]},{"id":"f86c87e8.7b28b8","type":"subflow:cdb43684.b6bff8","z":"b3ee9873.1f40b8","name":"","env":[],"x":1440,"y":660,"wires":[]},{"id":"d5edf30f.4b00b","type":"subflow:cdb43684.b6bff8","z":"b3ee9873.1f40b8","name":"","env":[],"x":1280,"y":160,"wires":[]},{"id":"bcf52523.2b9938","type":"subflow:cdb43684.b6bff8","z":"b3ee9873.1f40b8","name":"","env":[],"x":1320,"y":240,"wires":[]},{"id":"9f3e15ec.aeb0a8","type":"subflow:dbcb7aec.9529e8","z":"b3ee9873.1f40b8","name":"","x":880,"y":280,"wires":[["7c0ace9d.6a861"]]},{"id":"4d6290de.06011","type":"subflow:dbcb7aec.9529e8","z":"b3ee9873.1f40b8","name":"","env":[],"x":820,"y":200,"wires":[["97031c98.8ae57"]]},{"id":"6247ba9.eb0ac44","type":"subflow:cdb43684.b6bff8","z":"b3ee9873.1f40b8","name":"","x":1260,"y":960,"wires":[]},{"id":"495cd204.eadccc","type":"subflow:dbcb7aec.9529e8","z":"b3ee9873.1f40b8","name":"","env":[],"x":1015,"y":1000,"wires":[["d1e0db3a.c9a568"]],"l":false},{"id":"cc106998.851b38","type":"switch","z":"9a3b7aa1.ce7868","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":2,"x":455,"y":100,"wires":[["6b0180c7.e7ba5"],[]],"l":false},{"id":"6b0180c7.e7ba5","type":"split","z":"9a3b7aa1.ce7868","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":550,"y":80,"wires":[["b7e805b1.2f3218"]]},{"id":"b7e805b1.2f3218","type":"function","z":"9a3b7aa1.ce7868","name":"","func":"var datasetID\nmsg.collection = \"datasetdef\"\ndatasetID = msg.payload.datasetID\nmsg.payload = {}\nmsg.payload = {\n    \"$and\":[{\"datasetID\":datasetID},{\"isDeleted\":false}]\n}\nmsg.projection = {\n    \"_id\":0,\n    \"datasetName\":1,\n    \"label\":1,\n    \"description\":1,\n    \"businessObject\":1,\n    \"type\":1\n}\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":140,"wires":[["267165bc.bb6e6a"]]},{"id":"267165bc.bb6e6a","type":"mongodb in","z":"9a3b7aa1.ce7868","mongodb":"9a3099b0.93e2f8","name":"","collection":"","operation":"find","x":910,"y":140,"wires":[["6003704e.cca3"]]},{"id":"c54a1556.1eb258","type":"join","z":"9a3b7aa1.ce7868","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1175,"y":140,"wires":[[]],"l":false},{"id":"6003704e.cca3","type":"change","z":"9a3b7aa1.ce7868","name":"","rules":[{"t":"move","p":"payload[0]","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1055,"y":140,"wires":[["21855c40.781ab4"]],"l":false},{"id":"21855c40.781ab4","type":"sort","z":"9a3b7aa1.ce7868","name":"","order":"descending","as_num":false,"target":"","targetType":"seq","msgKey":"","msgKeyType":"elem","seqKey":"payload.label","seqKeyType":"msg","x":1115,"y":140,"wires":[["c54a1556.1eb258"]],"l":false},{"id":"d0fa6268.494e7","type":"subflow:9a3b7aa1.ce7868","z":"b3ee9873.1f40b8","name":"","env":[],"x":850,"y":420,"wires":[["6b5aaee5.faed5"],["6b5aaee5.faed5"]]},{"id":"67e5468.a095db8","type":"mongodb in","z":"711475f.e3e218c","mongodb":"9a3099b0.93e2f8","name":"","collection":"datasetdef","operation":"find","x":630,"y":200,"wires":[["fd18ab9a.9a5d98"]]},{"id":"b6054b41.b58e98","type":"split","z":"1aa2f56a.dd644b","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":330,"y":80,"wires":[["8f24b3ad.7d157"]]},{"id":"8f24b3ad.7d157","type":"encrypt","z":"1aa2f56a.dd644b","name":"","algorithm":"TripleDES","key":"F0rtknox!","x":460,"y":80,"wires":[["222271d1.a1f3fe"]]},{"id":"222271d1.a1f3fe","type":"function","z":"1aa2f56a.dd644b","name":"","func":"var property = msg.topic\nvar data = msg.payload\n\nmsg.payload = {\n    \"property\":property,\n    \"value\":data\n}\nmsg.query = {\n    \"property\":property\n}\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":80,"wires":[["3e8b662c.47438a"]]},{"id":"bf2d95a6.af5228","type":"split","z":"8d62f5ef.75e948","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":190,"y":80,"wires":[["846f9752.e54bb8"]]},{"id":"300ab82e.641648","type":"mongodb in","z":"8d62f5ef.75e948","mongodb":"9a3099b0.93e2f8","name":"Get settings","collection":"","operation":"find","x":390,"y":80,"wires":[["556d6cc2.ef1af4"]]},{"id":"556d6cc2.ef1af4","type":"change","z":"8d62f5ef.75e948","name":"","rules":[{"t":"move","p":"payload[0]","pt":"msg","to":"data","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"data.value","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":495,"y":80,"wires":[["aa2d80e9.74c5c"]],"l":false},{"id":"3e8b662c.47438a","type":"mongodb out","z":"1aa2f56a.dd644b","d":true,"mongodb":"9a3099b0.93e2f8","name":"Update Settings","collection":"settings","payonly":false,"upsert":true,"multi":false,"operation":"update","x":800,"y":80,"wires":[]},{"id":"aa2d80e9.74c5c","type":"decrypt","z":"8d62f5ef.75e948","name":"","algorithm":"TripleDES","key":"F0rtknox!","x":600,"y":80,"wires":[["3cd7b6a6.24a2ca"]]},{"id":"3cd7b6a6.24a2ca","type":"change","z":"8d62f5ef.75e948","name":"","rules":[{"t":"set","p":"data.value","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"{ }","tot":"json"},{"t":"move","p":"data","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":780,"y":80,"wires":[["6a9033c2.9e4e2c"]]},{"id":"846f9752.e54bb8","type":"function","z":"8d62f5ef.75e948","name":"","func":"msg.collection = \"settings\"\nmsg.projection = {\n    \"_id\":0,\n    \"property\":1,\n    \"value\":1\n}\nreturn msg;","outputs":1,"noerr":0,"x":275,"y":80,"wires":[["300ab82e.641648"]],"l":false},{"id":"6a9033c2.9e4e2c","type":"join","z":"8d62f5ef.75e948","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":950,"y":80,"wires":[[]]},{"id":"50b654bd.44b92c","type":"subflow:8d62f5ef.75e948","z":"a71e4e87.fb79f","name":"","env":[],"x":470,"y":100,"wires":[["261d9766.e71fa8"]]},{"id":"28014e69.eb5fc2","type":"change","z":"a71e4e87.fb79f","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"request","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"[{\"property\":\"client_id\"},{\"property\":\"client_secret\"}]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":355,"y":100,"wires":[["50b654bd.44b92c"]],"l":false},{"id":"261d9766.e71fa8","type":"function","z":"a71e4e87.fb79f","name":"","func":"var auth = msg.payload[0].value  + \":\" + msg.payload[1].value\nmsg.payload = {}\nmsg.payload = msg.request\nmsg.payload.auth = auth\n\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":100,"wires":[["87947e6d.4c4df"]]},{"id":"a76598bd.90c718","type":"decrypt","z":"70065ec2.b9cf4","name":"","algorithm":"TripleDES","key":"F0rtknox!","x":835,"y":200,"wires":[["e3592ddf.e954a"]],"l":false},{"id":"e3592ddf.e954a","type":"function","z":"70065ec2.b9cf4","name":"","func":"var basicauth = msg.payload\nmsg.request.agilityuser = basicauth.substring(0,basicauth.indexOf(\":\"))\nmsg.request.agilitypass = basicauth.substring(basicauth.indexOf(\":\") + 1,basicauth.length)\n\nreturn msg;","outputs":1,"noerr":0,"x":895,"y":200,"wires":[["498c024a.299cbc"]],"l":false},{"id":"498c024a.299cbc","type":"base64","z":"70065ec2.b9cf4","name":"","action":"str","property":"payload","x":1000,"y":200,"wires":[["d4417057.e3598"]]},{"id":"d4417057.e3598","type":"function","z":"70065ec2.b9cf4","name":"","func":"msg.request.basicauth = \"Basic \" + msg.payload\nmsg.payload = {}\nreturn msg;","outputs":1,"noerr":0,"x":1115,"y":200,"wires":[[]],"l":false},{"id":"965d2c97.7228c","type":"function","z":"c0f13f8b.9a1e1","name":"","func":"var errorcode = msg.payload\nmsg.collection = \"errormsgs\"\nmsg.payload = {\n    \"errorcode\":errorcode\n}\nmsg.projection = {\n    \"_id\":0,\n    \"errorcode\":1,\n    \"errormessage\":1,\n    \"statusCode\":1\n}\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":60,"wires":[["4d75bc5e.a9f3a4"]]},{"id":"4d75bc5e.a9f3a4","type":"mongodb in","z":"c0f13f8b.9a1e1","mongodb":"9a3099b0.93e2f8","name":"","collection":"","operation":"find","x":400,"y":60,"wires":[["26972ffc.590e3"]]},{"id":"26972ffc.590e3","type":"function","z":"c0f13f8b.9a1e1","name":"","func":"delete msg.collection\n\nif(msg.payload.length < 1){\n    msg.payload = {}\n    msg.payload.errorcode = \"unknown\"\n    msg.payload.errormessage = \"unknown error\"\n    msg.statusCode = 500\n}\nelse {\n    msg.payload = msg.payload[0]\n    msg.statusCode = msg.payload.statusCode\n    delete msg.payload.statusCode\n}\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":60,"wires":[["7757b239.f2d10c"]]},{"id":"7757b239.f2d10c","type":"http response","z":"c0f13f8b.9a1e1","name":"","statusCode":"","headers":{},"x":770,"y":60,"wires":[]},{"id":"2dc9aa86.8483f6","type":"http in","z":"f5d31599.48fec8","name":"GET work orders","url":"/workorders/:method","method":"get","upload":false,"swaggerDoc":"","x":120,"y":200,"wires":[["20a22c1f.da79c4"]]},{"id":"37ea5a4a.7c9d46","type":"http in","z":"f5d31599.48fec8","name":"POST work orders","url":"/workorders/:method","method":"post","upload":false,"swaggerDoc":"","x":110,"y":280,"wires":[["20a22c1f.da79c4"]]},{"id":"d498279d.a31c68","type":"subflow:ab15ef43.c5a4c","z":"f5d31599.48fec8","name":"","env":[],"x":510,"y":240,"wires":[["2309d1e.b42142e"],["28220c68.c1f9e4"]]},{"id":"f1a01883.ffa028","type":"switch","z":"f5d31599.48fec8","name":"","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"schema","vt":"str"},{"t":"eq","v":"open","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1015,"y":100,"wires":[["5633eb45.9ea474"],["21d16aa4.611466"],["324a7d4f.238612"]],"outputLabels":["schema","","not supported"],"l":false},{"id":"324a7d4f.238612","type":"change","z":"f5d31599.48fec8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1115,"y":160,"wires":[["bea18efa.d874"]],"l":false},{"id":"bea18efa.d874","type":"subflow:c0f13f8b.9a1e1","z":"f5d31599.48fec8","name":"","env":[],"x":1155,"y":160,"wires":[],"l":false},{"id":"2309d1e.b42142e","type":"change","z":"f5d31599.48fec8","name":"Set Endpoint BO","rules":[{"t":"set","p":"request.businessobject","pt":"msg","to":"DataBO.ProcessMngt.JobBO","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":730,"y":220,"wires":[["1891c771.fb3769"]]},{"id":"456bd7f4.afc8d8","type":"switch","z":"cbd3c5cd.d78358","name":"","property":"request.query","propertyType":"msg","rules":[{"t":"hask","v":"tablename","vt":"str"},{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":190,"y":120,"wires":[["74016b6d.644bd4"],["311f33f6.6c438c"],["75a9aca7.b40394"]]},{"id":"9369f5a8.d1cff8","type":"function","z":"37184d93.e34d32","name":"BOG Request Builder","func":"//create variables\nmsg.request.requestbo // request business object\n\n//method - this is the method of the BO gateway request it may be different to the client request to connect\n//method will depend on apimethod \n//api methods - query,schema,add (for different types of add i.e. add from standing job, add from basic, this will be in the request body), update\nswitch (msg.request.apimethod) {\n            case \"schema\":\n                msg.method = \"GET\"\n                break;\n            case \"query\":\n                msg.method = \"GET\"\n                break;\n            case \"add\":\n                msg.method = \"POST\"\n                break;\n            case \"open\":\n                msg.method = \"GET\"\n                break;\n            case \"lookup\":\n                msg.method = \"GET\"\n                break;\n}\n//url\n// set request business object based upon api method\nif(msg.request.apimethod == \"schema\"){\n    msg.request.requestbo = \"FormDefBO\"\n}\nelse {\n    msg.request.requestbo = msg.request.businessobject\n}\n\nmsg.url = msg.request.bogatewayURL + \"/api/\" + msg.request.requestbo.replace(/[.]/g,\"_\") + \"?\"\n\n//header\nmsg.headers = {}\nif(msg.method == \"POST\"){\n    msg.headers[\"Content-Type\"] = \"application/json\"\n}\n\nif(msg.request.authmethod.toLowerCase() == \"basic\"){\n    msg.headers.Authorization = msg.request.basicauth\n}\nelse {\n    msg.headers.Authorization = msg.request.bearerauth\n}\n\n//payload\n//This section will append the query to the URL for GET requests\n\nif(msg.method == 'GET'){\n    if(msg.payload.hasOwnProperty(\"select\")){\n        msg.url = msg.url + \"select=\" + msg.payload.select\n    }\n    if(msg.payload.hasOwnProperty(\"filter\")){\n        msg.url = msg.url + \"&filter=\" + msg.payload.filter\n    }\n}\n\n//encode our uri\nmsg.url = encodeURI(msg.url);\n\n//if the method is post whatever in the request body will be posted\n\n\n//tidy up\n//delete requestbo\ndelete msg.request.requestbo\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":80,"wires":[["6f3e9ca2.ddf314"]]},{"id":"ad71eef7.39dd2","type":"function","z":"1bef542e.d2fb4c","name":"BOG Query String Builder","func":"// This is for buiding BOgateway GET method query strings from a GET or POST request\n// The request must be passed in either msg.request.body or msg.request.query\n\n// Clear payload - don't change\nmsg.payload = {}\n\n// create request query and request body objects even if they are empty objects\n\nif(msg.request.body === undefined){\n    msg.request.body = {}\n}\n\nif(msg.request.query === undefined){\n    msg.request.query = {}\n}\n\n// define variables - dont change\nmsg.request.select = \"\"\nmsg.request.filter = \"\"\nmsg.request.filterelement = {}\nmsg.request.filterelement.full = \"\"\nmsg.request.filterelement.operator = \"\"\nmsg.request.filterelement.datatype = \"\"\nmsg.request.filterelement.value = \"\"\nmsg.request.orderby = \"\"\nmsg.request.distinct = \"\"\nmsg.request.maxresults = \"\"\nmsg.request.req = {}\nmsg.payload.filter = \"\"\n\n\nvar i // for iterations\nvar r // for inner interations\n\n\n// Query string expression builder \nif(msg.req.method == \"GET\"){\n    if(Object.keys(msg.request.query).length === 0){\n        msg.request.req = msg.request.body\n    }\n    else{\n        msg.request.req = msg.request.query\n    }\n}\n\nif(msg.req.method == \"POST\"){\n    msg.request.req = msg.request.body\n}\n\n//select parameter\nif(msg.request.req.select !== undefined){\n    for(i = 0; i < msg.request.req.select.length; i++){\n        msg.request.select = msg.request.select + \",\" + msg.request.req.select[i]\n    }\n    msg.request.select = msg.request.select.substring(1)\n}\n//filter parameter\nif(msg.request.req.filter !== undefined){\n\n    for(i = 0; i < msg.request.req.filter.length; i++){\n        // clear out last filter element\n        msg.request.filterelement.full = \"\"\n        // set operator\n        switch (msg.request.req.filter[i].condition) {\n            case \"eq\":\n                msg.request.filterelement.operator = \"=\"\n                break;\n            case \"neq\":\n                msg.request.filterelement.operator = \"!=\"\n                break;\n            case \"gt\":\n                msg.request.filterelement.operator = \">\"\n                break;\n            case \"lt\":\n                msg.request.filterelement.operator = \"<\"\n                break;\n            case \"gte\":\n                msg.request.filterelement.operator = \">=\"\n                break;\n            case \"lte\":\n                msg.request.filterelement.operator = \"<=\"\n                break;\n            case \"like\":\n                msg.request.filterelement.operator = \"like\"\n                break;\n            case \"nlike\":\n                msg.request.filterelement.operator = \"not like\"\n                break;\n            case \"in\":\n                msg.request.filterelement.operator = \"in\"\n                break;\n            case \"nin\":\n                msg.request.filterelement.operator = \"not in\"\n                break;\n            case \"begins\":\n                msg.request.filterelement.operator = \"begins\"\n                break;\n            case \"ends\":\n                msg.request.filterelement.operator = \"ends\"\n                break;\n            case \"is\":\n                msg.request.filterelement.operator = \"is\"\n                break;\n            case \"not\":\n                msg.request.filterelement.operator = \"is not\"\n                break;\n        }\n    \n        // set value datatype\n        msg.request.filterelement.datatype = typeof msg.request.req.filter[i].value \n        \n        // handle null values\n\n        // set value string\n        if (msg.request.filterelement.operator == \"like\" || msg.request.filterelement.operator == \"not like\"){\n            msg.request.filterelement.value = \"'%\" + msg.request.req.filter[i].value + \"%'\"\n        }\n        else if (msg.request.filterelement.operator == \"begins\") {\n            msg.request.filterelement.value = \"'\" + msg.request.req.filter[i].value + \"%'\"\n            msg.request.filterelement.operator = \"like\"\n        }\n        else if (msg.request.filterelement.operator == \"ends\") {\n            msg.request.filterelement.value = \"'%\" + msg.request.req.filter[i].value + \"'\"\n            msg.request.filterelement.operator = \"like\"\n        }\n        else if (msg.request.filterelement.datatype == \"string\"){\n            msg.request.filterelement.value = \"'\" + msg.request.req.filter[i].value + \"'\"\n        }\n        else {msg.request.filterelement.value = msg.request.req.filter[i].value}\n\n        // build filter element\n        if (msg.request.filterelement.operator == \"in\" || msg.request.filterelement.operator == \"not in\")\n            {\n                msg.request.filterelement.in_array = msg.request.req.filter[i].value\n                for(r = 0; r <  msg.request.filterelement.in_array.length; r++){\n                    if (msg.request.filterelement.operator == \"in\"){\n                        msg.request.filterelement.full = msg.request.filterelement.full + msg.request.req.filter[i].column + \" = \"  + \"'\" + msg.request.filterelement.in_array[r] + \"'\" + \" or \"\n                    }\n                    else {msg.request.filterelement.full = msg.request.filterelement.full + msg.request.req.filter[i].column + \" != \"  + \"'\" + msg.request.filterelement.in_array[r] + \"'\" + \" and \"}\n                }\n                if (msg.request.filterelement.full.substring(msg.request.filterelement.full.length - 5,msg.request.filterelement.full.length) == \" and \"){\n                    msg.request.filterelement.full = msg.request.filterelement.full.substring(0,msg.request.filterelement.full.length - 5)\n                }\n                else if (msg.request.filterelement.full.substring(msg.request.filterelement.full.length - 4,msg.request.filterelement.full.length) == \" or \"){\n                    msg.request.filterelement.full = msg.request.filterelement.full.substring(0,msg.request.filterelement.full.length - 4)\n                }\n                msg.request.filterelement.full = \"(\" + msg.request.filterelement.full + \") and \"\n            }\n        else {msg.request.filterelement.full = msg.request.filterelement.full + msg.request.req.filter[i].column + \" \" + msg.request.filterelement.operator + \" \" + msg.request.filterelement.value + \" and \"}\n\n        msg.request.filter = msg.request.filter + msg.request.filterelement.full\n    }\n}\n\n\n// trim last and from filter\n\nif(msg.request.filter !== \"\"){\n    if(msg.request.filter.substring(msg.request.filter.length - 5, msg.request.filter.length) == \" and \"){\n        msg.request.filter = msg.request.filter.substring(0,msg.request.filter.length - 5)\n    }\n}\n\n// build order by\n\nif(msg.request.req.orderby !== undefined){\n    for(i = 0; i < msg.request.req.orderby.length; i++){\n        msg.request.orderby = msg.request.orderby + msg.request.req.orderby[i] + \",\"\n    }\n    //trim last comma\n    if(msg.request.orderby !== \"\"){\n        if(msg.request.orderby.substring(msg.request.orderby.length -1) == \",\"){\n            msg.request.orderby = msg.request.orderby.substring(0,msg.request.orderby.length - 1)\n        }\n        \n    }\n}\n\n// distinct \n\nif(msg.request.req.distinct !== undefined){\n    if(msg.request.req.distinct === true){\n        msg.request.distinct = \"true\"\n    }\n}\n\n// maxresults\nif(msg.req.headers.origin == \"https://agilityapidocumentation.azurewebsites.net\" || msg.req.headers.origin == \"http://localhost:3000\"){\n    msg.request.maxresults = 100\n}\nelse {\n    if(msg.request.req.maxrows !== undefined){\n        msg.request.maxresults = msg.request.req.maxrows\n    }\n    else{msg.request.maxresults = -1}\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":80,"wires":[[]]},{"id":"6f3e9ca2.ddf314","type":"http request","z":"37184d93.e34d32","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":630,"y":80,"wires":[[]]},{"id":"81c2595.9e51ca8","type":"function","z":"37184d93.e34d32","name":"Create payload","func":"// build payload\n\nif(msg.request.select !== \"\"){\n    msg.payload.select = msg.request.select.trim()\n}\nif(msg.request.filter !== \"\"){\n    msg.payload.filter = msg.request.filter.trim()\n}\nif(msg.request.orderby !== \"\"){\n    msg.payload.filter = msg.payload.filter + \" order by \" + msg.request.orderby.trim()\n}\nif(msg.request.distinct !== \"\"){\n    msg.payload.filter = msg.payload.filter + \" distinct\"\n}\nif(msg.request.maxresults !== \"\"){\n    msg.payload.filter = msg.payload.filter + \" maxresults \" + msg.request.maxresults\n}\n\n// tidy up\ndelete msg.request.select\ndelete msg.request.filter\ndelete msg.request.filterelement\ndelete msg.request.orderby\ndelete msg.request.distinct\ndelete msg.request.maxresults\ndelete msg.request.req\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["9369f5a8.d1cff8"]]},{"id":"ca71095a.dc96e8","type":"split","z":"cbd3c5cd.d78358","name":"","splt":"/n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":550,"y":80,"wires":[["41c8b200.2f512"]]},{"id":"74016b6d.644bd4","type":"function","z":"cbd3c5cd.d78358","name":"Split Table Array","func":"msg.payload = msg.request.query.tablename.split(\",\")\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":80,"wires":[["ca71095a.dc96e8"]]},{"id":"41c8b200.2f512","type":"function","z":"cbd3c5cd.d78358","name":"","func":"msg.request.tablename = msg.payload\nmsg.payload = { }\nmsg.request.base64 = msg.request.basicauth.substr(6,msg.request.basicauth.length)\nmsg.request.exportdef = \"Connect_ColumnLookup\"\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":80,"wires":[["e08c8ef6.0f232"]]},{"id":"e08c8ef6.0f232","type":"base64","z":"cbd3c5cd.d78358","name":"","action":"b64","property":"request.base64","x":840,"y":80,"wires":[["7422b69e.c6dd68"]]},{"id":"7422b69e.c6dd68","type":"function","z":"cbd3c5cd.d78358","name":"","func":"msg.request.base64 = msg.request.base64.split(\":\")\nmsg.payload = { }\nmsg.payload.Tables = { }\nmsg.payload.Tables.tablename = msg.request.tablename\nmsg.payload.Tables.LoginService = {\"$\":{\"xmlns\":\"http://www.fastnetasp.com/GeneralImport\"},\"login\":msg.request.base64[0],\"password\":msg.request.base64[1]}\nmsg.method = \"POST\"\nmsg.headers = { }\nmsg.headers[\"Content-Type\"] = \"application/soap+xml\"\nmsg.url = msg.request.agilityURL + \"/services/generalimport.ashx/\" + msg.request.exportdef\n\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":80,"wires":[["37c43b47.9cce84"]]},{"id":"37c43b47.9cce84","type":"xml","z":"cbd3c5cd.d78358","name":"","property":"payload","attr":"","chr":"","x":1130,"y":80,"wires":[["966aabab.81a468"]]},{"id":"966aabab.81a468","type":"http request","z":"cbd3c5cd.d78358","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1270,"y":80,"wires":[["8773dc4e.32c4c"]]},{"id":"8773dc4e.32c4c","type":"function","z":"cbd3c5cd.d78358","name":"","func":"var columns = [ ]\nvar i\n\nfor(i = 0; i < msg.payload.length; i++){\n    delete msg.payload[i].frequentlyused\n}\n\ncolumns = msg.payload\nmsg.payload = { }\nmsg.payload.tablename = msg.request.tablename\nmsg.payload.columns = columns\n\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":80,"wires":[["e7e08dee.0c04b"]]},{"id":"e7e08dee.0c04b","type":"join","z":"cbd3c5cd.d78358","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1570,"y":80,"wires":[[]]},{"id":"311f33f6.6c438c","type":"function","z":"cbd3c5cd.d78358","name":"","func":"msg.request.select = \"uiFormElement.TableName\"\nmsg.request.filter = \"uiFormDef.DataClass='\" + msg.request.businessobject + \"' and (uiformDef.FormClass = 'ScanForm.aspx' or uiFormDef.FormClass = 'DetailForm.aspx') and uiFormElement.TableName is not null and uiFormelement.TableName != '' and uiFormElement.TableName != 'formparameter'\"\nmsg.request.orderby = \"uiFormElement.TableName\"\nmsg.request.distinct = \"\"\nmsg.request.maxresults = \"-1\"\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":120,"wires":[["feb0a718.909248"]]},{"id":"f09425c.c4db1d8","type":"subflow:8d62f5ef.75e948","z":"a71e4e87.fb79f","name":"","env":[],"x":470,"y":240,"wires":[["592a2fa8.49dd"]]},{"id":"324988.08793678","type":"change","z":"a71e4e87.fb79f","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"request","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"[{\"property\":\"client_id\"},{\"property\":\"client_secret\"}]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":355,"y":240,"wires":[["f09425c.c4db1d8"]],"l":false},{"id":"1a682f86.de6ba","type":"base64","z":"a71e4e87.fb79f","name":"","action":"str","property":"payload.auth","x":780,"y":240,"wires":[["9ec1a68a.e489d8"]]},{"id":"592a2fa8.49dd","type":"function","z":"a71e4e87.fb79f","name":"","func":"msg.request.client_id = msg.payload[0].value\nmsg.request.client_secret = msg.payload[1].value\nmsg.payload = {}\nmsg.payload.auth = msg.request.client_id  + \":\" + msg.request.client_secret\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":240,"wires":[["1a682f86.de6ba"]]},{"id":"9ec1a68a.e489d8","type":"function","z":"a71e4e87.fb79f","name":"","func":"var auth = \"Basic \" + msg.payload.auth\n\nmsg.url = \"https://ssgidentity.azurewebsites.net/connect/token\"\nmsg.method = \"POST\"\n//msg.headers = {\"content-type\":\"application/x-www-form-urlencoded\",\"authorization\":auth}\nmsg.headers = {\"content-type\":\"application/x-www-form-urlencoded\"}\n//msg.headers = {\"content-type\":\"application/json\"}\nmsg.payload = {}\nmsg.payload = {\n        \"grant_type\":\"client_credentials\",\n        \"client_id\":msg.request.client_id,\n        \"client_secret\":msg.request.client_secret,\n        \"scope\":\"ssg-agility-api\"\n        \n}\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":240,"wires":[["acf48ec3.f5bcb"]]},{"id":"5dbc0d66.c53b04","type":"function","z":"cbd3c5cd.d78358","name":"Process Scema Results","func":"\nvar tables = [ ]\nvar i\n\nif(msg.payload.length > 0){\n    for(i = 0; i < msg.payload.length; i++){\n       if(tables.indexOf(msg.payload[i].uiFormElement_TableName) == -1)    \n        {tables.push(msg.payload[i].uiFormElement_TableName)}\n    }\n}\nmsg.payload = tables\nreturn msg;","outputs":1,"noerr":0,"x":1510,"y":120,"wires":[[]]},{"id":"1891c771.fb3769","type":"switch","z":"f5d31599.48fec8","name":"HTTP method","property":"req.method","propertyType":"msg","rules":[{"t":"eq","v":"GET","vt":"str"},{"t":"eq","v":"POST","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":920,"y":220,"wires":[["f1a01883.ffa028"],["9a89c227.33b5e"],["e636249d.c9aae8"]]},{"id":"9a89c227.33b5e","type":"switch","z":"f5d31599.48fec8","name":"Path parameter","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"query","vt":"str"},{"t":"eq","v":"add","vt":"str"},{"t":"eq","v":"addfromstdjob","vt":"str"},{"t":"eq","v":"statusupdate","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":5,"x":1180,"y":220,"wires":[["86f54022.36605"],["4c8dbfee.63d0f"],["8707e5c0.587d18"],["a89e7177.da97a"],["e636249d.c9aae8"]]},{"id":"e5487845.d7cef8","type":"subflow:37184d93.e34d32","z":"f5d31599.48fec8","name":"","env":[],"x":1650,"y":140,"wires":[["caac03d6.7edba"]]},{"id":"86f54022.36605","type":"subflow:1bef542e.d2fb4c","z":"f5d31599.48fec8","name":"","env":[],"x":1430,"y":140,"wires":[["e5487845.d7cef8"]]},{"id":"feb0a718.909248","type":"subflow:37184d93.e34d32","z":"cbd3c5cd.d78358","name":"","env":[],"x":530,"y":120,"wires":[["c4935bf6.ea5b08"]]},{"id":"5633eb45.9ea474","type":"subflow:cbd3c5cd.d78358","z":"f5d31599.48fec8","name":"","env":[],"x":1170,"y":40,"wires":[["95423d9a.f6be4"]]},{"id":"75a9aca7.b40394","type":"change","z":"cbd3c5cd.d78358","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":315,"y":160,"wires":[["7e6bfe61.cfb85"]],"l":false},{"id":"7e6bfe61.cfb85","type":"subflow:c0f13f8b.9a1e1","z":"cbd3c5cd.d78358","name":"","env":[],"x":440,"y":160,"wires":[]},{"id":"2d0a62a5.256efe","type":"switch","z":"57d6e8f2.02b798","name":"","property":"req.headers","propertyType":"msg","rules":[{"t":"hask","v":"x-api-key","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":175,"y":160,"wires":[["1cfe0991.322126"],[]],"l":false},{"id":"47954589.1b01dc","type":"function","z":"57d6e8f2.02b798","name":"","func":"if(msg.request === undefined){\n    msg.request = { }\n}\nmsg.request.apikeyhash = msg.payload\nmsg.collection = \"keys\"\nmsg.payload = {\n    \"$and\":[{\"tenantID\":msg.req.headers.tenantid},{\"apikey\":msg.request.apikeyhash},{\"isDeleted\":false}]\n}\nmsg.projection = {\n    \"_id\":0,\n    \"apikey\":1\n}\nreturn msg;","outputs":1,"noerr":0,"x":375,"y":120,"wires":[["b5522fae.d12a5"]],"l":false},{"id":"1cfe0991.322126","type":"function","z":"57d6e8f2.02b798","name":"","func":"msg.payload = msg.req.headers[\"x-api-key\"]\n\nreturn msg;","outputs":1,"noerr":0,"x":255,"y":120,"wires":[["376a3591.635cda"]],"l":false},{"id":"376a3591.635cda","type":"hmac","z":"57d6e8f2.02b798","name":"","algorithm":"HmacSHA256","key":"F0rtknox!","x":315,"y":120,"wires":[["47954589.1b01dc"]],"l":false},{"id":"b5522fae.d12a5","type":"mongodb in","z":"57d6e8f2.02b798","mongodb":"c937f6f8.0319f8","name":"","collection":"","operation":"find","x":530,"y":120,"wires":[["7ba2ab12.dc9d54"]]},{"id":"7ba2ab12.dc9d54","type":"function","z":"57d6e8f2.02b798","name":"","func":"delete msg.collection\nif(msg.payload.length > 0){\n    msg.payload = true\n}\nelse msg.payload = false\nreturn msg;","outputs":1,"noerr":0,"x":695,"y":120,"wires":[["cc47cd07.c08f5"]],"l":false},{"id":"cc47cd07.c08f5","type":"switch","z":"57d6e8f2.02b798","name":"","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":755,"y":120,"wires":[["615d12ec.e7d8ac"],["b602bf27.ce97"]],"l":false},{"id":"b602bf27.ce97","type":"change","z":"57d6e8f2.02b798","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"not authorised","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":815,"y":160,"wires":[["1e381a9c.3704c5"]],"l":false},{"id":"1e381a9c.3704c5","type":"subflow:c0f13f8b.9a1e1","z":"57d6e8f2.02b798","name":"","x":940,"y":160,"wires":[]},{"id":"615d12ec.e7d8ac","type":"change","z":"57d6e8f2.02b798","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"[{\"property\":\"client_id\"},{\"property\":\"client_secret\"}]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":815,"y":80,"wires":[["4ee2e005.db75c"]],"l":false},{"id":"4ee2e005.db75c","type":"subflow:8d62f5ef.75e948","z":"57d6e8f2.02b798","name":"","env":[],"x":930,"y":80,"wires":[["40bf46de.c088a8"]]},{"id":"40bf46de.c088a8","type":"function","z":"57d6e8f2.02b798","name":"","func":"msg.request.client_id = msg.payload[0].value\nmsg.request.client_secret = msg.payload[1].value\nmsg.payload = {}\nmsg.payload.auth = msg.request.client_id  + \":\" + msg.request.client_secret\n\nreturn msg;","outputs":1,"noerr":0,"x":1055,"y":80,"wires":[["ff163fe2.9825c"]],"l":false},{"id":"ff163fe2.9825c","type":"base64","z":"57d6e8f2.02b798","name":"","action":"str","property":"payload.auth","x":1115,"y":80,"wires":[["2c466928.b25976"]],"l":false},{"id":"2c466928.b25976","type":"function","z":"57d6e8f2.02b798","name":"","func":"var auth = \"Basic \" + msg.payload.auth\n\nmsg.url = \"https://ssgidentity.azurewebsites.net/connect/token\"\nmsg.method = \"POST\"\n//msg.headers = {\"content-type\":\"application/x-www-form-urlencoded\",\"authorization\":auth}\nmsg.headers = {\"content-type\":\"application/x-www-form-urlencoded\"}\n//msg.headers = {\"content-type\":\"application/json\"}\nmsg.payload = {}\nmsg.payload = {\n        \"grant_type\":\"client_credentials\",\n        \"client_id\":msg.request.client_id,\n        \"client_secret\":msg.request.client_secret,\n        \"scope\":\"ssg-agility-api\"\n        \n}\nreturn msg;","outputs":1,"noerr":0,"x":1175,"y":80,"wires":[["d3485c72.ae8f7"]],"l":false},{"id":"d3485c72.ae8f7","type":"http request","z":"57d6e8f2.02b798","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1290,"y":80,"wires":[["17a938b5.1ee7e7"]]},{"id":"17a938b5.1ee7e7","type":"function","z":"57d6e8f2.02b798","name":"","func":"msg.request.bearerauth = \"Bearer \" + msg.payload.access_token\ndelete msg.url\ndelete msg.headers\ndelete msg.statusCode\ndelete msg.collection\nreturn msg;","outputs":1,"noerr":0,"x":1415,"y":80,"wires":[[]],"l":false},{"id":"20a22c1f.da79c4","type":"subflow:57d6e8f2.02b798","z":"f5d31599.48fec8","name":"","env":[],"x":310,"y":240,"wires":[["d498279d.a31c68"],["d498279d.a31c68"]]},{"id":"4c8dbfee.63d0f","type":"json-full-schema-validator","z":"f5d31599.48fec8","name":"Add","property":"request.body","propertyType":"msg","func":"{\n  \"$schema\": \"http://json-schema.org/draft-04/schema#\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"AssetCode\": {\n      \"type\": \"string\"\n    },\n    \"Description\": {\n      \"type\": \"string\"\n    },\n    \"WorkOrderTypeCode\": {\n      \"type\": \"string\"\n    },\n    \"PriorityCode\": {\n      \"type\": \"string\"\n    },\n    \"WorkOrderStatusCode\": {\n      \"type\": \"string\"\n    },\n    \"CraftCode\": {\n      \"type\": \"string\"\n    },\n    \"StartDate\": {\n      \"type\": \"string\"\n    },\n    \"EstimatedDuration\": {\n      \"type\": \"integer\"\n    }\n  },\n  \"required\": [\n    \"AssetCode\",\n    \"Description\",\n    \"WorkOrderTypeCode\",\n    \"PriorityCode\",\n    \"WorkOrderStatusCode\",\n    \"CraftCode\",\n    \"StartDate\",\n    \"EstimatedDuration\"\n  ]\n}","x":1510,"y":240,"wires":[["ef665d86.a811c"],["15a47e40.25c3b2"]]},{"id":"33e95d67.36c712","type":"json-full-schema-validator","z":"1bef542e.d2fb4c","name":"Validate request","property":"request.body","propertyType":"msg","func":"{\n  \"$schema\": \"http://json-schema.org/draft-04/schema#\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"select\": {\n      \"type\": \"array\",\n      \"items\": [\n        {\n          \"type\": \"string\"\n        }\n      ]\n    },\n    \"filter\": {\n      \"type\": \"array\",\n      \"items\": [\n        {\n          \"type\": \"object\",\n          \"properties\": {\n            \"column\": {\n              \"type\": \"string\"\n            },\n            \"value\": {\n                \"type\":[\"string\",\"array\",\"boolean\"]\n            },\n            \"condition\": {\n              \"type\": \"string\"\n            }\n          },\n          \"required\": [\n            \"column\",\n            \"value\",\n            \"condition\"\n          ]\n        }\n      ]\n    },\n    \"orderby\": {\n      \"type\": \"array\",\n      \"items\": [\n        {\n          \"type\": \"string\"\n        },\n        {\n          \"type\": \"string\"\n        }\n      ]\n    },\n    \"distinct\": {\n      \"type\": \"boolean\"\n    },\n    \"maxrows\": {\n      \"type\": \"integer\"\n    }\n  },\n  \"required\": [\n    \"select\"\n  ]\n}","x":240,"y":100,"wires":[["ad71eef7.39dd2"],["6872521d.76416c"]]},{"id":"59cafbeb.81acc4","type":"subflow:c0f13f8b.9a1e1","z":"1bef542e.d2fb4c","name":"","x":500,"y":120,"wires":[]},{"id":"6872521d.76416c","type":"change","z":"1bef542e.d2fb4c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"error in request body","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":375,"y":120,"wires":[["59cafbeb.81acc4"]],"l":false},{"id":"42d5aa42.2b4c84","type":"subflow:c0f13f8b.9a1e1","z":"f5d31599.48fec8","name":"","env":[],"x":1740,"y":260,"wires":[]},{"id":"15a47e40.25c3b2","type":"change","z":"f5d31599.48fec8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"error in request body","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1615,"y":260,"wires":[["42d5aa42.2b4c84"]],"l":false},{"id":"ef665d86.a811c","type":"change","z":"f5d31599.48fec8","name":"Set Export Def","rules":[{"t":"set","p":"request.exportdef","pt":"msg","to":"Connect_AddWorkOrderBasic","tot":"str"},{"t":"set","p":"request.container","pt":"msg","to":"Actions","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1680,"y":220,"wires":[["49ffa4a9.8cfc3c"]]},{"id":"d3ae91a7.d0e05","type":"function","z":"695c8489.c3dbec","name":"","func":"// Split auth into user and pass\nmsg.request.login = [ ]\nmsg.request.login = msg.payload.split(\":\")\n\n\n// Create std object to hold WS request body\n\nmsg.request.wsreq = { }\n\nif(msg.request.payload !== undefined){\n    msg.request.wsreq = msg.request.payload\n}\nelse {\n    switch (msg.req.method) {\n        case \"GET\":\n            msg.request.wsreq = msg.request.query\n        break;\n        case \"POST\":\n            msg.request.wsreq = msg.request.body\n        break;\n    }\n}\n// Add authentication using login service\nmsg.request.wsreq.LoginService = {\"$\":{\"xmlns\":\"http://www.fastnetasp.com/GeneralImport\"},\"login\":msg.request.login[0],\"password\":msg.request.login[1]}\nmsg.payload = { }\nmsg.payload[msg.request.container] = msg.request.wsreq \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":375,"y":120,"wires":[["8ef0fffb.d106c"]],"l":false},{"id":"2e41d810.4ac7f8","type":"function","z":"695c8489.c3dbec","name":"Basic Auth","func":"msg.payload = msg.request.basicauth.substring(6,msg.request.basicauth.length)\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":255,"y":120,"wires":[["7a2c60c2.3f4cb"]],"l":false},{"id":"7a2c60c2.3f4cb","type":"base64","z":"695c8489.c3dbec","name":"","action":"b64","property":"payload","x":315,"y":120,"wires":[["d3ae91a7.d0e05"]],"l":false},{"id":"8ef0fffb.d106c","type":"xml","z":"695c8489.c3dbec","name":"","property":"payload","attr":"","chr":"","x":470,"y":120,"wires":[["c355a204.98d24","b0a3038a.9cf99"]]},{"id":"c355a204.98d24","type":"function","z":"695c8489.c3dbec","name":"Build request","func":"msg.method = \"POST\"\nmsg.url = msg.request.agilityURL + \"/services/generalimport.ashx/\" + msg.request.exportdef\nmsg.headers = {\"content-type\":\"application/soap+xml\"}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":610,"y":120,"wires":[["df8fb3d0.a7ff","e5bfd4a0.13be18"]]},{"id":"df8fb3d0.a7ff","type":"http request","z":"695c8489.c3dbec","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":770,"y":120,"wires":[["b03b48f6.a04348"]]},{"id":"7512215f.765be","type":"function","z":"9da11551.0b2828","name":"Get response type","func":"if(typeof(msg.payload) == \"string\"){\n    if(msg.payload.charAt(0) == \"<\"){\n        msg.request.responsetype = \"xml\"\n    }\n    else if(msg.payload.charAt(0) == \"[\"){\n         msg.request.responsetype = \"json\"\n    }\n    else if(msg.payload == [ ]){\n        msg.request.responsetype = \"json\"\n    }\n    else {msg.request.responsetype = \"json\"}\n}\nelse {msg.request.responsetype = typeof(msg.payload)}\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":140,"wires":[["70ec9d9c.5e07e4"]]},{"id":"49ffa4a9.8cfc3c","type":"subflow:695c8489.c3dbec","z":"f5d31599.48fec8","name":"","env":[],"x":1890,"y":220,"wires":[["5ffb8db7.227604"]]},{"id":"ea136e70.567b9","type":"switch","z":"9da11551.0b2828","name":"","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":190,"y":180,"wires":[["7512215f.765be"],["771c3bb4.65bf24"]]},{"id":"771c3bb4.65bf24","type":"function","z":"9da11551.0b2828","name":"","func":"// Set error message based upon status code\nswitch(msg.statusCode){\n    case 401:\n        msg.payload = \"not authorised\"\n    break;\n    default:\n        msg.payload = \"internal error\"\n    break;\n}\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":220,"wires":[["7f17b9ec.eee508"]]},{"id":"70ec9d9c.5e07e4","type":"switch","z":"9da11551.0b2828","name":"","property":"request.responsetype","propertyType":"msg","rules":[{"t":"eq","v":"json","vt":"str"},{"t":"eq","v":"object","vt":"str"},{"t":"eq","v":"xml","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":570,"y":140,"wires":[["20a6610d.6f5b0e"],["ef0475c2.d11ad8"],["f31c4cdb.b493d"]]},{"id":"20a6610d.6f5b0e","type":"json","z":"9da11551.0b2828","name":"","property":"payload","action":"","pretty":false,"x":710,"y":80,"wires":[["fe626614.ac0678"]]},{"id":"5c5c83cd.b8d86c","type":"function","z":"9da11551.0b2828","name":"","func":"var i\n\n//interate over array looking for errors\n\nfor(i = 0; i < msg.payload.length; i++){\n    if(msg.payload[i].Successful === false){\n        msg.statusCode = 500\n    }\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":100,"wires":[["f67c1078.538de"]]},{"id":"7f17b9ec.eee508","type":"subflow:c0f13f8b.9a1e1","z":"9da11551.0b2828","name":"","x":520,"y":220,"wires":[]},{"id":"f31c4cdb.b493d","type":"change","z":"9da11551.0b2828","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"internal error","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":695,"y":180,"wires":[["41479cbd.2d56d4"]],"l":false},{"id":"41479cbd.2d56d4","type":"subflow:c0f13f8b.9a1e1","z":"9da11551.0b2828","name":"","x":820,"y":180,"wires":[]},{"id":"9bdaac07.6dbb5","type":"change","z":"9da11551.0b2828","name":"Tidy Up","rules":[{"t":"delete","p":"request","pt":"msg"},{"t":"delete","p":"errormsg","pt":"msg"},{"t":"delete","p":"url","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1480,"y":120,"wires":[["1527b701.c24819"]]},{"id":"f67c1078.538de","type":"function","z":"9da11551.0b2828","name":"Placeholder for logging","func":"\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":120,"wires":[["9bdaac07.6dbb5"]]},{"id":"95423d9a.f6be4","type":"subflow:9da11551.0b2828","z":"f5d31599.48fec8","name":"","env":[],"x":1380,"y":40,"wires":[]},{"id":"1527b701.c24819","type":"http response","z":"9da11551.0b2828","name":"","statusCode":"","headers":{},"x":1630,"y":120,"wires":[]},{"id":"caac03d6.7edba","type":"subflow:9da11551.0b2828","z":"f5d31599.48fec8","name":"","x":1860,"y":140,"wires":[]},{"id":"5ffb8db7.227604","type":"subflow:9da11551.0b2828","z":"f5d31599.48fec8","name":"","env":[],"x":2120,"y":220,"wires":[]},{"id":"e636249d.c9aae8","type":"change","z":"f5d31599.48fec8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1115,"y":300,"wires":[["8562c316.0741f"]],"l":false},{"id":"8562c316.0741f","type":"subflow:c0f13f8b.9a1e1","z":"f5d31599.48fec8","name":"","env":[],"x":1240,"y":300,"wires":[]},{"id":"8707e5c0.587d18","type":"json-full-schema-validator","z":"f5d31599.48fec8","name":"AddFromStdJob","property":"request.body","propertyType":"msg","func":"{\n  \"$schema\": \"http://json-schema.org/draft-04/schema#\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"AssetCode\": {\n      \"type\": \"string\"\n    },\n    \"StdJobCode\": {\n      \"type\": \"string\"\n    },\n    \"SystemName\": {\n      \"type\": \"string\"\n    },\n    \"ReferenceID\": {\n      \"type\": \"string\"\n    },\n    \"OriginatorJobCode\": {\n      \"type\": \"string\"\n    },\n    \"StartDate\": {\n      \"type\": \"string\"\n    },\n    \"Description\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\n    \"AssetCode\",\n    \"StdJobCode\"\n  ]\n}","x":1540,"y":340,"wires":[["fb7485c.f74fa78"],["c426614d.a1f7a"]]},{"id":"e592ba84.8f7ed8","type":"subflow:c0f13f8b.9a1e1","z":"f5d31599.48fec8","name":"","env":[],"x":1820,"y":360,"wires":[]},{"id":"c426614d.a1f7a","type":"change","z":"f5d31599.48fec8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"error in request body","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1695,"y":360,"wires":[["e592ba84.8f7ed8"]],"l":false},{"id":"fb7485c.f74fa78","type":"change","z":"f5d31599.48fec8","name":"Set Export Def","rules":[{"t":"set","p":"request.exportdef","pt":"msg","to":"Connect_AddWorkOrderFromStdJob","tot":"str"},{"t":"set","p":"request.container","pt":"msg","to":"Actions","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1760,"y":320,"wires":[["5ba31f21.0904d"]]},{"id":"5ba31f21.0904d","type":"subflow:695c8489.c3dbec","z":"f5d31599.48fec8","name":"","env":[],"x":1970,"y":320,"wires":[["42e9162e.b7ed78"]]},{"id":"42e9162e.b7ed78","type":"subflow:9da11551.0b2828","z":"f5d31599.48fec8","name":"","env":[],"x":2200,"y":320,"wires":[]},{"id":"c4935bf6.ea5b08","type":"json","z":"cbd3c5cd.d78358","name":"","property":"payload","action":"","pretty":false,"x":1290,"y":120,"wires":[["5dbc0d66.c53b04"]]},{"id":"2e6acd58.879382","type":"switch","z":"ab15ef43.c5a4c","name":"","property":"errormsg","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":255,"y":80,"wires":[["b36a258a.3f8858"],["eb5ecd92.6f8f4"]],"l":false},{"id":"eb5ecd92.6f8f4","type":"function","z":"ab15ef43.c5a4c","name":"","func":"var base64\n\nif(msg.request.bearerauth.substring(0,6) == \"Bearer\"){\n    var token = msg.request.bearerauth.substring(msg.request.bearerauth.indexOf(\" \"))\n    var strlen = token.length\n    var pos1 = token.indexOf(\".\")\n    var pos2 = token.lastIndexOf(\".\")\n    base64 = token.substring(pos1 + 1,pos2)\n    base64 = base64.replace(/-/g, '+').replace(/_/g, '/');\n    var pad = base64.length % 4;\n    if(pad) {\n      if(pad === 1) {\n        msg.errormsg = \"authentication error\"\n      }\n      base64 += new Array(5 - pad).join('=')\n    }\n    msg.request.base64 = base64\n}\nelse {\n    msg.errormsg = \"authentication not supported\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":315,"y":120,"wires":[["e78b340c.95daa8"]],"l":false},{"id":"9ccdaab4.56c3f8","type":"function","z":"ab15ef43.c5a4c","name":"","func":"var decoded = JSON.parse(msg.request.base64)\nvar token_expiry = decoded.exp\n\nif(token_expiry < Math.round((new Date()).getTime() / 1000)){\n    msg.errormsg = \"token expired\"\n}\n\nmsg.request.tokenexpiry = decoded.exp\nmsg.request.sub = decoded.sub\n\ndelete msg.request.base64\nreturn msg;","outputs":1,"noerr":0,"x":495,"y":140,"wires":[["bd308b88.e7a2c8"]],"l":false},{"id":"b36a258a.3f8858","type":"change","z":"ab15ef43.c5a4c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ }","tot":"json"},{"t":"move","p":"errormsg","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":995,"y":80,"wires":[[]],"l":false},{"id":"7f5c1ca2.77aca4","type":"base64","z":"ab15ef43.c5a4c","name":"","action":"b64","property":"request.base64","x":435,"y":140,"wires":[["9ccdaab4.56c3f8"]],"l":false},{"id":"9ee9eaa6.208128","type":"function","z":"ab15ef43.c5a4c","name":"","func":"\n//var accept\n//var version\nvar endpoint = msg.req.url\n\nif(msg.request === undefined){\n    msg.request = { }\n}\nmsg.errormsg = { }\nmsg.payload = { }\n\n// version checking\n//if(msg.req.headers.accept !== undefined){\n//    if(msg.req.headers.accept.substring(msg.req.headers.accept.indexOf(\"vnd.ssginsight.com.v\") + 20,msg.req.headers.accept.indexOf(\"+\")) != \"1\"){\n//        msg.errormsg = \"version not supported\"\n//    }\n//    else {msg.request.version = msg.req.headers.accept.substring(msg.req.headers.accept.indexOf(\"vnd.ssginsight.com.v\") + 20,msg.req.headers.accept.indexOf(\"+\"))}\n//}\nif(msg.req.headers[\"accept-version\"] !== undefined){\n    if(msg.req.headers[\"accept-version\"] != \"v1\"){\n        msg.errormsg = \"version not supported\"\n    }\n    else {\n        msg.request.version = msg.req.headers[\"accept-version\"].charAt(1)\n    }\n}\nelse {\n    msg.errormsg = \"version missing\"\n}\n\nif(msg.req.params.hasOwnProperty(\"method\")){\n    msg.request.apimethod = msg.req.params.method.toLowerCase()\n}\nif(msg.request.bearerauth === undefined){\n    if(msg.req.headers.authorization !== undefined){\n        msg.request.bearerauth = msg.req.headers.authorization\n    }\n    else {\n        msg.errormsg = \"authentication missing\"\n    }\n}\n\nif(msg.req.headers.tenantid !== undefined){\n    msg.request.tenantid = msg.req.headers.tenantid\n}\nelse {\n    msg.errormsg = \"tenantid missing\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":195,"y":80,"wires":[["2e6acd58.879382"]],"l":false},{"id":"e78b340c.95daa8","type":"switch","z":"ab15ef43.c5a4c","name":"","property":"errormsg","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":375,"y":120,"wires":[["b36a258a.3f8858"],["7f5c1ca2.77aca4"]],"l":false},{"id":"bd308b88.e7a2c8","type":"switch","z":"ab15ef43.c5a4c","name":"","property":"errormsg","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":555,"y":140,"wires":[["b36a258a.3f8858"],["fcdee54c.ce1088"]],"l":false},{"id":"fcdee54c.ce1088","type":"function","z":"ab15ef43.c5a4c","name":"","func":"msg.collection = \"tenants\"\nmsg.payload = {\n    \"$and\":[\n            {\"tenantID\":msg.request.tenantid},\n            {\"isDeleted\":false}\n        ]\n}\nmsg.projection = {\n    \"_id\":0,\n    \"tenantID\":1,\n    \"label\":1,\n    \"agilityURL\":1,\n    \"bogatewayURL\":1,\n    \"authMethod\":1,\n    \"basicauth\":1\n}\nreturn msg;","outputs":1,"noerr":0,"x":615,"y":180,"wires":[["abf72584.ff7ff8"]],"l":false},{"id":"abf72584.ff7ff8","type":"mongodb in","z":"ab15ef43.c5a4c","mongodb":"c937f6f8.0319f8","name":"","collection":"","operation":"find","x":675,"y":180,"wires":[["86a1fb70.ce7a68"]],"l":false},{"id":"86a1fb70.ce7a68","type":"function","z":"ab15ef43.c5a4c","name":"","func":"if(msg.payload.length === 0){\n    msg.errormsg = \"tenant not found\"\n}\nelse {\n    msg.request.agilityURL = msg.payload[0].agilityURL\n    msg.request.bogatewayURL = msg.payload[0].bogatewayURL\n    msg.request.authmethod = msg.payload[0].authMethod\n    msg.request.basicauth = msg.payload[0].basicauth\n    msg.collection = \"instances\"\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":495,"y":300,"wires":[["5d5d0860.020748"]],"l":false},{"id":"b0eb9d3b.c9bee","type":"switch","z":"ab15ef43.c5a4c","name":"","property":"errormsg","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":815,"y":240,"wires":[["b36a258a.3f8858"],["ba7cc518.b2f3e8"]],"l":false},{"id":"ba7cc518.b2f3e8","type":"mongodb in","z":"ab15ef43.c5a4c","mongodb":"c937f6f8.0319f8","name":"","collection":"","operation":"find","x":895,"y":240,"wires":[["1ecd5dc6.ad8212"]],"l":false},{"id":"b34cb974.047ba8","type":"switch","z":"ab15ef43.c5a4c","name":"","property":"req.method","propertyType":"msg","rules":[{"t":"eq","v":"GET","vt":"str"},{"t":"eq","v":"POST","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":950,"y":360,"wires":[["20c54454.c9b3cc"],["6a99bff2.b57c7"]]},{"id":"20c54454.c9b3cc","type":"change","z":"ab15ef43.c5a4c","name":"","rules":[{"t":"set","p":"request.query","pt":"msg","to":"req.query","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1055,"y":340,"wires":[["96b2bbba.461798"]],"l":false},{"id":"6a99bff2.b57c7","type":"change","z":"ab15ef43.c5a4c","name":"","rules":[{"t":"set","p":"request.body","pt":"msg","to":"req.body","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1055,"y":380,"wires":[["96b2bbba.461798"]],"l":false},{"id":"96b2bbba.461798","type":"change","z":"ab15ef43.c5a4c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"request.basicauth","tot":"msg"},{"t":"delete","p":"collection","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1115,"y":360,"wires":[["b13b5a72.d8b508"]],"l":false},{"id":"1ecd5dc6.ad8212","type":"function","z":"ab15ef43.c5a4c","name":"","func":"if(msg.payload.length === 0){\n    msg.errormsg = \"not authorised\"\n}\nelse {\n    msg.payload = { }\n}\nreturn msg;","outputs":1,"noerr":0,"x":955,"y":240,"wires":[["802c1be7.df62e8"]],"l":false},{"id":"b13b5a72.d8b508","type":"decrypt","z":"ab15ef43.c5a4c","name":"","algorithm":"TripleDES","key":"F0rtknox!","x":1175,"y":360,"wires":[["8a3bff88.09bf3"]],"l":false},{"id":"f8c97cae.85901","type":"function","z":"ab15ef43.c5a4c","name":"","func":"msg.request.basicauth = \"Basic \" + msg.payload\nmsg.payload = { }\nreturn msg;","outputs":1,"noerr":0,"x":1295,"y":360,"wires":[[]],"l":false},{"id":"8a3bff88.09bf3","type":"base64","z":"ab15ef43.c5a4c","name":"","action":"str","property":"payload","x":1235,"y":360,"wires":[["f8c97cae.85901"]],"l":false},{"id":"5d5d0860.020748","type":"switch","z":"ab15ef43.c5a4c","name":"","property":"request","propertyType":"msg","rules":[{"t":"hask","v":"sub","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":555,"y":300,"wires":[["1fe2c763.00e989"],["b34cb974.047ba8"]],"l":false},{"id":"2edeedf4.420422","type":"function","z":"ab15ef43.c5a4c","name":"","func":"msg.payload = {\n    \"$and\":[{\"tenantID\":msg.request.tenantid},\n            {\"sub\":msg.request.sub},\n            {\"isDeleted\":false}\n        ]\n}\nmsg.projection = {\n    \"_id\":0,\n    \"tenantID\":1,\n    \"sub\":1\n}\nreturn msg;","outputs":1,"noerr":0,"x":735,"y":240,"wires":[["b0eb9d3b.c9bee"]],"l":false},{"id":"802c1be7.df62e8","type":"switch","z":"ab15ef43.c5a4c","name":"","property":"errormsg","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1015,"y":240,"wires":[["b36a258a.3f8858"],["b34cb974.047ba8"]],"l":false},{"id":"1fe2c763.00e989","type":"function","z":"ab15ef43.c5a4c","name":"","func":"if(msg.request.sub === undefined){\n    msg.request.hassub = false\n}\nelse msg.request.hassub = true\nreturn msg;","outputs":1,"noerr":0,"x":615,"y":280,"wires":[["35fd7355.31c2ec"]],"l":false},{"id":"35fd7355.31c2ec","type":"switch","z":"ab15ef43.c5a4c","name":"","property":"request.hassub","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":675,"y":260,"wires":[["2edeedf4.420422"],["b34cb974.047ba8"]],"l":false},{"id":"e44af051.db1a7","type":"http in","z":"cdfadb10.9fa798","name":"GET assets","url":"/assets/:method","method":"get","upload":false,"swaggerDoc":"","x":90,"y":220,"wires":[["73f33d26.b75aa4"]]},{"id":"fe78e510.01e0a8","type":"http in","z":"cdfadb10.9fa798","name":"POST assets","url":"/assets/:method","method":"post","upload":false,"swaggerDoc":"","x":90,"y":260,"wires":[["73f33d26.b75aa4"]]},{"id":"a2994371.b41ce","type":"subflow:ab15ef43.c5a4c","z":"cdfadb10.9fa798","name":"","env":[],"x":490,"y":240,"wires":[["cc19e363.3d3a9"],["ef219cc0.1fc86"]]},{"id":"bd0699c4.111d58","type":"switch","z":"cdfadb10.9fa798","name":"","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"schema","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1095,"y":100,"wires":[["19877729.4660b9"],["1a89180b.131198"]],"outputLabels":["schema","not supported"],"l":false},{"id":"1a89180b.131198","type":"change","z":"cdfadb10.9fa798","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1175,"y":120,"wires":[["67146f81.d066a"]],"l":false},{"id":"67146f81.d066a","type":"subflow:c0f13f8b.9a1e1","z":"cdfadb10.9fa798","name":"","env":[],"x":1300,"y":120,"wires":[]},{"id":"cc19e363.3d3a9","type":"change","z":"cdfadb10.9fa798","name":"Set Endpoint BO","rules":[{"t":"set","p":"request.businessobject","pt":"msg","to":"DataBO.ProcessMngt.AssetBO","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":220,"wires":[["173e6779.503de9"]]},{"id":"173e6779.503de9","type":"switch","z":"cdfadb10.9fa798","name":"HTTP method","property":"req.method","propertyType":"msg","rules":[{"t":"eq","v":"GET","vt":"str"},{"t":"eq","v":"POST","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":900,"y":220,"wires":[["bd0699c4.111d58"],["c8c51227.fd324"],["ce59e19b.486bb"]]},{"id":"c8c51227.fd324","type":"switch","z":"cdfadb10.9fa798","name":"Path parameter","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"query","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1160,"y":220,"wires":[["f9619c8a.e1b22"],["ce59e19b.486bb"]]},{"id":"74c95956.efbe28","type":"subflow:37184d93.e34d32","z":"cdfadb10.9fa798","name":"","env":[],"x":1630,"y":160,"wires":[["4edd42e0.f4647c"]]},{"id":"f9619c8a.e1b22","type":"subflow:1bef542e.d2fb4c","z":"cdfadb10.9fa798","name":"","env":[],"x":1410,"y":160,"wires":[["74c95956.efbe28"]]},{"id":"19877729.4660b9","type":"subflow:cbd3c5cd.d78358","z":"cdfadb10.9fa798","name":"","env":[],"x":1250,"y":80,"wires":[["4d0fc04f.aa6f"]]},{"id":"73f33d26.b75aa4","type":"subflow:57d6e8f2.02b798","z":"cdfadb10.9fa798","name":"","env":[],"x":290,"y":240,"wires":[["a2994371.b41ce"],["a2994371.b41ce"]]},{"id":"4d0fc04f.aa6f","type":"subflow:9da11551.0b2828","z":"cdfadb10.9fa798","name":"","env":[],"x":1480,"y":80,"wires":[]},{"id":"4edd42e0.f4647c","type":"subflow:9da11551.0b2828","z":"cdfadb10.9fa798","name":"","x":1840,"y":160,"wires":[]},{"id":"ce59e19b.486bb","type":"change","z":"cdfadb10.9fa798","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1095,"y":300,"wires":[["5f5f5fc0.581a"]],"l":false},{"id":"5f5f5fc0.581a","type":"subflow:c0f13f8b.9a1e1","z":"cdfadb10.9fa798","name":"","env":[],"x":1220,"y":300,"wires":[]},{"id":"59f91fe2.e23ec","type":"http in","z":"545098a4.d6b9c8","name":"","url":"/formfieldhelper","method":"get","upload":false,"swaggerDoc":"","x":200,"y":160,"wires":[["86100ee2.ee4b"]]},{"id":"86100ee2.ee4b","type":"subflow:57d6e8f2.02b798","z":"545098a4.d6b9c8","name":"","env":[],"x":400,"y":160,"wires":[["4c324b4f.ffa324"],["4c324b4f.ffa324"]]},{"id":"4c324b4f.ffa324","type":"subflow:ab15ef43.c5a4c","z":"545098a4.d6b9c8","name":"","env":[],"x":600,"y":160,"wires":[["1c7833d.5b30ccc"],["2d8d2a68.65b906"]]},{"id":"1c7833d.5b30ccc","type":"json-full-schema-validator","z":"545098a4.d6b9c8","name":"FormFields","property":"request.query","propertyType":"msg","func":"{\n  \"$schema\": \"http://json-schema.org/draft-04/schema#\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"formtitle\": {\n      \"type\": \"string\"\n    },\n    \"label\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\n    \"formtitle\"\n  ]\n}","x":790,"y":140,"wires":[["2869cc0.9071734"],["e72cf0b9.28f4e"]]},{"id":"ba633e97.01d9e","type":"subflow:c0f13f8b.9a1e1","z":"545098a4.d6b9c8","name":"","env":[],"x":1060,"y":160,"wires":[]},{"id":"e72cf0b9.28f4e","type":"change","z":"545098a4.d6b9c8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"error in request body","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":935,"y":160,"wires":[["ba633e97.01d9e"]],"l":false},{"id":"2869cc0.9071734","type":"change","z":"545098a4.d6b9c8","name":"Set Export Def","rules":[{"t":"set","p":"request.exportdef","pt":"msg","to":"Connect_FormHelper","tot":"str"},{"t":"set","p":"request.container","pt":"msg","to":"Search","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1000,"y":120,"wires":[["52c9156f.734e5c"]]},{"id":"52c9156f.734e5c","type":"subflow:695c8489.c3dbec","z":"545098a4.d6b9c8","name":"","env":[],"x":1190,"y":120,"wires":[["68844c72.2f56d4"]]},{"id":"68844c72.2f56d4","type":"subflow:9da11551.0b2828","z":"545098a4.d6b9c8","name":"","env":[],"x":1400,"y":120,"wires":[]},{"id":"28220c68.c1f9e4","type":"subflow:c0f13f8b.9a1e1","z":"f5d31599.48fec8","name":"","x":720,"y":260,"wires":[]},{"id":"ef219cc0.1fc86","type":"subflow:c0f13f8b.9a1e1","z":"cdfadb10.9fa798","name":"","x":700,"y":260,"wires":[]},{"id":"2d8d2a68.65b906","type":"subflow:c0f13f8b.9a1e1","z":"545098a4.d6b9c8","name":"","x":800,"y":180,"wires":[]},{"id":"200fe427.7d935c","type":"subflow:ab15ef43.c5a4c","z":"c3bf0800.98e738","name":"","env":[],"x":490,"y":220,"wires":[["65fd5243.51baac"],["3924a86a.b102a8"]]},{"id":"49e165a2.69154c","type":"http in","z":"c3bf0800.98e738","name":"GET assets","url":"/labour/:method","method":"get","upload":false,"swaggerDoc":"","x":90,"y":200,"wires":[["5e25566e.821d88"]]},{"id":"bcd56baa.bae828","type":"http in","z":"c3bf0800.98e738","name":"POST assets","url":"/labour/:method","method":"post","upload":false,"swaggerDoc":"","x":90,"y":240,"wires":[["5e25566e.821d88"]]},{"id":"37f53ed.92cf4c2","type":"switch","z":"c3bf0800.98e738","name":"","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"schema","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1095,"y":80,"wires":[["dbe959e6.f382b8"],["e44b10b7.dea33"]],"outputLabels":["schema","not supported"],"l":false},{"id":"e44b10b7.dea33","type":"change","z":"c3bf0800.98e738","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1175,"y":100,"wires":[["a0edbc90.122b2"]],"l":false},{"id":"a0edbc90.122b2","type":"subflow:c0f13f8b.9a1e1","z":"c3bf0800.98e738","name":"","env":[],"x":1300,"y":100,"wires":[]},{"id":"65fd5243.51baac","type":"change","z":"c3bf0800.98e738","name":"Set Endpoint BO","rules":[{"t":"set","p":"request.businessobject","pt":"msg","to":"DataBO.Employee.LabourBO","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":200,"wires":[["73b5e16d.d7248"]]},{"id":"73b5e16d.d7248","type":"switch","z":"c3bf0800.98e738","name":"HTTP method","property":"req.method","propertyType":"msg","rules":[{"t":"eq","v":"GET","vt":"str"},{"t":"eq","v":"POST","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":900,"y":200,"wires":[["37f53ed.92cf4c2"],["7adeb0d9.b132e"],["2c6c41ae.bd535e"]]},{"id":"7adeb0d9.b132e","type":"switch","z":"c3bf0800.98e738","name":"Path parameter","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"query","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1160,"y":200,"wires":[["b33c1aa4.ed3b78"],["2c6c41ae.bd535e"]]},{"id":"9bb2e126.17b59","type":"subflow:37184d93.e34d32","z":"c3bf0800.98e738","name":"","env":[],"x":1630,"y":140,"wires":[["4b070d4a.307e64"]]},{"id":"b33c1aa4.ed3b78","type":"subflow:1bef542e.d2fb4c","z":"c3bf0800.98e738","name":"","env":[],"x":1410,"y":140,"wires":[["9bb2e126.17b59"]]},{"id":"dbe959e6.f382b8","type":"subflow:cbd3c5cd.d78358","z":"c3bf0800.98e738","name":"","env":[],"x":1250,"y":60,"wires":[["b19fee68.f5a63"]]},{"id":"5e25566e.821d88","type":"subflow:57d6e8f2.02b798","z":"c3bf0800.98e738","name":"","env":[],"x":290,"y":220,"wires":[["200fe427.7d935c"],["200fe427.7d935c"]]},{"id":"b19fee68.f5a63","type":"subflow:9da11551.0b2828","z":"c3bf0800.98e738","name":"","env":[],"x":1480,"y":60,"wires":[]},{"id":"4b070d4a.307e64","type":"subflow:9da11551.0b2828","z":"c3bf0800.98e738","name":"","x":1840,"y":140,"wires":[]},{"id":"2c6c41ae.bd535e","type":"change","z":"c3bf0800.98e738","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1095,"y":280,"wires":[["21bdfc8e.8b49a4"]],"l":false},{"id":"21bdfc8e.8b49a4","type":"subflow:c0f13f8b.9a1e1","z":"c3bf0800.98e738","name":"","env":[],"x":1220,"y":280,"wires":[]},{"id":"3924a86a.b102a8","type":"subflow:c0f13f8b.9a1e1","z":"c3bf0800.98e738","name":"","x":700,"y":240,"wires":[]},{"id":"fe626614.ac0678","type":"switch","z":"9da11551.0b2828","name":"","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":850,"y":60,"wires":[["ccad8a32.4d87a8"],["ef0475c2.d11ad8"]]},{"id":"ccad8a32.4d87a8","type":"change","z":"9da11551.0b2828","name":"Set Empty Payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"[ ]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1030,"y":40,"wires":[["f67c1078.538de"]]},{"id":"b872d7b1.9e43c8","type":"debug","z":"a71e4e87.fb79f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1130,"y":40,"wires":[]},{"id":"f3b04e40.c6b84","type":"http in","z":"5a0ae199.3bfe8","name":"","url":"/readings/:method","method":"post","upload":false,"swaggerDoc":"","x":170,"y":320,"wires":[["7cea31f4.44f92"]]},{"id":"b9898fc0.85517","type":"http in","z":"5a0ae199.3bfe8","name":"","url":"/readings/:method","method":"get","upload":false,"swaggerDoc":"","x":180,"y":280,"wires":[["7cea31f4.44f92"]]},{"id":"79c85dd4.0a5304","type":"http in","z":"5a0ae199.3bfe8","name":"","url":"/devices/:method","method":"get","upload":false,"swaggerDoc":"","x":180,"y":360,"wires":[["7cea31f4.44f92"]]},{"id":"7cea31f4.44f92","type":"subflow:57d6e8f2.02b798","z":"5a0ae199.3bfe8","name":"","env":[],"x":410,"y":300,"wires":[["2c74398c.e74c26"],["2c74398c.e74c26"]]},{"id":"2c74398c.e74c26","type":"subflow:ab15ef43.c5a4c","z":"5a0ae199.3bfe8","name":"","env":[],"x":610,"y":300,"wires":[["6d00e456.27396c"],["a174e167.91605"]]},{"id":"a174e167.91605","type":"subflow:c0f13f8b.9a1e1","z":"5a0ae199.3bfe8","name":"","x":820,"y":340,"wires":[]},{"id":"6d00e456.27396c","type":"function","z":"5a0ae199.3bfe8","name":"Set Business Object","func":"msg.request.endpointUrl =  msg.req.originalUrl.split('/')\nmsg.request.endpoint = msg.request.endpointUrl[1]\ndelete msg.request.endpointUrl\nswitch(msg.request.endpoint){\n    case \"readingpoints\":\n        msg.request.businessobject = \"DataBO.ProcessMngt.ReadingPointBO\"\n    break;\n    case \"readings\":\n        msg.request.businessobject = \"DataBO.ProcessMngt.ReadingPointBO\"\n    break;\n    case \"devices\":\n        msg.request.businessobject = \"DataBO.ProcessMngt.IotDefBO\"\n    break;\n    default:\n    msg.request.businessobject = \"DataBO.ProcessMngt.ReadingPointBO\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":280,"wires":[["98cd5ff4.896d5"]]},{"id":"2d37d7d1.a04e68","type":"http in","z":"5a0ae199.3bfe8","name":"","url":"/devices/:method","method":"put","upload":false,"swaggerDoc":"","x":180,"y":400,"wires":[["7cea31f4.44f92"]]},{"id":"45de33a0.db62fc","type":"subflow:cbd3c5cd.d78358","z":"5a0ae199.3bfe8","name":"","env":[],"x":1510,"y":80,"wires":[["b090d5c0.2e2d08"]]},{"id":"bd331a97.b22398","type":"subflow:c0f13f8b.9a1e1","z":"5a0ae199.3bfe8","name":"","env":[],"x":1560,"y":260,"wires":[]},{"id":"d24ca655.7199c8","type":"change","z":"5a0ae199.3bfe8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1435,"y":260,"wires":[["bd331a97.b22398"]],"l":false},{"id":"b090d5c0.2e2d08","type":"subflow:9da11551.0b2828","z":"5a0ae199.3bfe8","name":"","env":[],"x":1740,"y":80,"wires":[]},{"id":"98cd5ff4.896d5","type":"switch","z":"5a0ae199.3bfe8","name":"HTTP method","property":"req.method","propertyType":"msg","rules":[{"t":"eq","v":"GET","vt":"str"},{"t":"eq","v":"POST","vt":"str"},{"t":"eq","v":"PUT","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":1080,"y":280,"wires":[["563275e7.b578cc"],["91e84ddf.bb122"],[],["2f62df48.e9c41"]]},{"id":"563275e7.b578cc","type":"switch","z":"5a0ae199.3bfe8","name":"","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"schema","vt":"str"},{"t":"eq","v":"list","vt":"str"},{"t":"eq","v":"current","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":1270,"y":220,"wires":[["45de33a0.db62fc"],["d2f3a074.7bbf6"],["974af6e8.df4ee8"],["d24ca655.7199c8"]]},{"id":"21d16aa4.611466","type":"function","z":"f5d31599.48fec8","name":"Create Query","func":"if(msg.request.query.select !== undefined){\n    msg.request.body = {\n        \"select\":msg.request.query.select.split(','),\n        \"filter\":[{\n            \"column\":\"woJob.CompletionDate\",\n            \"value\": null,\n            \"condition\":\"is\"\n        }]\n    }\n    delete msg.request.query\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":100,"wires":[["86f54022.36605"]]},{"id":"97e42409.03aac8","type":"http in","z":"5a0ae199.3bfe8","name":"","url":"/readingspoints/:method","method":"post","upload":false,"swaggerDoc":"","x":150,"y":240,"wires":[["7cea31f4.44f92"]]},{"id":"a78751b.5d493b","type":"subflow:1bef542e.d2fb4c","z":"5a0ae199.3bfe8","name":"","env":[],"x":1530,"y":300,"wires":[["282cabd8.535f64"]]},{"id":"282cabd8.535f64","type":"subflow:37184d93.e34d32","z":"5a0ae199.3bfe8","name":"","x":1750,"y":300,"wires":[["43f7cf45.20e2b"]]},{"id":"43f7cf45.20e2b","type":"subflow:9da11551.0b2828","z":"5a0ae199.3bfe8","name":"","x":1960,"y":300,"wires":[]},{"id":"91e84ddf.bb122","type":"switch","z":"5a0ae199.3bfe8","name":"","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"query","vt":"str"},{"t":"eq","v":"add","vt":"str"},{"t":"eq","v":"addfromdevice","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":1270,"y":300,"wires":[["a78751b.5d493b"],["8d6c8ff7.1182e"],["3addabfc.eed824"],["2f62df48.e9c41"]]},{"id":"8d6c8ff7.1182e","type":"json-full-schema-validator","z":"5a0ae199.3bfe8","name":"Add","property":"request.body","propertyType":"msg","func":"{\n    \"$schema\": \"http://json-schema.org/draft-04/schema\",\n    \"type\": \"object\",\n    \"required\": [\n        \"ReadingPointID\",\n        \"Value\"\n    ],\n    \"properties\": {\n        \"ReadingPointID\": {\n            \"type\": \"integer\"\n        },\n        \"Value\": {\n            \"type\": \"number\"\n        }\n    },\n    \"additionalProperties\": false\n}","x":1470,"y":380,"wires":[["4613c120.d4c36"],["2ba7fab7.b94426"]]},{"id":"fdb93b01.bde398","type":"subflow:c0f13f8b.9a1e1","z":"5a0ae199.3bfe8","name":"","env":[],"x":1700,"y":400,"wires":[]},{"id":"2ba7fab7.b94426","type":"change","z":"5a0ae199.3bfe8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"error in request body","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1575,"y":400,"wires":[["fdb93b01.bde398"]],"l":false},{"id":"4613c120.d4c36","type":"change","z":"5a0ae199.3bfe8","name":"Set Export Def","rules":[{"t":"set","p":"request.exportdef","pt":"msg","to":"Connect_AddReading","tot":"str"},{"t":"set","p":"request.container","pt":"msg","to":"data","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1640,"y":360,"wires":[["bdcf7fa1.39167"]]},{"id":"bdcf7fa1.39167","type":"subflow:695c8489.c3dbec","z":"5a0ae199.3bfe8","name":"","env":[],"x":1850,"y":360,"wires":[["295ce5a5.d6f0da"]]},{"id":"295ce5a5.d6f0da","type":"subflow:9da11551.0b2828","z":"5a0ae199.3bfe8","name":"","env":[],"x":2080,"y":360,"wires":[]},{"id":"3addabfc.eed824","type":"json-full-schema-validator","z":"5a0ae199.3bfe8","name":"AddFromDevice","property":"request.body","propertyType":"msg","func":"{\n  \"$schema\": \"http://json-schema.org/draft-04/schema#\",\n  \"type\": \"array\",\n  \"items\": [\n    {\n      \"type\": \"object\",\n      \"properties\": {\n        \"DeviceID\": {\n          \"type\": \"string\"\n        },\n        \"Data\": {\n          \"type\": \"array\",\n          \"items\": [\n            {\n              \"type\": \"object\",\n              \"properties\": {\n                \"Property\": {\n                  \"type\": \"string\"\n                },\n                \"Value\": {\n                  \"type\": \"number\"\n                }\n              },\n              \"required\": [\n                \"Property\",\n                \"Value\"\n              ]\n            }\n          ]\n        }\n      },\n      \"required\": [\n        \"DeviceID\",\n        \"Data\"\n      ]\n    }\n  ]\n}","x":1500,"y":500,"wires":[["606db270.6891cc"],["fc743cda.ab95e"]]},{"id":"abfdda89.33b078","type":"subflow:c0f13f8b.9a1e1","z":"5a0ae199.3bfe8","name":"","env":[],"x":1740,"y":520,"wires":[]},{"id":"fc743cda.ab95e","type":"change","z":"5a0ae199.3bfe8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"error in request body","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1615,"y":520,"wires":[["abfdda89.33b078"]],"l":false},{"id":"606db270.6891cc","type":"change","z":"5a0ae199.3bfe8","name":"Set Export Def","rules":[{"t":"set","p":"request.exportdef","pt":"msg","to":"Connect_AddReadingFromDevice","tot":"str"},{"t":"set","p":"request.container","pt":"msg","to":"data","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1680,"y":480,"wires":[["c6e9014d.97d0c"]]},{"id":"b02d2458.b99cc8","type":"subflow:695c8489.c3dbec","z":"5a0ae199.3bfe8","name":"","env":[],"x":2270,"y":480,"wires":[["b8f200a9.85ed3"]]},{"id":"6d5bcf7a.c906b","type":"subflow:9da11551.0b2828","z":"5a0ae199.3bfe8","name":"","env":[],"x":2780,"y":480,"wires":[]},{"id":"2f62df48.e9c41","type":"change","z":"5a0ae199.3bfe8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1435,"y":580,"wires":[["e4256a84.b0dce8"]],"l":false},{"id":"e4256a84.b0dce8","type":"subflow:c0f13f8b.9a1e1","z":"5a0ae199.3bfe8","name":"","env":[],"x":1560,"y":580,"wires":[]},{"id":"8166050d.98ab58","type":"split","z":"5a0ae199.3bfe8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":1855,"y":480,"wires":[["fe1e6622.f7d378"]],"l":false},{"id":"c6e9014d.97d0c","type":"function","z":"5a0ae199.3bfe8","name":"","func":"msg.payload = msg.request.body\nreturn msg;","outputs":1,"noerr":0,"x":1795,"y":480,"wires":[["8166050d.98ab58"]],"l":false},{"id":"fe1e6622.f7d378","type":"change","z":"5a0ae199.3bfe8","name":"","rules":[{"t":"set","p":"request.DeviceID","pt":"msg","to":"payload.DeviceID","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payload.Data","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1915,"y":480,"wires":[["e1280e25.277cd"]],"l":false},{"id":"e1280e25.277cd","type":"split","z":"5a0ae199.3bfe8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1975,"y":480,"wires":[["5d14823.ad8ae7c"]],"l":false},{"id":"5d14823.ad8ae7c","type":"change","z":"5a0ae199.3bfe8","name":"Set DeviceID","rules":[{"t":"set","p":"payload.DeviceID","pt":"msg","to":"request.DeviceID","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2090,"y":480,"wires":[["b02d2458.b99cc8"]]},{"id":"fe2e67c.bee0598","type":"switch","z":"695c8489.c3dbec","name":"","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"nempty"}],"checkall":"true","repair":false,"outputs":2,"x":115,"y":140,"wires":[["2e41d810.4ac7f8"],["e8141a8a.77bbb8"]],"l":false},{"id":"e8141a8a.77bbb8","type":"change","z":"695c8489.c3dbec","name":"Move payload","rules":[{"t":"set","p":"request.payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":175,"y":160,"wires":[["2e41d810.4ac7f8"]],"l":false},{"id":"b8f200a9.85ed3","type":"join","z":"5a0ae199.3bfe8","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":2395,"y":480,"wires":[["2fd4d459.05eeec"]],"l":false},{"id":"34be5584.369b1a","type":"join","z":"5a0ae199.3bfe8","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":2635,"y":480,"wires":[["6d5bcf7a.c906b"]],"l":false},{"id":"2fd4d459.05eeec","type":"function","z":"5a0ae199.3bfe8","name":"Build response","func":"//msg.payload = JSON.parse(msg.payload.messages)\nvar deviceid = msg.request.DeviceID\nvar response = {}\nresponse[deviceid] = []\n\nfor(i = 0; i < msg.payload.length; i++){\n        msg.payload[i] = JSON.parse(msg.payload[i])\n        response[deviceid].push(msg.payload[i])\n    }\nmsg.payload = {}\nmsg.payload = response\nreturn msg;","outputs":1,"noerr":0,"x":2520,"y":480,"wires":[["34be5584.369b1a"]]},{"id":"a775c5ab.7aaec8","type":"subflow:695c8489.c3dbec","z":"5a0ae199.3bfe8","name":"","env":[],"x":1710,"y":160,"wires":[["5be1f440.aa1f1c"]]},{"id":"5be1f440.aa1f1c","type":"subflow:9da11551.0b2828","z":"5a0ae199.3bfe8","name":"","env":[],"x":1920,"y":160,"wires":[]},{"id":"d518155e.02d078","type":"http in","z":"5a0ae199.3bfe8","name":"","url":"/readingspoints/:method","method":"get","upload":false,"swaggerDoc":"","x":160,"y":200,"wires":[["7cea31f4.44f92"]]},{"id":"d2f3a074.7bbf6","type":"function","z":"5a0ae199.3bfe8","name":"Set ExportDef","func":"if(msg.request.query.assetcode !== undefined){\n    msg.request.exportdef = \"Connect_ReadingPointsAsset\"\n}\nelse msg.request.exportdef = \"Connect_ReadingPoints\"\nmsg.request.container = \"Data\"\nreturn msg;","outputs":1,"noerr":0,"x":1500,"y":120,"wires":[["a775c5ab.7aaec8"]]},{"id":"974af6e8.df4ee8","type":"function","z":"5a0ae199.3bfe8","name":"Set ExportDef","func":"msg.request.filter = \"\"\n\nif(msg.request.query.assetcode !== undefined){\n   msg.request.filter = \"assetcode = '\" + msg.request.query.assetcode + \"'\"\n}\nif(msg.request.query.deviceid !== undefined){\n    if(msg.request.filter !== \"\"){\n        msg.request.filter = msg.request.filter + \" and DeviceID = '\" + msg.request.query.deviceid + \"'\"\n    }\n    else {\n        msg.request.filter = \"DeviceID = '\" + msg.request.query.deviceid + \"'\"\n    }\n}\nif(msg.request.query.propertycode !== undefined){\n    if(msg.request.filter !== \"\"){\n        msg.request.filter = msg.request.filter + \" and DeviceProperty = '\" + msg.request.query.propertycode + \"'\"\n    }\n    else {\n        msg.request.filter = \"DeviceProperty = '\" + msg.request.query.deviceid + \"'\"\n    }\n}\nif(msg.request.filter !== \"\"){\n    msg.payload.filter = \" where \" + msg.request.filter\n}\nelse {\n    msg.payload.filter = \"\"\n}\n\nmsg.request.exportdef = \"Connect_GetCurrReadings\"\nmsg.request.container = \"Data\"\nreturn msg;","outputs":1,"noerr":0,"x":1500,"y":200,"wires":[["a775c5ab.7aaec8"]]},{"id":"de3f9d54.5744","type":"http in","z":"2f0041b8.31d9de","name":"GET requests","url":"/requests/:method","method":"get","upload":false,"swaggerDoc":"","x":110,"y":240,"wires":[["3e77922f.155c3e"]]},{"id":"7e9295f7.9247bc","type":"http in","z":"2f0041b8.31d9de","name":"POST requests","url":"/requests/:method","method":"post","upload":false,"swaggerDoc":"","x":100,"y":280,"wires":[["3e77922f.155c3e"]]},{"id":"b009dc21.98ffb","type":"subflow:ab15ef43.c5a4c","z":"2f0041b8.31d9de","name":"","env":[],"x":510,"y":260,"wires":[["991fa162.ef09e"],["bd427696.9d1b98"]]},{"id":"5d871126.daf81","type":"switch","z":"2f0041b8.31d9de","name":"","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"schema","vt":"str"},{"t":"eq","v":"open","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1015,"y":120,"wires":[["381867e2.a19308"],["7fbbc2cb.c6e21c"],["50a8977a.fbb0b8"]],"outputLabels":["schema","","not supported"],"l":false},{"id":"50a8977a.fbb0b8","type":"change","z":"2f0041b8.31d9de","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1115,"y":180,"wires":[["78f336ec.407928"]],"l":false},{"id":"78f336ec.407928","type":"subflow:c0f13f8b.9a1e1","z":"2f0041b8.31d9de","name":"","env":[],"x":1155,"y":180,"wires":[],"l":false},{"id":"991fa162.ef09e","type":"change","z":"2f0041b8.31d9de","name":"Set Endpoint BO","rules":[{"t":"set","p":"request.businessobject","pt":"msg","to":"DataBO.ProcessMngt.JobBO","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":730,"y":240,"wires":[["1b8e7c1.a648484"]]},{"id":"1b8e7c1.a648484","type":"switch","z":"2f0041b8.31d9de","name":"HTTP method","property":"req.method","propertyType":"msg","rules":[{"t":"eq","v":"GET","vt":"str"},{"t":"eq","v":"POST","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":920,"y":240,"wires":[["5d871126.daf81"],["89be3e22.a8ab6"],["d7cf5583.91e288"]]},{"id":"89be3e22.a8ab6","type":"switch","z":"2f0041b8.31d9de","name":"Path parameter","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"query","vt":"str"},{"t":"eq","v":"add","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1180,"y":240,"wires":[["84177fe1.eeeb5"],["8be4451b.8b8388"],["d7cf5583.91e288"]]},{"id":"d9b2dea3.8ed3e","type":"subflow:37184d93.e34d32","z":"2f0041b8.31d9de","name":"","env":[],"x":1830,"y":120,"wires":[["8a856b56.3e5818"]]},{"id":"11460883.843a57","type":"subflow:1bef542e.d2fb4c","z":"2f0041b8.31d9de","name":"","env":[],"x":1610,"y":120,"wires":[["d9b2dea3.8ed3e"]]},{"id":"381867e2.a19308","type":"subflow:cbd3c5cd.d78358","z":"2f0041b8.31d9de","name":"","env":[],"x":1170,"y":60,"wires":[["89793070.5f228"]]},{"id":"3e77922f.155c3e","type":"subflow:57d6e8f2.02b798","z":"2f0041b8.31d9de","name":"","env":[],"x":310,"y":260,"wires":[["b009dc21.98ffb"],["b009dc21.98ffb"]]},{"id":"8be4451b.8b8388","type":"json-full-schema-validator","z":"2f0041b8.31d9de","name":"Add","property":"request.body","propertyType":"msg","func":"{\n  \"$schema\": \"http://json-schema.org/draft-04/schema#\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"AssetCode\": {\n      \"type\": \"string\"\n    },\n    \"Description\": {\n      \"type\": \"string\"\n    },\n    \"ContactName\": {\n      \"type\": \"string\"\n    },\n    \"ContactPhone\": {\n      \"type\": \"string\"\n    },\n    \"ContactEmail\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\n    \"AssetCode\",\n    \"Description\",\n    \"ContactName\",\n    \"ContactPhone\",\n    \"ContactEmail\"\n  ]\n}","x":1390,"y":240,"wires":[["17950733.cf7469"],["4aff2c0a.ba4d44"]]},{"id":"c419e8e3.50b088","type":"subflow:c0f13f8b.9a1e1","z":"2f0041b8.31d9de","name":"","env":[],"x":1620,"y":260,"wires":[]},{"id":"4aff2c0a.ba4d44","type":"change","z":"2f0041b8.31d9de","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"error in request body","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1495,"y":260,"wires":[["c419e8e3.50b088"]],"l":false},{"id":"17950733.cf7469","type":"change","z":"2f0041b8.31d9de","name":"Set Export Def","rules":[{"t":"set","p":"request.exportdef","pt":"msg","to":"Connect_AddRequest","tot":"str"},{"t":"set","p":"request.container","pt":"msg","to":"Actions","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1560,"y":220,"wires":[["a91825e9.3b2898"]]},{"id":"a91825e9.3b2898","type":"subflow:695c8489.c3dbec","z":"2f0041b8.31d9de","name":"","env":[],"x":1770,"y":220,"wires":[["9cfeed3e.6870c"]]},{"id":"89793070.5f228","type":"subflow:9da11551.0b2828","z":"2f0041b8.31d9de","name":"","env":[],"x":1380,"y":60,"wires":[]},{"id":"8a856b56.3e5818","type":"subflow:9da11551.0b2828","z":"2f0041b8.31d9de","name":"","x":2040,"y":120,"wires":[]},{"id":"9cfeed3e.6870c","type":"subflow:9da11551.0b2828","z":"2f0041b8.31d9de","name":"","x":2000,"y":220,"wires":[]},{"id":"d7cf5583.91e288","type":"change","z":"2f0041b8.31d9de","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1115,"y":320,"wires":[["4659c9f.a39d738"]],"l":false},{"id":"4659c9f.a39d738","type":"subflow:c0f13f8b.9a1e1","z":"2f0041b8.31d9de","name":"","env":[],"x":1240,"y":320,"wires":[]},{"id":"bd427696.9d1b98","type":"subflow:c0f13f8b.9a1e1","z":"2f0041b8.31d9de","name":"","x":720,"y":280,"wires":[]},{"id":"7fbbc2cb.c6e21c","type":"function","z":"2f0041b8.31d9de","name":"Create Query","func":"if(msg.request.query.select !== undefined){\n    msg.request.body = {\n        \"select\":msg.request.query.select.split(','),\n        \"filter\":[{\n            \"column\":\"woJob.CompletionDate\",\n            \"value\": null,\n            \"condition\":\"is\"\n        },\n        {\n            \"column\":\"woJob.wasHelpdesk\",\n            \"value\": true,\n            \"condition\": \"eq\"\n        }]\n    }\n    delete msg.request.query\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":120,"wires":[["11460883.843a57"]]},{"id":"84177fe1.eeeb5","type":"function","z":"2f0041b8.31d9de","name":"Add Request filter","func":"if(msg.request.body.filter !== undefined){\n    msg.request.body.filter.push(\n                {\n            \"column\":\"woJob.wasHelpdesk\",\n            \"value\": true,\n            \"condition\": \"eq\"\n        })\n}\nelse {\n    msg.request.body.filter = []\n    msg.request.body.filter.push(\n            {\n        \"column\":\"woJob.wasHelpdesk\",\n        \"value\": true,\n        \"condition\": \"eq\"\n    })\n}\nreturn msg;","outputs":1,"noerr":0,"x":1370,"y":160,"wires":[["11460883.843a57"]]},{"id":"ae361d86.147a8","type":"http in","z":"7a10f34e.9ce88c","name":"GET JobTypes","url":"/JobTypes/:method","method":"get","upload":false,"swaggerDoc":"","x":100,"y":260,"wires":[["2329ee1c.eaa712"]]},{"id":"866df3b8.74983","type":"http in","z":"7a10f34e.9ce88c","name":"POST jobtypes","url":"/jobtypes/:method","method":"post","upload":false,"swaggerDoc":"","x":100,"y":300,"wires":[["2329ee1c.eaa712"]]},{"id":"6678d09c.dfdc7","type":"subflow:ab15ef43.c5a4c","z":"7a10f34e.9ce88c","name":"","env":[],"x":610,"y":280,"wires":[["37957329.acac0c"],["78f41b91.d5b254"]]},{"id":"937afe97.1bde1","type":"switch","z":"7a10f34e.9ce88c","name":"HTTP method","property":"req.method","propertyType":"msg","rules":[{"t":"eq","v":"GET","vt":"str"},{"t":"eq","v":"POST","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1040,"y":260,"wires":[["db0ce2eb.69daa"],["1c21aeba.983351"],["ce981686.2dc768"]]},{"id":"2329ee1c.eaa712","type":"subflow:57d6e8f2.02b798","z":"7a10f34e.9ce88c","name":"","env":[],"x":410,"y":280,"wires":[["6678d09c.dfdc7"],["6678d09c.dfdc7"]]},{"id":"78f41b91.d5b254","type":"subflow:c0f13f8b.9a1e1","z":"7a10f34e.9ce88c","name":"","x":820,"y":300,"wires":[]},{"id":"db0ce2eb.69daa","type":"switch","z":"7a10f34e.9ce88c","name":"","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"schema","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1195,"y":140,"wires":[["3271aa7c.bac876"],["7900717a.b28f9"]],"outputLabels":["schema","not supported"],"l":false},{"id":"7900717a.b28f9","type":"change","z":"7a10f34e.9ce88c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1255,"y":160,"wires":[["39fbd538.b4339a"]],"l":false},{"id":"39fbd538.b4339a","type":"subflow:c0f13f8b.9a1e1","z":"7a10f34e.9ce88c","name":"","env":[],"x":1380,"y":160,"wires":[]},{"id":"1c21aeba.983351","type":"switch","z":"7a10f34e.9ce88c","name":"Path parameter","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"query","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1260,"y":260,"wires":[["63978827.e9b488"],["ce981686.2dc768"]]},{"id":"6c10b894.299328","type":"subflow:37184d93.e34d32","z":"7a10f34e.9ce88c","name":"","env":[],"x":1770,"y":200,"wires":[["c1d1937c.6e04"]]},{"id":"63978827.e9b488","type":"subflow:1bef542e.d2fb4c","z":"7a10f34e.9ce88c","name":"","env":[],"x":1530,"y":200,"wires":[["6c10b894.299328"]]},{"id":"3271aa7c.bac876","type":"subflow:cbd3c5cd.d78358","z":"7a10f34e.9ce88c","name":"","env":[],"x":1330,"y":120,"wires":[["4db7ec39.561544"]]},{"id":"4db7ec39.561544","type":"subflow:9da11551.0b2828","z":"7a10f34e.9ce88c","name":"","env":[],"x":1560,"y":120,"wires":[]},{"id":"c1d1937c.6e04","type":"subflow:9da11551.0b2828","z":"7a10f34e.9ce88c","name":"","x":2000,"y":200,"wires":[]},{"id":"ce981686.2dc768","type":"change","z":"7a10f34e.9ce88c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1395,"y":320,"wires":[["4f5e1f.0d6981e"]],"l":false},{"id":"4f5e1f.0d6981e","type":"subflow:c0f13f8b.9a1e1","z":"7a10f34e.9ce88c","name":"","env":[],"x":1520,"y":320,"wires":[]},{"id":"37957329.acac0c","type":"function","z":"7a10f34e.9ce88c","name":"Set Business Object","func":"msg.request.endpointUrl =  msg.req.originalUrl.split('/')\nmsg.request.endpoint = msg.request.endpointUrl[1].toLowerCase()\ndelete msg.request.endpointUrl\nswitch(msg.request.endpoint){\n    case \"jobtypes\":\n        msg.request.businessobject = \"DataBO.SystemData.JobTypeBO\"\n    break;\n    case \"priorities\":\n        msg.request.businessobject = \"DataBO.SystemData.PriorityBO\"\n    break;\n    case \"crafts\":\n        msg.request.businessobject = \"DataBO.Employee.CraftBO\"\n    break;\n    case \"faulcodes\":\n        msg.request.businessobject = \"DataBO.SystemData.FaultBO\"\n    break;\n    default:\n    msg.request.businessobject = \"DataBO.SystemData.JobStatusBO\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":260,"wires":[["937afe97.1bde1"]]},{"id":"69affe87.eb0a5","type":"http in","z":"7a10f34e.9ce88c","name":"GET Priorities","url":"/Priorities/:method","method":"get","upload":false,"swaggerDoc":"","x":90,"y":340,"wires":[["2329ee1c.eaa712"]]},{"id":"e232c129.40d73","type":"http in","z":"7a10f34e.9ce88c","name":"POST Priorities","url":"/Priorities/:method","method":"post","upload":false,"swaggerDoc":"","x":100,"y":380,"wires":[["2329ee1c.eaa712"]]},{"id":"5626adbc.218914","type":"http in","z":"7a10f34e.9ce88c","name":"GET WorkOrderStatus","url":"/WorkOrderStatus/:method","method":"get","upload":false,"swaggerDoc":"","x":120,"y":180,"wires":[["2329ee1c.eaa712"]]},{"id":"1f3d9357.340e1d","type":"http in","z":"7a10f34e.9ce88c","name":"POST workorderstatus","url":"/workorderstatus/:method","method":"post","upload":false,"swaggerDoc":"","x":120,"y":220,"wires":[["2329ee1c.eaa712"]]},{"id":"447f4972.c5fa68","type":"http in","z":"7a10f34e.9ce88c","name":"GET Crafts","url":"/Crafts/:method","method":"get","upload":false,"swaggerDoc":"","x":80,"y":420,"wires":[["2329ee1c.eaa712"]]},{"id":"e33ba5f2.c385c8","type":"http in","z":"7a10f34e.9ce88c","name":"POST Crafts","url":"/Crafts/:method","method":"post","upload":false,"swaggerDoc":"","x":90,"y":460,"wires":[["2329ee1c.eaa712"]]},{"id":"c808880.2e0a378","type":"http in","z":"7a10f34e.9ce88c","name":"GET FaultCodes","url":"/FaultCodes/:method","method":"get","upload":false,"swaggerDoc":"","x":100,"y":100,"wires":[["2329ee1c.eaa712"]]},{"id":"efbf8431.952ef8","type":"http in","z":"7a10f34e.9ce88c","name":"POST FaultCodes","url":"/FaultCodes/:method","method":"post","upload":false,"swaggerDoc":"","x":110,"y":140,"wires":[["2329ee1c.eaa712"]]},{"id":"cd06bf35.f870a","type":"http in","z":"37b50526.597f5a","name":"GET stores","url":"/stores/:method","method":"get","upload":false,"swaggerDoc":"","x":120,"y":240,"wires":[["92444474.b65b88"]]},{"id":"a69297f3.53a5e8","type":"http in","z":"37b50526.597f5a","name":"POST stores","url":"/stores/:method","method":"post","upload":false,"swaggerDoc":"","x":120,"y":280,"wires":[["92444474.b65b88"]]},{"id":"ee0fe10b.49e87","type":"subflow:ab15ef43.c5a4c","z":"37b50526.597f5a","name":"","env":[],"x":570,"y":400,"wires":[["3146467c.737c9a"],["afbb35cc.543438"]]},{"id":"b51dadfb.4ce13","type":"switch","z":"37b50526.597f5a","name":"","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"schema","vt":"str"},{"t":"eq","v":"stockcounts","vt":"str"},{"t":"eq","v":"getbyorderno","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":1215,"y":180,"wires":[["204e97e0.1cedc8"],["4237f8e2.ec98e8"],["8903500a.a576e"],["a9842a4.09af9d8"]],"outputLabels":["schema","","","not supported"],"l":false},{"id":"a9842a4.09af9d8","type":"change","z":"37b50526.597f5a","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1275,"y":220,"wires":[["94a40256.aec19"]],"l":false},{"id":"94a40256.aec19","type":"subflow:c0f13f8b.9a1e1","z":"37b50526.597f5a","name":"","env":[],"x":1400,"y":220,"wires":[]},{"id":"98ce9a07.77a308","type":"switch","z":"37b50526.597f5a","name":"HTTP method","property":"req.method","propertyType":"msg","rules":[{"t":"eq","v":"GET","vt":"str"},{"t":"eq","v":"POST","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1060,"y":340,"wires":[["b51dadfb.4ce13"],["f2d790cc.04812"],["1e80f4d7.16907b"]]},{"id":"f2d790cc.04812","type":"switch","z":"37b50526.597f5a","name":"Path parameter","property":"request.apimethod","propertyType":"msg","rules":[{"t":"eq","v":"query","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1280,"y":340,"wires":[["882ec87a.871a08"],["1e80f4d7.16907b"]]},{"id":"47fea65c.873498","type":"subflow:37184d93.e34d32","z":"37b50526.597f5a","name":"","env":[],"x":1710,"y":300,"wires":[["7f7537d0.3d27f8"]]},{"id":"882ec87a.871a08","type":"subflow:1bef542e.d2fb4c","z":"37b50526.597f5a","name":"","env":[],"x":1490,"y":300,"wires":[["47fea65c.873498"]]},{"id":"204e97e0.1cedc8","type":"subflow:cbd3c5cd.d78358","z":"37b50526.597f5a","name":"","env":[],"x":1350,"y":100,"wires":[["aef7172.c1087e8"]]},{"id":"92444474.b65b88","type":"subflow:57d6e8f2.02b798","z":"37b50526.597f5a","name":"","env":[],"x":370,"y":400,"wires":[["ee0fe10b.49e87"],["ee0fe10b.49e87"]]},{"id":"aef7172.c1087e8","type":"subflow:9da11551.0b2828","z":"37b50526.597f5a","name":"","env":[],"x":1760,"y":100,"wires":[]},{"id":"7f7537d0.3d27f8","type":"subflow:9da11551.0b2828","z":"37b50526.597f5a","name":"","env":[],"x":1920,"y":300,"wires":[]},{"id":"1e80f4d7.16907b","type":"change","z":"37b50526.597f5a","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"method not supported","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1395,"y":400,"wires":[["573a126e.4888fc"]],"l":false},{"id":"573a126e.4888fc","type":"subflow:c0f13f8b.9a1e1","z":"37b50526.597f5a","name":"","env":[],"x":1520,"y":400,"wires":[]},{"id":"afbb35cc.543438","type":"subflow:c0f13f8b.9a1e1","z":"37b50526.597f5a","name":"","env":[],"x":780,"y":460,"wires":[]},{"id":"3146467c.737c9a","type":"function","z":"37b50526.597f5a","name":"set business object","func":"msg.request.endpointUrl =  msg.req.originalUrl.split('/')\n\nmsg.request.endpoint = msg.request.endpointUrl[1]\n\ndelete msg.request.endpointUrl\n\nswitch(msg.request.endpoint){\n    case \"inventory\":\n        msg.request.businessobject = \"DataBO.Inventory.ItemBO\"\n    break;\n    case \"stores\":\n        msg.request.businessobject = \"DataBO.Inventory.StoreBO\"\n    break;\n    case \"stockcounts\":\n        msg.request.businessobject = \"DataBO.Inventory.MoveBO\"\n    break;\n    case \"purchaseorders\":\n        msg.request.businessobject = \"DataBO.Inventory.PurchaseOrderBO\"\n    break;\n    case \"suppliers\":\n        msg.request.businessobject = \"DataBO.Inventory.SupplierBO\"\n    break;\n    default:\n    msg.request.businessobject = \"DataBO.Inventory.StoreBO\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":790,"y":340,"wires":[["98ce9a07.77a308"]]},{"id":"50478b7d.5aa1d4","type":"http in","z":"37b50526.597f5a","name":"GET inventory","url":"/inventory/:method","method":"get","upload":false,"swaggerDoc":"","x":120,"y":320,"wires":[["92444474.b65b88"]]},{"id":"f6f17cbb.20ace","type":"http in","z":"37b50526.597f5a","name":"POST inventory","url":"/inventory/:method","method":"post","upload":false,"swaggerDoc":"","x":110,"y":360,"wires":[["92444474.b65b88"]]},{"id":"6d59f7d8.96d7d8","type":"subflow:695c8489.c3dbec","z":"37b50526.597f5a","name":"","env":[],"x":1590,"y":160,"wires":[["aef7172.c1087e8"]]},{"id":"4237f8e2.ec98e8","type":"change","z":"37b50526.597f5a","name":"Set Export Def","rules":[{"t":"set","p":"request.exportdef","pt":"msg","to":"Connect_GetStockCounts","tot":"str"},{"t":"set","p":"request.container","pt":"msg","to":"Data","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1360,"y":140,"wires":[["6d59f7d8.96d7d8"]]},{"id":"ef0475c2.d11ad8","type":"function","z":"9da11551.0b2828","name":"","func":"if (Array.isArray(msg.payload) === true) {\n   if(msg.payload[0].hasOwnProperty(\"Successful\")){\n        return [msg, null]\n    }\n    else {\n        return [null, msg]\n    }\n}\nelse {\n    if(msg.payload.hasOwnProperty(\"Successful\")){\n    return [msg, null]\n       }\n    else {\n           return [null, msg]\n       }\n}\n","outputs":2,"noerr":0,"x":850,"y":140,"wires":[["5c5c83cd.b8d86c"],["f67c1078.538de"]]},{"id":"a89e7177.da97a","type":"json-full-schema-validator","z":"f5d31599.48fec8","name":"StatusUpdate","property":"request.body","propertyType":"msg","func":"{\n  \"$schema\": \"http://json-schema.org/draft-04/schema#\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"JobCode\": {\n      \"type\": \"string\"\n    },\n    \"StatusCode\": {\n      \"type\": \"string\"\n    },\n    \"Comments\": {\n      \"type\": \"string\"\n    },\n    \"DateAndTime\": {\n      \"type\": \"string\"\n    },\n    \"SystemName\": {\n      \"type\": \"string\"\n    },\n    \"RepairStarted\": {\n      \"type\": \"string\"\n    },\n    \"RepairCompleted\": {\n      \"type\": \"string\"\n    },\n    \"Online\": {\n      \"type\": \"string\"\n    }\n  },\n  \"required\": [\n    \"JobCode\",\n    \"StatusCode\"\n  ]\n}","x":1540,"y":440,"wires":[["f2c143c1.116eb"],["3a9f176.b737ae8"]]},{"id":"11eaac6e.e243d4","type":"subflow:c0f13f8b.9a1e1","z":"f5d31599.48fec8","name":"","env":[],"x":1820,"y":460,"wires":[]},{"id":"3a9f176.b737ae8","type":"change","z":"f5d31599.48fec8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"error in request body","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1695,"y":460,"wires":[["11eaac6e.e243d4"]],"l":false},{"id":"f2c143c1.116eb","type":"change","z":"f5d31599.48fec8","name":"Set Export Def","rules":[{"t":"set","p":"request.exportdef","pt":"msg","to":"Connect_WoStatusUpdate","tot":"str"},{"t":"set","p":"request.container","pt":"msg","to":"data","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1760,"y":420,"wires":[["cac3ca77.8b3cc8"]]},{"id":"cac3ca77.8b3cc8","type":"subflow:695c8489.c3dbec","z":"f5d31599.48fec8","name":"","env":[],"x":1970,"y":420,"wires":[["313b9a13.40e386"]]},{"id":"313b9a13.40e386","type":"subflow:9da11551.0b2828","z":"f5d31599.48fec8","name":"","env":[],"x":2200,"y":420,"wires":[]},{"id":"20d0af5e.d54d1","type":"http in","z":"d3f8f6e3.ac71b8","name":"","url":"/outbound","method":"post","upload":false,"swaggerDoc":"","x":190,"y":200,"wires":[["3d9c2225.61393e"]]},{"id":"2ce42d06.bd3182","type":"function","z":"d3f8f6e3.ac71b8","name":"","func":"msg.url = msg.request.url\nmsg.method = msg.request.method\nmsg.headers = msg.request.headers\nmsg.payload = {}\nmsg.payload = msg.request.body\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":200,"wires":[["3a234b39.98dc84"]]},{"id":"3d9c2225.61393e","type":"change","z":"d3f8f6e3.ac71b8","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"request","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":200,"wires":[["2ce42d06.bd3182"]]},{"id":"3a234b39.98dc84","type":"http request","z":"d3f8f6e3.ac71b8","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":740,"y":200,"wires":[["ccc7b242.31f2f"]]},{"id":"e9a0ad2c.6c613","type":"http response","z":"d3f8f6e3.ac71b8","name":"","statusCode":"","headers":{},"x":1210,"y":200,"wires":[]},{"id":"1eea8fb2.66bfa","type":"xml","z":"d3f8f6e3.ac71b8","name":"","property":"payload","attr":"","chr":"","x":1050,"y":200,"wires":[["e9a0ad2c.6c613"]]},{"id":"ccc7b242.31f2f","type":"function","z":"d3f8f6e3.ac71b8","name":"","func":"msg.payload.responsestatuscode = msg.statusCode\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":200,"wires":[["1eea8fb2.66bfa"]]},{"id":"2432b7f3.372888","type":"http in","z":"37b50526.597f5a","name":"POST POs","url":"/purchaseorders/:method","method":"post","upload":false,"swaggerDoc":"","x":130,"y":400,"wires":[["92444474.b65b88"]]},{"id":"209ed57c.3835aa","type":"http in","z":"37b50526.597f5a","name":"GET POs","url":"/purchaseorders/:method","method":"get","upload":false,"swaggerDoc":"","x":130,"y":440,"wires":[["92444474.b65b88"]]},{"id":"8903500a.a576e","type":"change","z":"37b50526.597f5a","name":"Set Export Def","rules":[{"t":"set","p":"request.exportdef","pt":"msg","to":"Connect_GetPurchaseOrders","tot":"str"},{"t":"set","p":"request.container","pt":"msg","to":"Data","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1360,"y":180,"wires":[["6d59f7d8.96d7d8"]]},{"id":"b03b48f6.a04348","type":"debug","z":"695c8489.c3dbec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":890,"y":60,"wires":[]},{"id":"b0a3038a.9cf99","type":"debug","z":"695c8489.c3dbec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":610,"y":40,"wires":[]},{"id":"e5bfd4a0.13be18","type":"debug","z":"695c8489.c3dbec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":770,"y":360,"wires":[]},{"id":"648952f3.2ce24c","type":"http in","z":"37b50526.597f5a","name":"POST Suppliers","url":"/suppliers/:method","method":"post","upload":false,"swaggerDoc":"","x":110,"y":480,"wires":[["92444474.b65b88"]]},{"id":"d8621988.96fab8","type":"http in","z":"37b50526.597f5a","name":"GET Suppliers","url":"/suppliers/:method","method":"get","upload":false,"swaggerDoc":"","x":117,"y":520,"wires":[["92444474.b65b88"]]},{"id":"3c82621.e01969e","type":"http in","z":"dd0cd6bf.e5fa08","name":"","url":"/heartbeat","method":"get","upload":false,"swaggerDoc":"","x":140,"y":80,"wires":[["99075647.8c4018"]]},{"id":"cea2d342.c77b","type":"http response","z":"dd0cd6bf.e5fa08","name":"","statusCode":"","headers":{},"x":370,"y":80,"wires":[]},{"id":"99075647.8c4018","type":"change","z":"dd0cd6bf.e5fa08","name":"","rules":[{"t":"set","p":"statusCode","pt":"msg","to":"200","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":240,"y":140,"wires":[["cea2d342.c77b"]]}]